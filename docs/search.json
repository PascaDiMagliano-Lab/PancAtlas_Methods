[
  {
    "objectID": "st_xenium_regression.html",
    "href": "st_xenium_regression.html",
    "title": "Xenium Spatial Regression",
    "section": "",
    "text": "Here we will be calculating radial distance from tumor regions using semla (Larsson et al. 2023) R package, then fit a spline to observe the trend of Fibro2 and Fibro3 scores (and their genes) as a function of distance from the tumor regions."
  },
  {
    "objectID": "st_xenium_regression.html#radial-distance-calculation",
    "href": "st_xenium_regression.html#radial-distance-calculation",
    "title": "Xenium Spatial Regression",
    "section": "1 Radial Distance Calculation",
    "text": "1 Radial Distance Calculation\n\n\nCode\nxenium_samples &lt;- qread(\"outputs/xenium_obj_harmony_integrated.qs\")\nxenium_samples &lt;- SplitObject(xenium_samples, split.by = 'sample_id')\n\nxenium_samples &lt;- lapply(xenium_samples, function(x){\n  x &lt;- UpdateSeuratForSemla(x)\n  x &lt;- RadialDistance(\n    x,\n    column_name = \"annotation\",\n    selected_groups = c(\"Tumor\"),\n    maxDist = 100\n  )\n  x$r_dist_Tumor_sqrt &lt;- sign(x$r_dist_Tumor)*sqrt(abs(x$r_dist_Tumor))\n  \n  return(x)\n})"
  },
  {
    "objectID": "st_xenium_regression.html#fibro23-expression-radial-distance",
    "href": "st_xenium_regression.html#fibro23-expression-radial-distance",
    "title": "Xenium Spatial Regression",
    "section": "2 Fibro2/3 expression ~ Radial Distance",
    "text": "2 Fibro2/3 expression ~ Radial Distance\n\n\nCode\nfiorini_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_Tumor_sqrt &gt; 0) |&gt;\n  select(fibro2_score_scaled, fibro3_score_scaled, r_dist_Tumor_sqrt) |&gt;\n  pivot_longer(c(\"fibro2_score_scaled\", \"fibro3_score_scaled\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_Tumor_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from Tumor)\") + ylab(\"Fibroblast-specific Fibro2/3 Score\") +\n  scale_color_manual(values = fibro_sig_cols) +\n  theme_bw()"
  },
  {
    "objectID": "st_xenium_regression.html#genes-expression-radial-distance",
    "href": "st_xenium_regression.html#genes-expression-radial-distance",
    "title": "Xenium Spatial Regression",
    "section": "3 Genes Expression ~ Radial Distance",
    "text": "3 Genes Expression ~ Radial Distance\n\n\nCode\nfibro_markers &lt;- read.csv(\"../Fibro Top Markers.csv\", row.names = 1)\nfibro2tumor_vs_fibro3tumor &lt;- read.csv(\"~/marina_turbo/Visium_Project/analysis/outputs/Fibroblasts_Analysis/stroma2_tumor_v_stroma3_Tumor.csv\")\nfibro2tumor_vs_fibro3tumor %&gt;% \n  filter(padj &lt; 0.05, log2FoldChange &gt; 0.5) %&gt;%\n  pull(X) %&gt;%\n  intersect(rownames(xenium_samples)) -&gt; fibro2_markers\nfibro3tumor_vs_fibro3gol &lt;- read.csv(\"~/marina_turbo/Visium_Project/analysis/outputs/Fibroblasts_Analysis/stroma3_Tumor_v_stroma3_GoL.csv\")\nfibro3tumor_vs_fibro3gol %&gt;% \n  filter(padj &lt; 0.05, log2FoldChange &gt; 0.5) %&gt;%\n  pull(X) %&gt;%\n  intersect(rownames(xenium_samples)) -&gt; fibro3_tumor_markers\nfibro3tumor_vs_fibro3gol %&gt;% \n  filter(padj &lt; 0.05, log2FoldChange &lt; -0.5) %&gt;%\n  pull(X) %&gt;%\n  intersect(rownames(xenium_samples)) -&gt; fibro3_gol_markers\n\nfibro2_genes &lt;- c(\"ACTA2\", \"TAGLN\", \"INHBA\", \"LOXL2\", \"SFRP4\", \"WNT5A\", \"MFAP5\")\ndata &lt;- xenium_samples[[]] |&gt; \n  bind_cols(FetchData(xenium_samples, vars = fibro2_genes)) |&gt; \n  filter(annotation == 'Fibro') |&gt;\n  pivot_longer(all_of(fibro2_genes), names_to = \"Gene\", values_to = \"Expression\") |&gt;\n  select(sample_id, r_dist_Tumor, Gene, Expression)\ndata$sample_id &lt;- factor(data$sample_id)\n\nfibro2_genes &lt;- c(\"ACTA2\", \"TAGLN\", \"INHBA\", \"LOXL2\", \"SFRP4\", \"WNT5A\", \"MFAP5\", \"LRRC15\")\nxenium_samples[[]] |&gt; \n  bind_cols(FetchData(xenium_samples, vars = fibro2_genes)) |&gt; \n  filter(annotation == 'Fibro') |&gt;\n  pivot_longer(all_of(fibro2_genes), names_to = \"Gene\", values_to = \"Expression\") |&gt; \n  ggplot(aes(r_dist_Tumor, Expression, color = Gene)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\")) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"Radial Distance from Tumor Epithelial\") + ylab(\"Fibroblasts-specific Expression\")\n\nfibro3_genes &lt;- c(\"C7\", \"EDNRB\", \"IGF1\")\nxenium_samples[[]] |&gt; \n  bind_cols(FetchData(xenium_samples, vars = fibro3_genes)) |&gt; \n  filter(predicted_cellType == 'Fibroblasts') |&gt;\n  pivot_longer(all_of(fibro3_genes), names_to = \"Gene\", values_to = \"Expression\") |&gt; \n  ggplot(aes(r_dist_Tumor_Epithelial, Expression, color = Gene)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\")) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"Radial Distance from Tumor Epithelial\") + ylab(\"Fibroblasts-specific Expression\")"
  },
  {
    "objectID": "st_data_acquisiton.html",
    "href": "st_data_acquisiton.html",
    "title": "Spatial Transcriptomics Acquisition",
    "section": "",
    "text": "Here we are will go through scRNAseq data acquisition from GEO. We will show the structure and metadata of samples.\nRaw sequencing data can be downloaded from the following dbGAP repositories:\nRaw count matrices can be downloaded from the following GEO repositories:\nProcessed and annotated data can be downloaded from Zenodo [here]"
  },
  {
    "objectID": "st_xenium_processing.html",
    "href": "st_xenium_processing.html",
    "title": "Xenium Data Analysis",
    "section": "",
    "text": "Here we will be showing how we preprocessed the external Xenium datasets we used for validation. We use (Bell et al. 2024) & (Fiorini et al. 2025) datasets. The preprocessing steps traditional scRNAseq processing and Harmony integration. The same pipeline was applied to both with differences in the clusters annotation due to differences in the gene panels used."
  },
  {
    "objectID": "st_xenium_processing.html#setup-and-data-import",
    "href": "st_xenium_processing.html#setup-and-data-import",
    "title": "Xenium Data Analysis",
    "section": "1 Setup and data import",
    "text": "1 Setup and data import\n\n\nCode\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(SeuratWrappers)\nlibrary(reticulate)\nlibrary(qs)\nlibrary(spacexr)\nlibrary(harmony)\nlibrary(clustree)\nlibrary(SeuratExtend)\nlibrary(UCell)\nlibrary(parallel)\nsource(\"utils.R\")\n\nsamples_info &lt;- read.table(\"data/samples_manifest.txt\") %&gt;%\n  `colnames&lt;-`(c(\"sample_id\", \"xeniumranger_outDir\", \"ecDNA_state\"))\nproseg_outDir &lt;- \"outputs/proseg/\"\n\n# Importing samples -------------------------------------------------------\n\nxenium_samples &lt;- lapply(samples_info$sample_id, function(x){\n  \n  xenium_obj &lt;- ProsegToSeurat(paste0(\"outputs/proseg/\", x))\n  xenium_obj$sample_id &lt;- x\n  \n  rctd_res &lt;- readRDS(paste0(\"outputs/RCTD/\", x, \"_rctd.rds\"))\n  annotations.df &lt;- rctd_res@results$results_df\n  annotations &lt;- annotations.df$first_type\n  names(annotations) &lt;- rownames(annotations.df)\n  xenium_obj &lt;- AddMetaData(xenium_obj, data.frame(predicted_cellType = annotations))\n  \n  xenium_obj &lt;- RenameCells(xenium_obj, add.cell.id = x)\n  names(xenium_obj@images) &lt;- x\n  xenium_obj@images[[1]]@key &lt;- x\n  \n  return(xenium_obj)\n}) %&gt;%\n  reduce(merge)"
  },
  {
    "objectID": "st_xenium_processing.html#data-processing-and-normalization",
    "href": "st_xenium_processing.html#data-processing-and-normalization",
    "title": "Xenium Data Analysis",
    "section": "2 Data processing and normalization",
    "text": "2 Data processing and normalization\nIt seems that VR35 has a lot of regions with non-identified cell types due to low transcriptional reads. We will remove it and remove all cells with NA predicted celltype\n\n\nCode\n# Data filteration --------------------------------------------------------\nxenium_samples &lt;- subset(xenium_samples, subset = sample_id != \"VR35\")\nxenium_samples &lt;- xenium_samples[,!is.na(xenium_samples$predicted_cellType)]\n\n# Data processing ---------------------------------------------------------\nxenium_samples &lt;- NormalizeData(xenium_samples)\nxenium_samples &lt;- FindVariableFeatures(xenium_samples, nfeatures = 414)\nxenium_samples &lt;- ScaleData(xenium_samples, features = rownames(xenium_samples))\nxenium_samples &lt;- RunPCA(xenium_samples, features = rownames(xenium_samples))\nxenium_samples &lt;- RunUMAP(xenium_samples, dims = 1:15)\n\n# Harmony integration -----------------------------------------------------\nxenium_samples &lt;- JoinLayers(xenium_samples)\nxenium_samples &lt;- RunHarmony(\n  object = xenium_samples,\n  group.by.vars = \"sample_id\",      \n  reduction.use = \"pca\",      \n  dims.use = 1:20\n)\n\nxenium_samples &lt;- RunUMAP(xenium_samples, reduction = 'harmony', dims = 1:20)\nxenium_samples &lt;- FindNeighbors(xenium_samples, reduction = 'harmony', dims = 1:20)\nxenium_samples &lt;- FindClusters(xenium_samples, resolution = 0.2)\nDimPlot(xenium_samples, group.by = \"sample_id\") + DimPlot_scCustom(xenium_samples, group.by = \"predicted_cellType\")\nqsave(xenium_samples, \"outputs/xenium_obj_harmony_integrated.qs\")"
  },
  {
    "objectID": "st_xenium_processing.html#cell-type-deconvolution",
    "href": "st_xenium_processing.html#cell-type-deconvolution",
    "title": "Xenium Data Analysis",
    "section": "3 Cell Type Deconvolution",
    "text": "3 Cell Type Deconvolution\nWe will use RCTD from spaceXr (Cable et al. 2022) in the doublet mode to estimate the cell type in each segmented cell. We will use the same scRNAseq reference that can be downloaded from Zenodo here.\n\n\nCode\nref &lt;- qread(\"scRef_filtered_integrated_annotated.qs\")\nref &lt;- subset(ref, subset = main_annotation_scvi != 'T_Cells(Hi_Ribo)')\ncounts &lt;- GetAssayData(ref, assay = \"RNA\", slot = \"counts\")\nref$`Cell Type` &lt;- as.character(ref$`Cell Type`)\ncluster &lt;- as.factor(ref$`Cell Type`)\nnames(cluster) &lt;- colnames(ref)\nnUMI &lt;- ref$nCount_RNA\nnames(nUMI) &lt;- colnames(ref)\nlevels(cluster) &lt;- gsub(\"/\", \"-\", levels(cluster))\nreference &lt;- Reference(counts, cluster, nUMI, n_max_cells = max(table(cluster)))\nrm(list = c(\"ref\", \"counts\",\"cluster\",\"nUMI\"))\n\nslurm_jobs &lt;- Slurm_lapply(\n  njobs = length(samples_info$sample_id),\n  job_name = \"RCTD\",\n  tmp_path = getwd(),\n  plan = \"none\",\n  sbatch_opt = list(partition = 'standard', account = '',\n                    mem = '128G', \"cpus-per-task\" = \"16\", time = \"24:00:00\"),\n  export = c(\"reference\", \"proseg_outDir\"),\n  overwrite = TRUE,\n  X = as.list(samples_info$sample_id),\n  FUN = function(x) {\n    \n    library(spacexr)\n    \n    expected_counts_path &lt;- file.path(proseg_outDir, paste0(x, \"/expected-counts.csv.gz\"))\n    expected_counts &lt;- read.csv(expected_counts_path, header=TRUE, sep=\",\")\n    cell_metadata_path &lt;- file.path(proseg_outDir, paste0(x, \"/cell-metadata.csv.gz\"))\n    cell_metadata &lt;- read.csv(cell_metadata_path, header=TRUE, sep=\",\")\n    \n    mask &lt;- is.finite(cell_metadata$centroid_x) &\n      is.finite(cell_metadata$centroid_y)\n    cell_metadata &lt;- cell_metadata[mask, ]\n    expected_counts &lt;- expected_counts[mask, ]\n    \n    coords_df &lt;- cell_metadata[c(\"centroid_x\", \"centroid_y\")]\n    names(coords_df) &lt;- c(\"x\", \"y\")\n    rownames(coords_df) &lt;- rownames(expected_counts)\n    \n    query &lt;- SpatialRNA(coords_df, round(t(expected_counts)))\n    RCTD &lt;- create.RCTD(query, reference, UMI_min = 10, max_cores = parallel::detectCores())\n    RCTD &lt;- run.RCTD(RCTD, doublet_mode = \"doublet\")\n    saveRDS(RCTD, paste0(\"outputs/RCTD/\", x, \"_rctd.rds\"))\n  })\n\nsbatch(slurm_jobs)\n\nrctd_res &lt;- lapply(list.files(\"outputs/RCTD/\", pattern = \"rctd.rds\"), readRDS)\nrctd_res &lt;- lapply(rctd_res, function(x){\n  annotations.df &lt;- x@results$results_df\n  annotations &lt;- annotations.df$first_type\n  names(annotations) &lt;- rownames(annotations.df)\n  return(data.frame(annotations))\n}) %&gt;%\n  bind_rows()\n\nxenium.obj &lt;- AddMetaData(xenium.obj, rctd_res)"
  },
  {
    "objectID": "st_xenium_processing.html#clusters-annotation",
    "href": "st_xenium_processing.html#clusters-annotation",
    "title": "Xenium Data Analysis",
    "section": "3 Clusters Annotation",
    "text": "3 Clusters Annotation\n\n\nCode\n# Annotation --------------------------------------------------------------\n\nres &lt;- seq(from = 0.1, to = 1, by = 0.1)\nfor(x in res){\n  xenium_samples &lt;- FindClusters(xenium_samples, resolution = x, cluster.name = paste0(\"res.\",x))\n}\nclustree(xenium_samples, prefix = 'res.', layout = \"sugiyama\")\nxenium_samples &lt;- FindClusters(xenium_samples, resolution = 0.5)\n\nseurat_clusters_markers &lt;- FindAllMarkers(xenium_samples, assay = 'Xenium', group.by = 'seurat_clusters')\nseurat_clusters_markers$score &lt;- seurat_clusters_markers$avg_log2FC * seurat_clusters_markers$pct.1\nxenium_samples@misc$seurat_clusters_markers &lt;- seurat_clusters_markers\n\n## I will remove cluster 14 as it has low transcript count\nxenium_samples &lt;- subset(xenium_samples, subset = seurat_clusters != '14')\nxenium_samples &lt;- RunUMAP(xenium_samples, reduction = 'harmony', dims = 1:20)\nseurat_clusters_markers &lt;- FindAllMarkers(xenium_samples, assay = 'Xenium', group.by = 'seurat_clusters')\nseurat_clusters_markers$score &lt;- seurat_clusters_markers$avg_log2FC * seurat_clusters_markers$pct.1\nxenium_samples@misc$seurat_clusters_markers &lt;- seurat_clusters_markers\n\nannotation &lt;- c(\"0\" = \"Tumor\",\n                \"1\" = \"Fibro\",\n                \"2\" = \"Macrophages\",\n                \"3\" = \"Fibroblasts\",\n                \"4\" = \"Fibroblasts\",\n                \"5\" = \"T_Cells\",\n                \"6\" = \"Endothelial\",\n                \"7\" = \"Tumor\",\n                \"8\" = \"Pericytes\",\n                \"9\" = \"Endocrine\",\n                \"10\" = \"Mast_Cells\",\n                \"11\" = \"Plasma_Cells\",\n                \"12\" = \"Tumor\",\n                \"13\" = \"Tumor\")\nxenium_samples &lt;- RenameIdents(xenium_samples, annotation)\nxenium_samples$annotation &lt;- Idents(xenium_samples)\n\nIdents(xenium_samples) &lt;- xenium_samples$seurat_clusters\nsub_annotation &lt;- c(\"0\" = \"Tumor1\",\n                    \"1\" = \"Fibro1\",\n                    \"2\" = \"Macrophages\",\n                    \"3\" = \"Fibro2\",\n                    \"4\" = \"Fibro3\",\n                    \"5\" = \"T_Cells\",\n                    \"6\" = \"Endothelial\",\n                    \"7\" = \"Tumor2\",\n                    \"8\" = \"Pericytes\",\n                    \"9\" = \"Endocrine\",\n                    \"10\" = \"Mast_Cells\",\n                    \"11\" = \"Plasma_Cells\",\n                    \"12\" = \"Tumor3\",\n                    \"13\" = \"CyclingTumor\")\nxenium_samples &lt;- RenameIdents(xenium_samples, sub_annotation)\nxenium_samples$sub_annotation &lt;- Idents(xenium_samples)\n\nxenium_samples$annotation &lt;- factor(xenium_samples$annotation, levels = c(\"Tumor\", \"Fibroblasts\", \"Pericytes\", \"Endocrine\", \"Endothelial\",\n                                                                          \"Plasma_Cells\", \"Mast_Cells\", \"Macrophages\", \"T_Cells\"))\nIdents(xenium_samples) &lt;- xenium_samples$annotation"
  },
  {
    "objectID": "st_xenium_processing.html#projecting-fibro2-and-fibro3-signature-on-fibroblasts-of-xenium-data",
    "href": "st_xenium_processing.html#projecting-fibro2-and-fibro3-signature-on-fibroblasts-of-xenium-data",
    "title": "Xenium Data Analysis",
    "section": "4 Projecting Fibro2 and Fibro3 signature on fibroblasts of Xenium data",
    "text": "4 Projecting Fibro2 and Fibro3 signature on fibroblasts of Xenium data\n\n\nCode\nfibro2_v_fibro2_DEGs &lt;- read.csv(\"/outputs/Fibroblasts_Analysis/stroma2_v_stroma3_DEGs.csv\", row.names = 1)\n\nfibro2_sig &lt;- fibro2_v_fibro2_DEGs %&gt;% \n  filter(padj &lt; 0.05 & log2FoldChange &gt; 0.5) %&gt;%\n  rownames() %&gt;% \n  intersect(rownames(xenium_samples))\nfibro2_sig &lt;- c(\"ACTA2\", \"LOXL2\", \"COL5A2\", \"THBS2\", \"MFAP5\", \"INHBA\")\n\nfibro3_sig &lt;- fibro2_v_fibro2_DEGs %&gt;% \n  filter(padj &lt; 0.05 & log1p(baseMean) &gt; 3 & log2FoldChange &lt; -0.5) %&gt;%\n  rownames() %&gt;% \n  intersect(rownames(xenium_samples))\nfibro3_sig &lt;- c(\"CRISPLD2\", \"STEAP4\", \"CCL19\", \"PTN\",\"TNC\", \"MYC\",\"EDNRB\",\"TFPI\",\"EGFR\",\"PTGDS\",\"RSPO3\",\"FBLN1\",\"PDGFRA\",\"DPT\", \"RSPO1\",\"C7\",\"MEDAG\",\"MAMDC2\", \"OGN\")\n\nfibro &lt;- subset(xenium_samples, subset = annotation == 'Fibroblasts')\nfibro &lt;- AddModuleScore_UCell(fibro,features = list(fibro3_sig = fibro3_sig, fibro2_sig = fibro2_sig), ncores = detectCores())\nfibro@meta.data &lt;- mutate(fibro@meta.data, \n                          fibro2_score_scaled = (fibro2_sig_UCell - min(fibro2_sig_UCell)) / (max(fibro2_sig_UCell) - min(fibro2_sig_UCell)),\n                          fibro3_score_scaled = (fibro3_sig_UCell - min(fibro3_sig_UCell)) / (max(fibro3_sig_UCell) - min(fibro3_sig_UCell))) %&gt;%\n  mutate(fibro_combined_score = log((fibro2_score_scaled + 1e-3) / (fibro3_score_scaled + 1e-3)))\nxenium_samples &lt;- AddMetaData(xenium_samples, fibro@meta.data %&gt;% select(fibro2_sig_UCell, fibro3_sig_UCell, fibro2_score_scaled, fibro3_score_scaled, fibro_combined_score))"
  },
  {
    "objectID": "st_xenium_processing.html#saving-object",
    "href": "st_xenium_processing.html#saving-object",
    "title": "Xenium Data Analysis",
    "section": "5 Saving Object",
    "text": "5 Saving Object\n\n\nCode\nqsave(xenium_samples, \"outputs/xenium_obj_harmony_integrated.qs\")"
  },
  {
    "objectID": "st_xenium_processing.html#session-info",
    "href": "st_xenium_processing.html#session-info",
    "title": "Xenium Data Analysis",
    "section": "6 Session Info",
    "text": "6 Session Info\n\n\nCode\nsessionInfo()"
  },
  {
    "objectID": "scRNAseq_macs.html",
    "href": "scRNAseq_macs.html",
    "title": "Macrophages Subpopulation Analysis",
    "section": "",
    "text": "This section focuses on a detailed sub-analysis of the macrophages population. We subset the macrophages cells from the main dataset, reclustered them to identify distinct macrophages subtypes."
  },
  {
    "objectID": "scRNAseq_macs.html#setup-and-environment-configuration",
    "href": "scRNAseq_macs.html#setup-and-environment-configuration",
    "title": "Macrophages Subpopulation Analysis",
    "section": "1 Setup and Environment Configuration",
    "text": "1 Setup and Environment Configuration\n\n\nCode\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratWrappers)\n  library(tidyverse)\n  library(scCustomize)\n  library(CellChat)\n  library(slurmR)\n  library(tidyverse)\n  library(reticulate)\n  library(qs)\n  library(clustree)\n  library(org.Hs.eg.db)\n  library(Seurat)\n  library(slurmR)\n  library(cowplot)\n  library(tidyverse)\n  library(pheatmap)\n  library(qs)\n})\n\nref &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef.qs\")"
  },
  {
    "objectID": "scRNAseq_macs.html#subset-and-re-cluster-macrophages",
    "href": "scRNAseq_macs.html#subset-and-re-cluster-macrophages",
    "title": "Macrophages Subpopulation Analysis",
    "section": "2 Subset and Re-cluster Macrophages",
    "text": "2 Subset and Re-cluster Macrophages\n\n\nCode\nmacs &lt;- subset(ref, subset = main_annotation_scvi == 'Macrophages')\nmacs &lt;- RunUMAP(macs, reduction = 'integrated.scvi', dims = 1:30)\nmacs &lt;- FindNeighbors(macs, reduction = 'integrated.scvi', dims = 1:30)\nres &lt;- seq(from = 0.05, to = 1, by = 0.05)\nfor(x in res){\n  macs &lt;- FindClusters(macs, resolution = x, cluster.name = paste0(\"res.\",x))\n}\nclustree(macs, prefix = 'res.', layout = \"sugiyama\")\nmacs &lt;- FindClusters(macs, resolution = 0.35)"
  },
  {
    "objectID": "scRNAseq_macs.html#annotate-macrophages-subtypes",
    "href": "scRNAseq_macs.html#annotate-macrophages-subtypes",
    "title": "Macrophages Subpopulation Analysis",
    "section": "3 Annotate Macrophages Subtypes",
    "text": "3 Annotate Macrophages Subtypes\n\n\nCode\nDimPlot_scCustom(macs)\nFeaturePlot(macs, features = c(\"CD14\", 'APOE', 'MARCO', 'CCR2', 'CD68', 'C1QA', 'FCGR3A', 'FCGR3B', 'SPP1', 'IL1B', 'HBEGF', 'VEGFA'))\nIdents(macs) &lt;- macs$seurat_clusters\n\nmarkers &lt;- FindAllMarkers(macs)\nmarkers$scores &lt;- markers$avg_log2FC * markers$pct.1\n\nDotPlot_scCustom(macs, features = unique(top_markers), group.by = 'seurat_clusters', flip_axes = T) +\n  theme(axis.text.y = element_text(size = 9, face = 'bold'),\n        axis.text.x = element_text(size = 9, face = 'bold'))\n\nnew_idents &lt;- c('0' = 'Classical_Macs',\n                '1' = 'Resident_Macs',\n                '2' = 'THBS1+_Macs',\n                '3' = 'AltAct_Macs',\n                '4' = 'AltAct_Macs',\n                '5' = 'AltAct_Macs',\n                '6' = 'Resident_Macs',\n                '7' = 'Classical_Macs',\n                '8' = 'Nonclassical_Macs',\n                '9' = 'AltAct_Macs',\n                '10' = 'Dendritic',\n                '11' = 'Cycling_Macs',\n                '12' = 'Nonclassical_Macs',\n                '13' = 'T_Cells_Doublets',\n                '14' = 'RBCs')\n\nmacs &lt;- RenameIdents(macs, new_idents)\nmacs$macs_subtypes &lt;- Idents(macs)\n\nmacs &lt;- macs[, !(macs$macs_subtypes %in% c(\"T_Cells_Doublets\", \"RBCs\"))]\nmacs &lt;- RunUMAP(macs, reduction = 'integrated.scvi', dims = 1:30)\n\nmacs$macs_subtypes &lt;- factor(macs$macs_subtypes, levels = c(\"Classical_Macs\", \n                                                            \"Nonclassical_Macs\",\n                                                            \"Resident_Macs\", \n                                                            \"AltAct_Macs\", \n                                                            \"Cycling_Macs\",\n                                                            \"THBS1+_Macs\",\n                                                            \"Dendritic\"))\n\nmarkers &lt;- FindAllMarkers(macs, group.by = 'macs_subtypes')\nmarkers$scores &lt;- markers$avg_log2FC * markers$pct.1\nmacs@misc$markers &lt;- markers\n\nqsave(macs, \"../outputs/scRNAseq_Analysis/scRef_macs.qs\")\n\n\n\n\nCode\nref &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef_macs.qs\")\n\n\n\n\nCode\nDimPlot2(macs)\n\nfeatures &lt;- c(\"S100A8\", \"S100A9\", \"LYZ\", \"FCN1\",\n              \"FCGR3A\", \"IFITM2\", \"IFITM3\",\n              \"C1QA\", \"C1QB\", \"CCL4\",\n              \"APOE\", \"MARCO\", \"SPP1\",\n              \"MKI67\",\"TOP2A\",\n              \"THBS1\",\"AREG\",\"EREG\",\n              \"HLA-DRA\", \"CD74\", \"CLEC9A\", \"IDO1\")\n\nDotPlot2(macs, features = features, group.by = 'macs_subtypes', color_scheme = 'RdYlBu-rev', flip = T) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n\n\n\n\nCode\nsessionInfo()"
  },
  {
    "objectID": "scRNAseq_data_acquisiton.html",
    "href": "scRNAseq_data_acquisiton.html",
    "title": "scRNAseq Acquisition",
    "section": "",
    "text": "Here we are will go through scRNAseq data acquisition from GEO. We will show the structure and metadata of samples.\nRaw sequencing data can be downloaded from the following dbGAP repositories:\nRaw count matrices can be downloaded from the following GEO repositories:\nProcessed and annotated data can be downloaded from Zenodo [here]"
  },
  {
    "objectID": "st_clustering.html",
    "href": "st_clustering.html",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "",
    "text": "Here we load essential packages, setup input/output directories, and load visium_samples_manifest.xlsx from the data directory, that includes information about visium samples. We generate a coords dataframe that includes coordinates of all samples which will be essential for the analysis later.\nWe will use BayesSpace (Zhao et al. 2021) for the spatially-informed clustering. One can review benchmarking methods for spatially-informed clustering (Yuan et al. 2024).\n\n\n\nCode\nsuppressPackageStartupMessages({\n  library(BayesSpace)\n  library(Seurat)\n  library(miloR)\n  library(SingleCellExperiment)\n  library(cowplot)\n  library(tidyverse)\n  library(purrr)\n  library(reticulate)\n  library(SeuratDisk)\n  library(SeuratWrappers)\n  library(slurmR)\n})\n\ninputDir &lt;- \"../outputs/Preprocessing/spatial_seurat_objects/\"\noutputDir &lt;- '../outputs/Spatial_Clustering/'\ndir.create(outputDir, showWarnings = F, recursive = T)\n\nsamples_info &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")\n\n## Generate Coordinates dataframe\ncoords &lt;- lapply(samples_info$patient_id, function(x) {\n  spaceranger_path &lt;- samples_info %&gt;%\n    filter(patient_id == x) %&gt;%\n    pull(cellranger_3.0.1_output_path)\n  coord_table &lt;- read.csv(paste0(\n    spaceranger_path,\n    \"spatial/tissue_positions.csv\"\n  )) %&gt;%\n    mutate(sample = x)\n  rownames(coord_table) &lt;- paste0(coord_table$sample, \"_\", coord_table$barcode)\n  return(coord_table)\n}) %&gt;%\n  bind_rows()"
  },
  {
    "objectID": "st_clustering.html#setup-data-loading",
    "href": "st_clustering.html#setup-data-loading",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "",
    "text": "Here we load essential packages, setup input/output directories, and load visium_samples_manifest.xlsx from the data directory, that includes information about visium samples. We generate a coords dataframe that includes coordinates of all samples which will be essential for the analysis later.\nWe will use BayesSpace (Zhao et al. 2021) for the spatially-informed clustering. One can review benchmarking methods for spatially-informed clustering (Yuan et al. 2024).\n\n\n\nCode\nsuppressPackageStartupMessages({\n  library(BayesSpace)\n  library(Seurat)\n  library(miloR)\n  library(SingleCellExperiment)\n  library(cowplot)\n  library(tidyverse)\n  library(purrr)\n  library(reticulate)\n  library(SeuratDisk)\n  library(SeuratWrappers)\n  library(slurmR)\n})\n\ninputDir &lt;- \"../outputs/Preprocessing/spatial_seurat_objects/\"\noutputDir &lt;- '../outputs/Spatial_Clustering/'\ndir.create(outputDir, showWarnings = F, recursive = T)\n\nsamples_info &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")\n\n## Generate Coordinates dataframe\ncoords &lt;- lapply(samples_info$patient_id, function(x) {\n  spaceranger_path &lt;- samples_info %&gt;%\n    filter(patient_id == x) %&gt;%\n    pull(cellranger_3.0.1_output_path)\n  coord_table &lt;- read.csv(paste0(\n    spaceranger_path,\n    \"spatial/tissue_positions.csv\"\n  )) %&gt;%\n    mutate(sample = x)\n  rownames(coord_table) &lt;- paste0(coord_table$sample, \"_\", coord_table$barcode)\n  return(coord_table)\n}) %&gt;%\n  bind_rows()"
  },
  {
    "objectID": "st_clustering.html#data-processing-and-integration",
    "href": "st_clustering.html#data-processing-and-integration",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "2 Data processing and integration",
    "text": "2 Data processing and integration\nHere we create a merged Seurat object for all spatial data from the individual objects created in Spatial Data Processing, and integrate them using RPCA integration.\n\n\nCode\n## Import samples and merged them\nmerged &lt;- lapply(samples_info$sample_id, function(x) {\n  seurat &lt;- readRDS(paste0(inputDir, x, \".rds\"))\n  seurat$sample_id &lt;- x\n  seurat &lt;- RenameCells(seurat, add.cell.id = x)\n  names(seurat@images) &lt;- x\n  seurat@images[[x]]@key &lt;- x\n  seurat[[\"percent.mt\"]] &lt;- PercentageFeatureSet(\n    object = seurat,\n    pattern = \"^MT-\"\n  )\n  return(seurat)\n})\nmerged &lt;- purrr::reduce(merged, merge)\nmerged &lt;- JoinLayers(merged, assay = 'Spatial')\n\n## Applying filters for QC. We will remove spots with less than 500 genes or more than 20% mitochondrial percent\nmerged &lt;- subset(merged, subset = nFeature_Spatial &gt; 500 & percent.mt &lt; 20)\n\n## RPCA data integration\nmerged[[\"Spatial\"]] &lt;- split(merged[[\"Spatial\"]], f = merged$sample_id)\nmerged &lt;- NormalizeData(merged)\nmerged &lt;- FindVariableFeatures(merged)\nmerged &lt;- ScaleData(merged)\nmerged &lt;- RunPCA(merged)\nmerged &lt;- IntegrateLayers(\n  object = merged,\n  method = RPCAIntegration,\n  new.reduction = \"integrated.rpca\",\n  verbose = TRUE\n)\nmerged &lt;- RunUMAP(merged, reduction = 'integrated.rpca', dims = 1:50)\nmerged &lt;- JoinLayers(merged)\nmerged &lt;- AddMetaData(merged, coord)"
  },
  {
    "objectID": "st_clustering.html#bayesspace-clustering",
    "href": "st_clustering.html#bayesspace-clustering",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "3 BayesSpace Clustering",
    "text": "3 BayesSpace Clustering\nThe workflow described below is an adapdation from the one described here.\n1- BayesSpace works with SingleCellExperiment objects, so we need to convert our Seurat object to this format 2- We add the coordinates information to the colData 3- The object is then processed using spatialPreprocess function 4- We stitch the samples together by adding 150 units shift to the coordinates to create 1 x 14 grid 5- We used qTune to find the optimal number of clusters 6- We will pick 23 clusters 7- Then we add the cluster information back to the Seurat object\n\n\nCode\nmerged_sce &lt;- as.SingleCellExperiment(merged)\ncolData(merged_sce)[, c(\"array_row\", \"array_col\")] &lt;- merged@meta.data[, c(\n  \"array_row\",\n  \"array_col\"\n)]\ncolData(merged_sce)[, c(\"row\", \"col\")] &lt;- merged@meta.data[, c(\n  \"array_row\",\n  \"array_col\"\n)]\ncolData(merged_sce)[, c(\n  \"pxl_col_in_fullres\",\n  \"pxl_row_in_fullres\"\n)] &lt;- merged@meta.data[, c(\"pxl_col_in_fullres\", \"pxl_row_in_fullres\")]\nmerged_sce &lt;- spatialPreprocess(\n  merged_sce,\n  platform = 'Visium',\n  n.PCs = 50,\n  BPPARAM = BiocParallel::MulticoreParam(workers = parallel::detectCores() - 1)\n)\n\n## Offsetting slides in a 1 * 14 Grid\nsamples &lt;- unique(merged_sce$sample_id)\nshift &lt;- 150\nfor (i in seq(from = 2, to = length(samples))) {\n  merged_sce$row[merged_sce$sample_id == samples[i]] =\n    merged_sce$row[merged_sce$sample_id == samples[i]] + (shift * (i - 1))\n  merged_sce$array_row[merged_sce$sample_id == samples[i]] =\n    merged_sce$array_row[merged_sce$sample_id == samples[i]] + (shift * (i - 1))\n}\n\nmerged_sce &lt;- qTune(\n  merged_sce,\n  qs = seq(2, 30),\n  use.dimred = 'INTEGRATED.rpca',\n  platform = \"Visium\",\n  d = 30,\n  cores = parallel::detectCores() - 2\n)\nqPlot(merged_sce)\n\n## We will pick 23\nmerged_sce &lt;- spatialCluster(\n  merged_sce,\n  q = 23,\n  platform = \"Visium\",\n  d = 30,\n  use.dimred = 'INTEGRATED.RPCA',\n  init.method = \"mclust\",\n  model = \"t\",\n  gamma = 2,\n  nrep = 10000,\n  burn.in = 100,\n  save.chain = TRUE\n)\nspatial_clusters &lt;- colData(merged_sce) %&gt;%\n  data.frame() %&gt;%\n  select(sample_id, spatial.cluster)\nwrite.csv(\n  spatial_clusters,\n  file = \"../outputs/Spatial_Clustering/Tumor_TumorAdj_GoL_23_spatial_clusters.csv\",\n  quote = F\n)\n\nmerged &lt;- AddMetaData(merged, spatial_clusters)\nmarkers &lt;- FindAllMarkers(merged, group.by = 'spatial.cluster', only.pos = T)\nmarkers$score &lt;- markers$avg_log2FC * markers$pct.1\nmerged@misc$markers &lt;- markers"
  },
  {
    "objectID": "st_clustering.html#clusters-annotation",
    "href": "st_clustering.html#clusters-annotation",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "4 Clusters Annotation",
    "text": "4 Clusters Annotation\nHere we use the markers and the distribution of cell type fractions from the deconvolution results and the histology to annotate the clusters as described in our manuscript (elhossiny_manuscript?). RCTD generates two outputs, all_weights and sub_weights, where all_weights is the result of RCTD full-mode where all cell types are used and get a weight, whereas in sub_weights, the algorithm iteratively selects a subset of cell types that are likely to be on the pixel.\nThe following code extracts the weights from the RCTD results and add them to the merged seurat object.\n\n4.1 Extracting RCTD Weights\n\n\nCode\nrctd_all_wts &lt;- lapply(samples_info$sample_id, function(x) {\n  res &lt;- readRDS(paste0(\"../outputs/Deconvolution/RCTD/\", x, \".rds\"))\n  barcodes &lt;- colnames(res@spatialRNA@counts)\n  all_wts &lt;- lapply(seq(1:length(barcodes)), function(x) {\n    data.frame(res@results[[x]]$all_weights) %&gt;%\n      `colnames&lt;-`(barcodes[[x]])\n  }) %&gt;%\n    bind_cols()\n  all_wts &lt;- normalize_weights(t(all_wts)) %&gt;% t()\n  colnames(all_wts) &lt;- paste0(x, \"_\", colnames(all_wts))\n  return(all_wts)\n})\ncellTypes &lt;- rownames(rctd_all_wts[[1]])\nrctd_all_wts &lt;- data.frame(bind_cols(rctd_all_wts))\ncolnames(rctd_all_wts) &lt;- gsub(\"\\\\.\", \"-\", colnames(rctd_all_wts))\nrctd_all_wts &lt;- rctd_all_wts[, colnames(merged)]\nrownames(rctd_all_wts) &lt;- cellTypes\nmerged[['RCTD_all_wts']] &lt;- CreateAssayObject(rctd_all_wts)\n\nrctd_sub_wts &lt;- lapply(samples_info$sample_id, function(x) {\n  res &lt;- readRDS(paste0(\"../outputs/Deconvolution/RCTD/\", x, \".rds\"))\n  barcodes &lt;- colnames(res@spatialRNA@counts)\n  cellTypes &lt;- res@cell_type_info$renorm[[2]]\n  sub_wts &lt;- lapply(seq(1:length(barcodes)), function(y) {\n    wts &lt;- data.frame(\n      names(res@results[[y]]$conf_list),\n      res@results[[y]]$sub_weights\n    ) %&gt;%\n      `colnames&lt;-`(c('cellType', barcodes[[y]])) %&gt;%\n      `rownames&lt;-`(NULL)\n\n    remaining_ct &lt;- setdiff(cellTypes, wts$cellType)\n    remaining_ct &lt;- data.frame(remaining_ct, 0) %&gt;%\n      `colnames&lt;-`(c('cellType', barcodes[[y]]))\n\n    wts &lt;- rbind(wts, remaining_ct) %&gt;%\n      column_to_rownames(var = 'cellType')\n    wts &lt;- data.frame(wts[cellTypes, ], row.names = cellTypes)\n    colnames(wts) &lt;- barcodes[[y]]\n    return(wts)\n  }) %&gt;%\n    bind_cols()\n  colnames(sub_wts) &lt;- paste0(x, \"_\", colnames(sub_wts))\n  return(sub_wts)\n}) %&gt;%\n  bind_cols() %&gt;%\n  data.frame()\ncolnames(rctd_sub_wts) &lt;- gsub(\"\\\\.\", \"-\", colnames(rctd_sub_wts))\nrctd_sub_wts &lt;- rctd_sub_wts[, colnames(merged)]\nmerged[['RCTD_sub_wts']] &lt;- CreateAssayObject(rctd_sub_wts)\n\n\n\n\n4.2 Renaming Clusters\nThe clusters annotation are written in BayesSpace_23_spatial_clusters_annotation.xlsx within the outputs/Spatial_Clustering/ directory. We merged certain clusters based on having ~1.0 pearson correlation value indicating potential over-clustering.\n\n\nCode\nannotation &lt;- readxl::read_xlsx(\n  \"../outputs/Spatial_Clustering/BayesSpace_23_spatial_clusters_annotation.xlsx\"\n)\n\n## Adding main annotation\nIdents(merged) &lt;- merged$spatial.cluster\nmain_annotation &lt;- setNames(annotation$main_annotation, annotation$cluster)\nmerged &lt;- RenameIdents(merged, main_annotation)\nmerged$main_annotation &lt;- Idents(merged)\n\n## Adding sub annotation (level2 sub clusters)\nIdents(merged) &lt;- merged$spatial.cluster\nsub_annotation &lt;- setNames(annotation$sub_annotation, annotation$cluster)\nmerged &lt;- RenameIdents(merged, sub_annotation)\nmerged$sub_annotation &lt;- Idents(merged)\n\n## Refactoring levels\nmerged$main_annotation &lt;- factor(\n  merged$main_annotation,\n  levels = c(\n    \"Acinar1\",\n    \"Acinar2\",\n    \"Acinar3\",\n    \"Ducts\",\n    \"PanIN/GLTumor\",\n    \"PDTumor\",\n    \"Fibro1\",\n    \"Fibro2\",\n    \"Fibro3\",\n    \"Fibro4\",\n    \"Perivascular\",\n    \"Adipose\",\n    \"Endocrine\",\n    \"Neural\",\n    \"TLS\",\n    \"Plasma_Cells\",\n    \"Macrophages\"\n  )\n)\n\n## Adding D1-D17 cluster annotation\nclusters &lt;- paste0(\"D\", seq(1:length(levels(merged$main_annotation))))\nnames(clusters) &lt;- levels(merged$main_annotation)\nIdents(merged) &lt;- merged$main_annotation\nmerged &lt;- RenameIdents(merged, clusters)\nmerged$domains &lt;- Idents(merged)\nmerged$domain_annotation &lt;- paste0(merged$domains, \":\", merged$main_annotation)\nnumbers &lt;- sub(\"^D([0-9]+):.*\", \"\\\\1\", unique(merged$domain_annotation))\nmerged$domain_annotation &lt;- factor(\n  merged$domain_annotation,\n  levels = unique(merged$domain_annotation)[order(as.numeric(numbers))]\n)\nIdents(merged) &lt;- merged$main_annotation"
  },
  {
    "objectID": "st_clustering.html#milor-analysis",
    "href": "st_clustering.html#milor-analysis",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "5 miloR Analysis",
    "text": "5 miloR Analysis\nWe use miloR (Dann et al. 2022) to quantify differential abundance in different spatial domains between tumor and healthy tissues.\n\n\nCode\nsce &lt;- as.SingleCellExperiment(merged)\nsce &lt;- sce[, sce$tissue != 'AdjNormal']\nreducedDim(sce, \"UMAP\") &lt;- merged@reductions$umap@cell.embeddings[\n  colnames(sce),\n]\nreducedDim(sce, \"PCA\") &lt;- merged@reductions$integrated.rpca@cell.embeddings[\n  colnames(sce),\n]\nmilo &lt;- Milo(sce)\ntraj_milo &lt;- buildGraph(milo, k = 10, d = 30, reduced.dim = \"PCA\")\ntraj_milo &lt;- makeNhoods(traj_milo, prop = 0.1, k = 10, d = 30, refined = TRUE)\ntraj_milo &lt;- countCells(\n  traj_milo,\n  meta.data = data.frame(colData(traj_milo)),\n  sample = \"sample_id\"\n)\n\ntraj_design &lt;- data.frame(colData(traj_milo))[, c(\"sample_id\", \"tissue\")]\ntraj_design &lt;- distinct(traj_design)\nrownames(traj_design) &lt;- NULL\ntraj_design &lt;- traj_design %&gt;% column_to_rownames('sample_id')\n\ntraj_milo &lt;- calcNhoodDistance(traj_milo, d = 30, reduced.dim = 'PCA')\n\nda_results &lt;- testNhoods(traj_milo, design = ~tissue, design.df = traj_design)\ntraj_milo &lt;- buildNhoodGraph(traj_milo)\nqsave(traj_milo, \"outputs/Misc/spatial_milo.qs\")\n\nda_results &lt;- annotateNhoods(\n  traj_milo,\n  da_results,\n  coldata_col = \"domain_annotation\"\n)\nda_results &lt;- da_results %&gt;%\n  mutate(\n    category = ifelse(\n      domain_annotation %in%\n        c(\n          \"D1:Acinar1\",\n          \"D2:Acinar2\",\n          \"D3:Acinar3\",\n          \"D4:Ducts\",\n          \"D5:PanIN/GLTumor\",\n          \"D6:PDTumor\"\n        ),\n      \"Epithelial Domains\",\n      ifelse(\n        domain_annotation %in%\n          c(\n            \"D7:Fibro1\",\n            \"D8:Fibro2\",\n            \"D9:Fibro3\",\n            \"D10:Fibro4\",\n            \"D11:Perivascular\",\n            \"D12:Adipose\",\n            \"D13:Endocrine\",\n            \"D14:Neural\"\n          ),\n        \"Non-Immune Stroma Domains\",\n        \"Immune Stroma Domains\"\n      )\n    )\n  )\nda_results$domain_annotation &lt;- factor(\n  da_results$domain_annotation,\n  levels = c(\n    \"D1:Acinar1\",\n    \"D2:Acinar2\",\n    \"D3:Acinar3\",\n    \"D4:Ducts\",\n    \"D5:PanIN/GLTumor\",\n    \"D6:PDTumor\",\n    \"D7:Fibro1\",\n    \"D8:Fibro2\",\n    \"D9:Fibro3\",\n    \"D10:Fibro4\",\n    \"D11:Perivascular\",\n    \"D12:Adipose\",\n    \"D13:Endocrine\",\n    \"D14:Neural\",\n    \"D15:TLS\",\n    \"D16:Plasma_Cells\",\n    \"D17:Macrophages\"\n  )\n)\nda_results$category &lt;- factor(\n  da_results$category,\n  levels = c(\n    \"Immune Stroma Domains\",\n    \"Non-Immune Stroma Domains\",\n    \"Epithelial Domains\"\n  )\n)\nqsave(da_results, \"../outputs/Spatial_Clustering/spatial_milo_da_results.qs\")"
  },
  {
    "objectID": "st_clustering.html#saving-object",
    "href": "st_clustering.html#saving-object",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "6 Saving object",
    "text": "6 Saving object\nWe will save the final merged annotated object. The same object can be downloaded from Zenodo here\n\n\nCode\n## Saving\nqsave(merged, \"../outputs/Spatial_Clustering/spatial.qs\")"
  },
  {
    "objectID": "st_clustering.html#session-info",
    "href": "st_clustering.html#session-info",
    "title": "Spatial Transcriptomics Clustering (BayesSpace)",
    "section": "7 Session Info",
    "text": "7 Session Info\n\n\nCode\nsessionInfo()\n\n\nR version 4.4.0 (2024-04-24)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS 26.0\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: America/Detroit\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nloaded via a namespace (and not attached):\n [1] htmlwidgets_1.6.4 compiler_4.4.0    fastmap_1.2.0     cli_3.6.2        \n [5] tools_4.4.0       htmltools_0.5.8.1 yaml_2.3.8        rmarkdown_2.27   \n [9] knitr_1.47        jsonlite_1.8.8    xfun_0.52         digest_0.6.35    \n[13] rlang_1.1.3       evaluate_0.23"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Home",
    "section": "",
    "text": "This is documentation for the code used for analysis in Preprint Link. Here, we leverage single-cell RNAseq and spatial transcriptomics data to investigate the epithelial and stromal co-evolution in pancreatic cancer."
  },
  {
    "objectID": "index.html#introduction",
    "href": "index.html#introduction",
    "title": "Home",
    "section": "",
    "text": "This is documentation for the code used for analysis in Preprint Link. Here, we leverage single-cell RNAseq and spatial transcriptomics data to investigate the epithelial and stromal co-evolution in pancreatic cancer."
  },
  {
    "objectID": "index.html#data",
    "href": "index.html#data",
    "title": "Home",
    "section": "Data",
    "text": "Data\nWe used a cohort of scRNAseq samples composed of healthy (n = 24), Adjacent normal to tumor (n = 3) and PDAC (n = 18) samples and 10x Visium samples composed of healthy (n = 5), Adjacent normal to tumor (n = 2) and PDAC (n = 7). The samples are integrated from (Steele et al. 2020), (Carpenter et al. 2023), (Carpenter et al. 2024) and Preprint Link studies."
  },
  {
    "objectID": "index.html#downloading-raw-and-processed-data",
    "href": "index.html#downloading-raw-and-processed-data",
    "title": "Home",
    "section": "Downloading raw and processed data",
    "text": "Downloading raw and processed data\n\nRaw fastq data can be find in these dbGAP repositories:\nRaw count matrices can be found in these GEO repositories:\nProcessed data objects and full resolution H&E are available on Zenodo:\n\nData acquisition can also be done as described in scRNAseq Acquisition and Spatial Transcriptomics Acquisition"
  },
  {
    "objectID": "index.html#analysis",
    "href": "index.html#analysis",
    "title": "Home",
    "section": "Analysis",
    "text": "Analysis\nThe analysis workflow and findings are explained in detail in Preprint Link \n\nscRNAseq Analysis\n\nAlignment using CellRanger as detailed here CellRanger Alignmnet\nAmbient RNA correction using cellbender (Fleming et al. 2023) as detailed here scRNAseq Ambient RNA Correction\nQuality control, processing and integration as detailed here scRNAseq Data Processing and Integration\nCopy number variation inference was done using Numbat (Gao et al. 2023) as described here CNV Inference using Numbat\nFibroblasts and Macrophages subpopulation analysis were done as decribed here scRNAseq Fibroblast Subpopulation Analysis and Macrophages Subpopulation Analysis\nGene set scoring on TCGA-PAAD dataset was done as described here TCGA-PAAD Scoring\n\n\n\nSpatial Transcriptomics Analysis\n\nVisium\n\nAlignment using SpaceRanger was done is described here \nData normalization and seurat object generation is described here Spatial Transcriptomics Data Processing\nCell type deconvolution was done using RCTD (Cable et al. 2022) is described here Spatial Transcriptomics Cell Type Deconvolution\nIntegration and Spatially-informed clustering using BayesSpace (Zhao et al. 2021) is described here Spatial Transcriptomics Clustering (BayesSpace)\nLigand-Receptor interaction analysis was done using LIANA+ (liana?) is described here LIANA+ Analysis\nNeighborhood analysis is described here Spatial Transcriptomics Neighborhood Analysis\nPseudobulk analysis of epithelial compartment is described here Spatial Transcriptomics Epithelial Domains Analysis\nPseudobulk analysis of stromal compartment is described here Spatial Transcriptomics Stromal Domains Analysis\n\n\n\nXenium\n\nSegmentation was done using Proseg (Jones et al. 2025) is described here Xenium Resegmentation\nData processing and integration is described here Xenium Data Analysis\nSpatial regression was done using semla (Larsson et al. 2023) is described here Xenium Spatial Regression\nVisualization of data is done as described here Xenium Polygons Visualization"
  },
  {
    "objectID": "index.html#interactive-visualization",
    "href": "index.html#interactive-visualization",
    "title": "Home",
    "section": "Interactive Visualization",
    "text": "Interactive Visualization\nYou can explore the data interactively on www.PancAtlas.com"
  },
  {
    "objectID": "index.html#contact-us",
    "href": "index.html#contact-us",
    "title": "Home",
    "section": "Contact us",
    "text": "Contact us\nIf you have any questions please feel free to contact the authors, Ahmed M. Elhossiny (hossiny@umich.edu) and Marina Pasca di Magliano (marinapa@umich.edu)"
  },
  {
    "objectID": "scRNAseq_numbat.html",
    "href": "scRNAseq_numbat.html",
    "title": "CNV Inference using Numbat",
    "section": "",
    "text": "Here we will be using Numbat (Gao et al. 2023) to run copy number variation (CNV) inference from single-cell RNA seq data. It leverages both expression and heterozygous SNPs beta-allele frequency (BAF) to generate joint CNV probability per cell."
  },
  {
    "objectID": "scRNAseq_numbat.html#setup",
    "href": "scRNAseq_numbat.html#setup",
    "title": "CNV Inference using Numbat",
    "section": "1 Setup",
    "text": "1 Setup\nThis initial step involves downloading and preparing the essential reference files required for the Numbat analysis. These references include SNP lists from the 1000 Genomes Project and the Eagle software for phasing.\nNOTES:\n\nNumbat runs best with Docker but since we canâ€™t run docker on U-M HPC we will have the following workaround First, We install Numbat in R using install.packages('numbat'), We will access the pileup_and_phase.R script from the library path as shown in pileup_script_path below\nWe have three dependencies (samtools, eagle and cellsnp-lite). Samtools is already on the cluster and can be activated using ml samtools. Eagle is downloaded here and the path to the binary file is defined below. cellsnp-lite is best installed as conda environment due to conflicts and then you can activate this conda environment before running the slurm script. The exact conda environment used in this run can be installed using this yml file using conda env create -f CSP.yml\n\n\n\nCode\nconda create --name CSP\nconda activate CSP\nconda install -c bioconda cellsnp-lite\nconda activate CSP"
  },
  {
    "objectID": "scRNAseq_numbat.html#download-references",
    "href": "scRNAseq_numbat.html#download-references",
    "title": "CNV Inference using Numbat",
    "section": "2 Download references",
    "text": "2 Download references\n\n\nCode\nmkdir -p ../data/references/\nwget [https://sourceforge.net/projects/cellsnp/files/SNPlist/genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf.gz](https://sourceforge.net/projects/cellsnp/files/SNPlist/genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf.gz) \ngunzip genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf.gz\nmv genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf  ../data/references/\nwget [http://pklab.med.harvard.edu/teng/data/1000G_hg38.zip](http://pklab.med.harvard.edu/teng/data/1000G_hg38.zip) \nunzip 1000G_hg38.zip\nmv 1000G_hg38 data/references/\nwget [https://storage.googleapis.com/broad-alkesgroup-public/Eagle/downloads/Eagle_v2.4.1.tar.gz](https://storage.googleapis.com/broad-alkesgroup-public/Eagle/downloads/Eagle_v2.4.1.tar.gz)\ngunzip Eagle_v2.4.1.tar.gz\ntar -xzvf Eagle_v2.4.1"
  },
  {
    "objectID": "scRNAseq_numbat.html#pileup-and-phasing",
    "href": "scRNAseq_numbat.html#pileup-and-phasing",
    "title": "CNV Inference using Numbat",
    "section": "3 Pileup and Phasing",
    "text": "3 Pileup and Phasing\nThis stage processes the single-cell RNA-seq data to generate allele counts at SNP locations, which is a fundamental input for Numbat. This SLURM script processes each sample to generate allele counts from BAM files. It uses cellsnp-lite for pileup and Eagle for phasing. The script is designed to run as a job array on an HPC cluster, processing one sample per job.\nThe script pulls a numbat_manifest.txt file from data directory with at two columns: sample_id and cellranger_output path for each sample as follow\n\n\n\nsample_1\npath/to/sample_1/cellranger_output\n\n\nsample_2\npath/to/sample_2/cellranger_output\n\n\nsample_3\npath/to/sample_3/cellranger_output\n\n\n\n\n\nCode\n#!/bin/bash\n\n#SBATCH --account=\n#SBATCH --job-name='Numbat_pileup_%a'\n#SBATCH --output=logs/Numbat_pileup_%a.log\n\n#SBATCH --partition=largemem\n#SBATCH --mem=256G\n#SBATCH --cpus-per-task=16\n#SBATCH --time=48:00:00\n#SBATCH --array=1-48\n\necho \"### Loading Modules ###\"\nml samtools\n\necho \"### Reading samples manifest ###\"\nsamples_manifest=../data/numbat_manifest.txt\nsample_name=$(cat $samples_manifest | cut -f1 | sed -n $[SLURM_ARRAY_TASK_ID]p)\nsample_10xOutput=$(cat $samples_manifest | cut -f2 | sed -n $[SLURM_ARRAY_TASK_ID]p)\necho \"::&gt; Analyzing sample ${sample_name}\"\necho \"::&gt; sample 10x Output directory ${sample_10xOutput}\"\n\n## Setting up path for different variables and executables\necho \"### Loading executables ###\"\npileup_script_path=path/to/R/x86_64-pc-linux-gnu-library/4.2/numbat/bin/pileup_and_phase.R\neagle_path=Eagle_v2.4.1/eagle\ngmap_path=Eagle_v2.4.1/tables/genetic_map_hg38_withX.txt.gz\nsnpvcf_path=../data/references/genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf \npanelDir_path=../data/references/1000G_hg38\ncellbender_res_path=../outputs/scRNAseq_Analysis/cellbender\n\n## Setting up output directory\necho \"### Creating output directory ###\"\nmkdir -p ../outputs/scRNAseq_Analysis/Numbat/pileup/${sample_name}\noutputDir=../outputs/scRNAseq_Analysis/Numbat/pileup/${sample_name}\necho \"::&gt; Output Directory: ${outputDir}\"\n\n## Running pileup and phasing\necho \"### Running Pileup and Phasing ###\"\nRscript ${pileup_script_path} \\\n  --label ${sample_name} \\\n  --sample ${sample_name} \\\n  --bam ${sample_10xOutput}/possorted_genome_bam.bam \\\n  --barcodes ${cellbender_res_path}/${sample_name}_filtered.h5 \\\n  --outdir ${outputDir} \\\n  --gmap ${gmap_path} \\\n  --snpvcf ${snpvcf_path} \\\n  --paneldir ${panelDir_path} \\\n  --eagle ${eagle_path} \\\n  --ncores 16\n\n\nThe following snippet provides a quick way in R to verify which samples have successfully completed the pileup and phasing step. It scans the output directory and checks for the presence of the final allele counts file (_allele_counts.tsv.gz).\n\n\nCode\noutDir &lt;- \"../outputs/scRNAseq_Analysis/Numbat/pileup/\"\nsamples &lt;- list.files(outDir, full.names = T)\n\npileup_res &lt;- lapply(samples, function(sample){\n  sample_name &lt;- gsub(outDir, \"\", sample)\n  sample_name &lt;- gsub(\"/\",\"\",sample_name)\n  processed &lt;- any(grepl(\"_allele_counts.tsv.gz\", list.files(sample)))\n  return(data.frame(sample_name, processed))\n}) %&gt;% bind_rows()"
  },
  {
    "objectID": "scRNAseq_numbat.html#generate-reference-expression-profile",
    "href": "scRNAseq_numbat.html#generate-reference-expression-profile",
    "title": "CNV Inference using Numbat",
    "section": "4 Generate Reference Expression Profile",
    "text": "4 Generate Reference Expression Profile\nNumbat requires a reference expression profile from normal (healthy) cells to distinguish CNVs in tumor cells. This script generates that reference. We can download the processed data object directly from Zenodo here. This profile is saved as normal_ref_profile.txt and will be used as the reference for Numbatâ€™s CNV calling.\n\n\nCode\nref &lt;- readRDS(url())\nnormal &lt;- subset(ref, subset = tissue == 'Healthy')\n\nexprs &lt;- GetAssayData(normal, assay = 'RNA', layer = 'counts')\nannot &lt;- normal@meta.data %&gt;%\n  select(CellTypes) %&gt;%\n  rownames_to_column() %&gt;%\n  `colnames&lt;-`(c(\"cell\",\"group\"))\nref_ct &lt;- aggregate_counts(exprs, annot)\nwrite.table(ref_ct, \"../outputs/scRNAseq_Analysis/Numbat/normal_ref_profile.txt\", sep = \"\\t\", col.names = T, row.names = T, quote = F)"
  },
  {
    "objectID": "scRNAseq_numbat.html#run-numbat-analysis",
    "href": "scRNAseq_numbat.html#run-numbat-analysis",
    "title": "CNV Inference using Numbat",
    "section": "5 Run Numbat Analysis",
    "text": "5 Run Numbat Analysis\nThis is the core step where the Numbat algorithm is executed to call CNVs. The script uses the slurmR package to distribute the jobs across an HPC cluster for parallel processing. For each sample, it loads the count data and allele data, and runs the run_numbat function, saving the output to a specified directory.\n\n\nCode\npileupDir &lt;- \"../outputs/scRNAseq_Analysis/Numbat/pileup/\"\noutputDir &lt;- \"../outputs/scRNAseq_Analysis/Numbat/Numbat_CNV_calling/\"\ndir.create(outputDir, showWarnings = F, recursive = T)\n\nall_samples &lt;- SplitObject(ref, split.by = 'sample_Id')\ntumor_samples &lt;- subset(samples, subset = tissue != 'Healthy')\ntumor_samples &lt;- SplitObject(tumor_samples, split.by = \"sample_Id\")\npanc_normal_ref &lt;- as.matrix(read.table(\"../outputs/scRNAseq_Analysis/Numbat/normal_ref_profile.txt\"))\n\nslurm_jobs &lt;- Slurm_lapply(\n\n  njobs = length(tumor_samples),\n  job_name = \"Numbat\",\n  tmp_path = getwd(),\n  plan = \"none\",\n  sbatch_opt = list(partition = 'largemem', account = 'timofran0',\n                    mem = '256G', \"cpus-per-task\" = \"16\", time = \"48:00:00\"),\n  export = c(\"panc_normal_ref\",\"pileupDir\",\"outputDir\"),\n  overwrite = TRUE,\n\n  X = as.list(tumor_samples),\n  FUN = function(x) {\n\n    suppressPackageStartupMessages({\n      library(Seurat)\n      library(numbat)\n      library(tidyverse)\n    })\n\n    sample_ct &lt;- GetAssayData(x, assay = \"RNA\", slot = \"counts\")\n    sample_name &lt;- unique(x$sample_Id)\n    df_allele &lt;- paste0(pileupDir, sample_name, \"/\", sample_name, \"_allele_counts.tsv.gz\")\n    df_allele &lt;- read.table(df_allele, header = T, sep = \"\\t\") %&gt;%\n      mutate(cell = paste0(sample_name, \"_\", cell))\n    \n    run_numbat(\n      count_mat = sample_ct, \n      lambdas_ref = panc_normal_ref, \n      df_allele = df_allele,\n      ncores = parallel::detectCores(),\n      out_dir = paste0(outputDir, sample_name),\n      genome = \"hg38\",\n      max_iter = 10,\n      check_convergence = T\n    )\n  }\n)\nsbatch(slurm_jobs)\n\n\nSimilar to the pileup check, this script verifies the completion of the Numbat runs. It iterates through the Numbat output directories and checks for the existence of the final results file (_final.tsv.gz) for each sample.\n\n\nCode\noutDir &lt;- \"../outputs/scRNAseq_Analysis/Numbat/Numbat_CNV_calling/\"\nsamples &lt;- list.files(outDir, full.names = T)\n\nresults  &lt;- lapply(samples, function(x){\n  sample_name &lt;- gsub(paste0(outDir,\"/\"), \"\", x)\n  processed &lt;- any(grepl(\"_final.tsv.gz\", list.files(x)))\n  return(data.frame(sample_name, processed))\n}) %&gt;% bind_rows()"
  },
  {
    "objectID": "scRNAseq_numbat.html#parse-and-visualize-cnv-results",
    "href": "scRNAseq_numbat.html#parse-and-visualize-cnv-results",
    "title": "CNV Inference using Numbat",
    "section": "6 Parse and Visualize CNV Results",
    "text": "6 Parse and Visualize CNV Results\nAfter running Numbat, the final steps involve parsing the output files to extract meaningful results and creating visualizations to interpret the CNV landscape.\nThis script loads the Numbat output objects (.rds files) for all processed samples. It then extracts and consolidates two key pieces of information: 1. Cell-level metadata: For each cell, it extracts CNV probabilities, clone assignments, and compartment information. 2. Clone-level profiles: It aggregates the CNV data to generate a consensus CNV profile for each identified tumor clone.\nThese consolidated data tables are then saved to disk for downstream analysis and visualization.\n\n\nCode\nsource(\"utils/CNV_analysis.R\")\n\nresultDir &lt;- \"../outputs/scRNAseq_Analysis/Numbat/Numbat_CNV_calling/\"\nsamplesDir &lt;- list.files(resultDir, full.names = T)\nnames(samplesDir) &lt;- gsub(\"../outputs/scRNAseq_Analysis/Numbat/Numbat_CNV_calling/\", \"\", samplesDir)\n\nNumbat_Results &lt;- lapply(samplesDir, function(x){\n  message(paste0(\":: Parsing: \",x))\n  if (any(grepl('_final.tsv.gz',list.files(x)))){\n    message(paste0(\"&gt; CNV results found!\"))\n    nb &lt;- Numbat$new(x, verbose = F)\n  } else {\n    message(paste0(\"&gt; No CNV events found!\"))\n    return(NA)\n  }})\nNumbat_Results &lt;- Numbat_Results[!is.na(Numbat_Results)]\nnames(Numbat_Results) &lt;- gsub(\"//\",\"\", names(Numbat_Results))\n\nsaveRDS(Numbat_Results, \"../outputs/scRNAseq_Analysis/Numbat/parsed_Numbat_results.rds\")\n\n# Generating .seg file ----------------------------------------------------\n\nclones &lt;- lapply(Numbat_Results, function(x){\n  clones &lt;- x$segs_consensus %&gt;%\n    select(sample, CHROM, seg_start, seg_end, cnv_state_post, phi_mle) %&gt;%\n    `colnames&lt;-`(c(\"clone\",\"chrom\", \"loc.start\", \"loc.end\", \"state\",\"seg.mean\"))\n  return(clones)\n}) %&gt;% \n  bind_rows(.id = 'sample')\nclones &lt;- clones %&gt;% filter(!is.na(clone))\nwrite.table(clones, \"../outputs/scRNAseq_Analysis/Numbat/parsed_Numbat_Results/samples_clones.txt\", quote = F, col.names = T, row.names = F, sep = '\\t')\n\nseg &lt;- clones %&gt;% mutate(ID = paste0(sample,\"_\",clone)) %&gt;%\n  select(ID, chrom, loc.start, loc.end, state, seg.mean) %&gt;%\n  mutate(seg.mean = seg.mean - 1)\nwrite.table(seg, \"../outputs/scRNAseq_Analysis/Numbat/parsed_Numbat_Results/samples_clones.seg\", quote = F, col.names = T, row.names = F, sep = '\\t')\n\n# Generating cell-level data ------------------------------------------\n\ncells_metadata &lt;- lapply(Numbat_Results,  function(x){\n  cells_CNV_metadata &lt;- x$clone_post %&gt;%\n    select(cell, p_cnv_x, p_cnv_y, p_cnv, clone_opt, compartment_opt) %&gt;%\n    `colnames&lt;-`(c(\"cell\", \"exp_cnv_prop\", \"allele_cnv_prop\", \"joint_cnv_prop\", \"clone\", \"compartment\"))\n  return(cells_CNV_metadata)\n}) %&gt;%\n  bind_rows(.id = 'sample') %&gt;%\n  select(-sample) %&gt;%\n  data.frame() \n\nwrite.table(cells_metadata, \"../outputs/scRNAseq_Analysis/Numbat/cells_metadata_pancRef.txt\", quote = F, col.names = T, row.names = T, sep = '\\t')\n\n# Generating clone profile data ------------------------------------------\n\nclones_profile &lt;- lapply(Numbat_Results,  function(x){\n\n  ## Extracting clones data\n  clone_profile &lt;- get_clone_profile(x$joint_post, x$clone_post) %&gt;%\n    filter(clone != 1) %&gt;% ## Removing clone one as it is the normal cells\n    mutate(clone = clone - 1) ## changing the name of the clones so it starts with clone 1\n  \n  ## clones CN ratio\n  clone_phi &lt;- x$segs_consensus %&gt;% \n    filter(!(is.na(sample))) %&gt;%\n    select(CHROM, seg_start, seg_end, cnv_state_post, phi_mle) %&gt;%\n    dplyr::rename(cnv_state = cnv_state_post) %&gt;%\n    mutate(log2_phi_mle = log2(phi_mle))\n  \n  ## Merging both dataframes\n  clone_profile &lt;- merge(clone_profile, clone_phi, by = c(\"CHROM\",\"seg_start\",\"seg_end\", \"cnv_state\"))\n  \n  return(clone_profile)\n}) %&gt;% bind_rows(.id = 'sample')\nclones_profile$sample_clone &lt;- paste0(clones_profile$sample, \"_clone_\", clones_profile$clone)\n\nwrite.table(clones_profile, \"../outputs/scRNAseq_Analysis/Numbat/clone_profile.txt\", quote = F, col.names = T, row.names = F, sep = '\\t')"
  },
  {
    "objectID": "scRNAseq_numbat.html#visualize-cnv-results",
    "href": "scRNAseq_numbat.html#visualize-cnv-results",
    "title": "CNV Inference using Numbat",
    "section": "7 Visualize CNV Results",
    "text": "7 Visualize CNV Results\n\n\nCode\nclone_profiles &lt;- read.table(\"../outputs/scRNAseq_Analysis/Numbat/clone_profile.txt\", header = T, sep = '\\t')\nclone_profile &lt;- merge(clone_profiles, tumor@meta.data %&gt;% select(sample_clone, `Cell Type`), by = 'sample_clone')\ncnv_heatmap(clone_profile, var = 'clone')"
  },
  {
    "objectID": "scRNAseq_numbat.html#add-numbat-results",
    "href": "scRNAseq_numbat.html#add-numbat-results",
    "title": "CNV Inference using Numbat",
    "section": "8 Add Numbat Results",
    "text": "8 Add Numbat Results\nThe results are added as metadata to the Seurat object. This enriches the object with information about the predicted ploidy and clonal status of cells.\n\n\nCode\nnumbat_res &lt;- cells_metadata %&gt;%\n  `rownames&lt;-`(NULL) %&gt;%\n  column_to_rownames('cell')\nref &lt;- AddMetaData(ref, numbat_res)\n\n\nWe generate plots to visualize the Numbat results on the UMAP. A DimPlot shows the predicted cell compartments (e.g., â€˜malignantâ€™, â€˜normalâ€™), and a FeaturePlot shows the proportion of the genome affected by CNVs (joint_cnv_prop) for each cell.\n\n\nCode\nDimPlot(ref, group.by = c('compartment'))\nFeaturePlot(ref, features = c('joint_cnv_prop'), order = T)\n\n\n\n\nCode\nsessionInfo()"
  },
  {
    "objectID": "fig3.html",
    "href": "fig3.html",
    "title": "Figure 3",
    "section": "",
    "text": "Code\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratExtend)\n  library(CellChat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(EnhancedVolcano)\n  library(qs)\n  library(SPATA2)\n  library(patchwork)\n  library(pheatmap)\n  library(numbat)\n})\n\nRdYlBu_scale &lt;- scale_color_gradientn(colors = c(\"blue\", \"yellow\", \"red\"))\n\nspatial &lt;- qread(\"../outputs/Spatial_Clustering/tumor_tumoradj_GoL_samples_annotated_v2_lite_new_deconv.qs\")\ncols &lt;- scPalette(length(levels(spatial$main_annotation)))\nnames(cols) &lt;- levels(spatial$main_annotation)\nall_epi &lt;- qread(\"../outputs/Epithelial_Analysis/all_epi_domains.qs\")\nepi &lt;- qread(\"../outputs/Epithelial_Analysis/epi_w_palantir_pseudotime.qs\")\nepi_deseq &lt;- qread(\"../outputs/Epithelial_Analysis/epi_deseq_object.qs\")\nepi_aggregate &lt;- qread(\"../outputs/Epithelial_Analysis/epi_aggregate.qs\")\nepi_pca &lt;- qread(\"../outputs/Epithelial_Analysis/epi_pca.qs\")\nTumorPanIN_vs_GoLPanIN_DE &lt;- read.csv(\"../outputs/Epithelial_Analysis/TumorPanIN_v_GoLPanIN_DEGs.csv\", row.names = 1) %&gt;%  rownames_to_column('gene')\nPDTumor_vs_GoLPanIN_DE &lt;- read.csv(\"../outputs/Epithelial_Analysis/PDTumor_v_GoLPanIN_DEGs.csv\", row.names = 1) %&gt;%  rownames_to_column('gene')\nPDTumor_vs_TumorPanIN_DE &lt;- read.csv(\"../outputs/Epithelial_Analysis/PDTumor_v_TumorPanIN_DEGs.csv\", row.names = 1) %&gt;%  rownames_to_column('gene')\nTumorPanIN_vs_GoLPanIN_GSEA &lt;- qread(\"../outputs/Epithelial_Analysis/TumorPanIN_v_GoLPanIN_GSEA.qs\")\nPDTumor_vs_GoLPanIN_GSEA &lt;- qread(\"../outputs/Epithelial_Analysis/PDTumor_v_GoLPanIN_GSEA.qs\")\nPDTumor_vs_TumorPanIN_GSEA &lt;- qread(\"../outputs/Epithelial_Analysis/PDTumor_v_TumorPanIN_GSEA.qs\")\ntumor_spata2 &lt;- qread(\"../outputs/Misc/tumor_sample_spata2_object.qs\")\ntumor_spata2_2 &lt;- qread(\"../outputs/Misc/SU-21-54126_D2_tumor_sample_spata2_object.qs\")\ngol_spata2 &lt;- qread(\"../outputs/Misc/gol_sample_spata2_object.qs\")\ngol_spata2_2 &lt;- qread(\"../outputs/Misc/AJJB111_B1_gol_sample_spata2_object.qs\")\n\nNoTicks &lt;- theme(axis.ticks = element_blank(), axis.text = element_blank(), axis.title = element_blank())\nthin_margin &lt;- theme(plot.margin = unit(c(0, 0, 0, 0), \"in\"))\n\n# Spatial all epi umap -----------------------------------------------------------------\n\nspatial_all_epi_umap &lt;- DimPlot(\n  all_epi, \n  group.by = c(\"main_annotation\"),\n  cols = cols,\n  pt.size = 3,\n  raster = T,\n  raster.dpi = c(1200,1200)) +\n  NoAxes() +\n  NoLegend() +\n  ggtitle(\"Epithelial Spatial Domains\") +\n  theme(legend.text = element_text(size = 9))\nggsave(\"spatial_all_epi_umap.pdf\", spatial_all_epi_umap, width = 3, height = 3, units = 'in', dpi = 600)\n\nspatial_all_epi_umap_legend &lt;- get_legend(DimPlot(\n  all_epi, \n  group.by = c(\"main_annotation\"),\n  cols = cols,\n  pt.size = 3,\n  raster = T,\n  raster.dpi = c(1200,1200)))\nggsave(\"spatial_all_epi_umap_legend.pdf\", spatial_all_epi_umap_legend, width = 2, height = 2.5, units = 'in', dpi = 600)\n\n# Correlation Heatmap -----------------------------------------------------\n\npearson_cor &lt;- cor(as.matrix(AverageExpression(all_epi, assays = 'Spatial', layer = 'data', group.by = c('tissue', 'main_annotation'))$Spatial), method = 'pearson')\norder &lt;- c(\"GoL_Acinar1\", \"TumorAdj_Acinar1\", \"Tumor_Acinar1\",\n           \"GoL_Acinar2\", \"TumorAdj_Acinar2\", \"Tumor_Acinar2\",\n           \"GoL_Acinar3\",\"TumorAdj_Acinar3\",\"Tumor_Acinar3\",\n           \"GoL_Ducts\", \"TumorAdj_Ducts\", \"Tumor_Ducts\",\n           \"GoL_PanIN/GLTumor\", \"TumorAdj_PanIN/GLTumor\", \"Tumor_PanIN/GLTumor\",\n           \"Tumor_PDTumor\")\nann &lt;- data.frame(str_split_fixed(rownames(pearson_cor), \"_\", 2), row.names = rownames(pearson_cor)) %&gt;%\n  `colnames&lt;-`(c(\"Tissue\", \"Spatial Domain\"))\nann_cols &lt;- list(\"Spatial Domain\" = cols[unique(ann$`Spatial Domain`)],\n                 \"Tissue\" = c(\"GoL\" = \"green4\", \"TumorAdj\" = \"darkblue\", Tumor = \"purple\"))\npheatmap_plot &lt;- pheatmap(pearson_cor[order, order], cluster_rows = F, cluster_cols = F, annotation_row = ann,\n                          annotation_col = ann, gaps_col = c(3, 6, 9, 12, 15), gaps_row = c(3, 6, 9, 12, 15),\n                          annotation_names_col = FALSE, annotation_names_row = FALSE,\n                          annotation_colors = ann_cols, show_rownames = F, show_colnames = F,\n                          color = colorRampPalette(c(\"black\", \"red2\"))(100), fontsize = 10, \n                          cellwidth = 15, cellheight = 15)\nggsave(\"all_epi_corr_heatmap.pdf\", pheatmap_plot, width = 10, height = 10, units = 'in', dpi = 600)\n\n# Basal Vs Classical Markers ----------------------------------------------\n\nclassical_v_basal_markers &lt;- list('Acinar/ADM Markers' = c(\"PRSS1\", \"AMY2A\",\"CFTR\", \"AQP1\"),\n                                  'Ducts Markers' = c(\"MUC5B\", \"CRISP3\", \"PIGR\"),\n                                  'Classical Markers' = c(\"GATA6\", \"MUC1\", \"MUC5AC\", \"TFF1\"),\n                                  'Basal Markers' = c(\"KRT6A\", \"KRT17\", \"S100A2\", \"LAMC2\", \"CAV1\"))\nDefaultAssay(all_epi) &lt;- 'Spatial'\nclassical_v_basal_dotplot &lt;- DotPlot2(all_epi,\n                                      features = classical_v_basal_markers,\n                                      group.by = 'main_annotation',\n                                      color_scheme = 'RdYlBu-rev') +\n  NoLegend()\nggsave(\"classical_v_basal_dotplot.pdf\", classical_v_basal_dotplot, width = 5, height = 6, units = 'in', dpi = 600)\n\nclassical_v_basal_dotplot_legend &lt;- get_legend(DotPlot2(subset(all_epi, subset = main_annotation %in% c(\"Ducts\", \"PanIN/GLTumor\", \"PDTumor\")),\n                                                        features = classical_v_basal_markers,\n                                                        group.by = 'main_annotation',\n                                                        color_scheme = 'RdYlBu-rev'))\nggsave(\"classical_v_basal_dotplot_legend.pdf\", classical_v_basal_dotplot_legend, width = 2, height = 5, units = 'in', dpi = 600)\n\n# SpatialDimPlot Epithelial -----------------------------------------------\n\ntumor_spata2@meta_obs &lt;- mutate(tumor_spata2@meta_obs, annotation = ifelse(main_annotation %in% c(\"Ducts\", \"PDTumor\", \"PanIN/GLTumor\"), as.character(main_annotation), \"Other\"))\ntumor_spata2@meta_obs$annotation &lt;- factor(tumor_spata2@meta_obs$annotation, levels = c(\"Ducts\", \"PanIN/GLTumor\", \"PDTumor\", \"Other\"))\ntumor_panin_pdtumor &lt;- plotSurface(tumor_spata2, color_by = 'annotation', display_image = F, pt_size = 0.3,\n                                   clrp_adjust = c(cols, \"Other\" = 'lightgrey'), pt_alpha = 1) +  thin_margin\nggsave(\"tumor_panin_pdtumor.pdf\", tumor_panin_pdtumor + NoLegend(), width = 3, height = 3, units = 'in', dpi = 1200)\n\ntumor_spata2_2@meta_obs &lt;- mutate(tumor_spata2_2@meta_obs, annotation = ifelse(main_annotation %in% c(\"Ducts\", \"PDTumor\", \"PanIN/GLTumor\"), as.character(main_annotation), \"Other\"))\ntumor_spata2_2@meta_obs$annotation &lt;- factor(tumor_spata2_2@meta_obs$annotation, levels = c(\"Ducts\", \"PanIN/GLTumor\", \"PDTumor\", \"Other\"))\ntumor_panin_pdtumor_2 &lt;- plotSurface(tumor_spata2_2, color_by = 'annotation', display_image = F, pt_size = 0.3,\n                                     clrp_adjust = c(cols, \"Other\" = 'lightgrey'), pt_alpha = 1) +  thin_margin\nggsave(\"tumor_panin_pdtumor_2.pdf\", tumor_panin_pdtumor_2 + NoLegend(), width = 3, height = 3, units = 'in', dpi = 1200)\n\ngol_spata2@meta_obs &lt;- mutate(gol_spata2@meta_obs, annotation = ifelse(main_annotation %in% c(\"Ducts\", \"PanIN/GLTumor\"), as.character(main_annotation), \"Other\"))\ngol_spata2@meta_obs$annotation &lt;- factor(gol_spata2@meta_obs$annotation, levels = c(\"Ducts\", \"PanIN/GLTumor\", \"Other\"))\ngol_duct_panin &lt;- plotSurface(gol_spata2, color_by = 'annotation', display_image = F, pt_size = 0.3,\n                              clrp_adjust = c(cols, \"Other\" = 'lightgrey'), pt_alpha = 1) +  thin_margin\nggsave(\"gol_duct_panin.pdf\", gol_duct_panin + NoLegend(), width = 3, height = 3, units = 'in', dpi = 1200)\n\ngol_spata2_2@meta_obs &lt;- mutate(gol_spata2_2@meta_obs, annotation = ifelse(main_annotation %in% c(\"Ducts\", \"PanIN/GLTumor\"), as.character(main_annotation), \"Other\"))\ngol_spata2_2@meta_obs$annotation &lt;- factor(gol_spata2_2@meta_obs$annotation, levels = c(\"Ducts\", \"PanIN/GLTumor\", \"Other\"))\ngol_duct_panin_2 &lt;- plotSurface(gol_spata2_2, color_by = 'annotation', display_image = F, pt_size = 0.3,\n                                clrp_adjust = c(cols, \"Other\" = 'lightgrey'), pt_alpha = 1) +  thin_margin\nggsave(\"gol_duct_panin_2.pdf\", gol_duct_panin_2 + NoLegend(), width = 3, height = 3, units = 'in', dpi = 1200)\n\ntumor_panin_pdtumor_legend &lt;- get_legend(tumor_panin_pdtumor + theme(legend.position = 'top'))\nggsave(\"tumor_panin_pdtumor_legend.pdf\", tumor_panin_pdtumor_legend, width = 6, height = 2, units = 'in', dpi = 1200)\n\n# MUC5AC MUC5B GoL --------------------------------------------------------\n\ngol_spata2_muc5b_muc5ac &lt;- plotSurfaceComparison(gol_spata2, color_by = c(\"MUC5AC\",\"MUC5B\"), display_image = T, pt_size = 0.5, pt_alpha = 0.7) +  thin_margin\ngol_spata2_muc5b_muc5ac_2 &lt;- plotSurfaceComparison(gol_spata2_2, color_by = c(\"MUC5AC\",\"MUC5B\"), display_image = T, pt_size = 0.5, pt_alpha = 0.7) +  thin_margin\ncombined_gol_spata2_muc5b_muc5ac &lt;- wrap_plots(list(gol_spata2_muc5b_muc5ac + NoLegend(), gol_spata2_muc5b_muc5ac_2 + NoLegend()), nrow = 2) &\n  theme(plot.margin = margin(0, 0, 0, 0))\nggsave(\"combined_gol_spata2_muc5b_muc5ac.pdf\", combined_gol_spata2_muc5b_muc5ac + NoLegend(), width = 5, height = 5, units = 'in', dpi = 1200)\n\ngol_spata2_muc5b_muc5ac_legend &lt;- get_legend(gol_spata2_muc5b_muc5ac)\nggsave(\"combined_gol_spata2_muc5b_muc5ac_legend.pdf\", gol_spata2_muc5b_muc5ac_legend , width = 2, height = 4, units = 'in', dpi = 1200)\n\n# PanIN_to_PDTumor UMAP ---------------------------------------------------------------------\n\ncols_subset &lt;- c(\"Donor_PanIN\" = \"red3\", \"TumorAdj_PanIN\" = \"navy\", \"Tumor_PanIN/GLTumor\" = \"#F29403\", \"PDTumor\" = '#F781BF')\nspatial_epi_umap &lt;- DimPlot(\n  epi, \n  group.by = c(\"new_annotation\"),\n  cols = cols_subset,\n  raster = F) +\n  NoAxes() +\n  NoLegend() +\n  ggtitle('Preneoplastic/Neoplastic Domains')\nggsave(\"spatial_epi_umap.pdf\", spatial_epi_umap, width = 5, height = 2.5, units = 'in', dpi = 1200)\n\nspatial_epi_umap_legend &lt;- get_legend(DimPlot(\n  epi, \n  group.by = c(\"new_annotation\"),\n  cols = cols_subset,\n  raster = F)) \nggsave(\"spatial_epi_umap_legend.pdf\", spatial_epi_umap_legend, width = 2.5, height = 2.5, units = 'in', dpi = 1200)\n\n# Pseudotime heatmap ------------------------------------------------------\n\nspatial_epi_pseudotime &lt;- FeaturePlot(\n  epi, \n  features = c(\"palantir_pseudotime\"),\n  raster = F\n) +\n  scale_color_viridis(option = 'C') +\n  NoAxes() +\n  NoLegend() +\n  ggtitle(\"Pseudotime\")\nggsave(\"spatial_epi_pseudotime.pdf\", spatial_epi_pseudotime, width = 5, height = 2.5, units = 'in', dpi = 1200)\n\nspatial_epi_pseudotime_legend &lt;- get_legend(FeaturePlot(\n  epi, \n  features = c(\"palantir_pseudotime\"),\n  raster = F\n) + scale_color_viridis(option = 'C'))\nggsave(\"spatial_epi_pseudotime_legend.pdf\", spatial_epi_pseudotime_legend, width = 1, height = 2.5, units = 'in', dpi = 1200)\n\n# Epi PCA -----------------------------------------------------------------\n\nepi_pca_plot &lt;- PCAtools::biplot(epi_pca,\n                                 colby = 'new_annotation',\n                                 colkey = cols_subset,\n                                 lab = NULL,\n                                 encircle = T,\n                                 legendTitleSize = 0,\n                                 legendPosition = 'top',\n                                 title = NULL) +\n  ylim(c(-25,40)) + \n  NoLegend()\nggsave(\"epi_pca_plot.pdf\", epi_pca_plot, width = 8, height = 5, units = 'in', dpi = 1200)\n\n# DotPlot Raw Expression --------------------------------------------------\n\nepi_markers_raw_exp &lt;- FindAllMarkers(epi, group.by = 'new_annotation',assay = 'Spatial', only.pos = T)\nepi_markers_raw_exp$score &lt;- epi_markers_raw_exp$avg_log2FC * epi_markers_raw_exp$pct.1\n\ntop_markers &lt;- epi_markers_raw_exp %&gt;%\n  group_by(cluster) %&gt;%\n  top_n(20, wt = score) %&gt;%\n  pull(gene)\n\nepi_dotplot_raw_exp &lt;- DotPlot2(epi, features = unique(top_markers), group.by = 'new_annotation', color_scheme = 'RdYlBu-rev', flip = T)\nggsave(\"epi_dotplot_raw_exp.pdf\", epi_dotplot_raw_exp, width = 15, height = 3, units = 'in', dpi = 1200)\n\nepi_dotplot_raw_exp_selected_genes &lt;- VlnPlot2(epi, features = c(\"AMY2A\", \"PRSS1\", \"COL1A1\", \"FN1\"), group.by = 'new_annotation', box = F, pt = F, cols = cols_subset, ncol = 1)\nggsave(\"epi_dotplot_raw_exp_selected_genes.pdf\", epi_dotplot_raw_exp_selected_genes, width = 4, height = 8, units = 'in', dpi = 1200)\n\nepi_dotplot_raw_exp &lt;- DotPlot(epi, features = c(\"CELA3A\", \"SPINK1\", \"PRSS1\", \"COL1A1\", \"COL1A2\", \"FN1\"), group.by = 'new_annotation', scale = F) +\n  scale_color_viridis(option = 'C') +\n  xlab(NULL) + ylab(NULL) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  coord_flip()\nggsave(\"epi_dotplot_raw_exp_selected_genes.pdf\", epi_dotplot_raw_exp + NoLegend(), width = 3, height = 4, units = 'in', dpi = 1200)\n\nggsave(\"epi_dotplot_raw_exp_selected_genes_legend.pdf\", get_legend(epi_dotplot_raw_exp), width = 4, height = 8, units = 'in', dpi = 1200)\n\n# TumorPanIN_v_GoLPanIN_VP ------------------------------------------------\n\ngenes_to_highlight &lt;- c(\"GKN1\", \"GKN2\", \"IL33\", \"NKX6-2\", \"MUC5AC\", \"TFF1\",\n                        \"KLK6\", \"KLK7\",\"KLK8\", \"LY6E\", \"SLC2A1\", \"CD55\", \"PADI1\")\n\nTumorPanIN_vs_GoLPanIN_DE &lt;- TumorPanIN_vs_GoLPanIN_DE %&gt;%\n  mutate(\n    sig = case_when(\n      padj &lt; 0.05 & log2FoldChange &gt;=  0.5 ~ \"Up\",\n      padj &lt; 0.05 & log2FoldChange &lt;= -0.5 ~ \"Down\",\n      TRUE ~ \"NS\"\n    ),\n    highlight = ifelse(gene %in% genes_to_highlight, TRUE, FALSE)\n  )\n\nTumorPanIN_vs_GoLPanIN_VP &lt;- ggplot(TumorPanIN_vs_GoLPanIN_DE, aes(x = log2FoldChange, y = -log10(padj))) +\n  geom_point(aes(color = sig, size = sqrt(baseMean), alpha = sqrt(baseMean))) +\n  geom_text_repel(\n    data = subset(TumorPanIN_vs_GoLPanIN_DE, highlight),\n    aes(label = gene),\n    color = \"black\",\n    max.overlaps = Inf,\n    size = 5,\n    box.padding = 1, \n  ) +\n  geom_vline(xintercept = c(-0.5, 0.5), linetype = \"dashed\") +\n  geom_hline(yintercept = -log10(0.05), linetype = \"dashed\") +\n  scale_color_manual(values = c(Down = \"dodgerblue3\", Up = \"firebrick\", NS = \"grey70\")) +\n  scale_size_continuous(range = c(0.5, 5)) +\n  scale_alpha_continuous(range = c(0.3, 0.9), guide = \"none\") +\n  labs(\n    x = \"log2 Fold Change\",\n    y = \"-log10(p-adjusted)\",\n    color = \"\",\n    title = NULL\n  ) +\n  ylim(c(0,70)) +\n  theme_bw(base_size = 10) +\n  NoLegend() + \n  ggbreak::scale_y_break(c(15,68), space = 0)\n\nggsave(\"TumorPanIN_vs_GoLPanIN_VP.pdf\", TumorPanIN_vs_GoLPanIN_VP, width = 10, height = 5, units = 'in', dpi = 1200)\n\n# PDtumor_v_TumorPanIN_VP ------------------------------------------------\n\ngenes_to_highlight &lt;- c(\"KRT6A\", \"CST6\", \"KRT17\", \"WNT7A\", \"LAMC2\",\"TGM2\",\n                        \"KCNE3\", \"REG4\", \"PPP1R1B\",\"AGR2\", \"OLFM4\")\n\nPDTumor_vs_TumorPanIN_DE &lt;- PDTumor_vs_TumorPanIN_DE %&gt;%\n  mutate(\n    sig = case_when(\n      padj &lt; 0.05 & log2FoldChange &gt;=  0.5 ~ \"Up\",\n      padj &lt; 0.05 & log2FoldChange &lt;= -0.5 ~ \"Down\",\n      TRUE ~ \"NS\"\n    ),\n    highlight = ifelse(gene %in% genes_to_highlight, TRUE, FALSE)\n  )\n\nPDTumor_vs_TumorPanIN_VP &lt;- ggplot(PDTumor_vs_TumorPanIN_DE, aes(x = log2FoldChange, y = -log10(padj))) +\n  geom_point(aes(color = sig, size = sqrt(baseMean), alpha = sqrt(baseMean))) +\n  geom_text_repel(\n    data = subset(PDTumor_vs_TumorPanIN_DE, highlight),\n    aes(label = gene),\n    color = \"black\",\n    max.overlaps = Inf,\n    size = 5,\n    box.padding = 1, \n  ) +\n  geom_vline(xintercept = c(-0.5, 0.5), linetype = \"dashed\") +\n  geom_hline(yintercept = -log10(0.05), linetype = \"dashed\") +\n  scale_color_manual(values = c(Down = \"dodgerblue3\", Up = \"firebrick\", NS = \"grey70\")) +\n  scale_size_continuous(range = c(0.5, 5)) +\n  scale_alpha_continuous(range = c(0.3, 0.9), guide = \"none\") +\n  labs(\n    x = \"log2 Fold Change\",\n    y = \"-log10(p-adjusted)\",\n    color = \"\",\n    title = NULL\n  ) +\n  ylim(c(0,60)) +\n  theme_bw(base_size = 10) +\n  NoLegend() +\n  ggbreak::scale_y_break(c(40,50), space = 0)\n\nggsave(\"PDTumor_vs_TumorPanIN_VP.pdf\", PDTumor_vs_TumorPanIN_VP, width = 10, height = 5, units = 'in', dpi = 1200)\n\n# TumorPanINvGoLPanIN_GSEA_RidgePlot ------------------------------------------------\n\npathways &lt;- c(\"INTERFERON_ALPHA_RESPONSE\", \"INTERFERON_GAMMA_RESPONSE\", \"INFLAMMATORY_RESPONSE\", \"TNFA_SIGNALING_VIA_NFKB\", \"EPITHELIAL_MESENCHYMAL_TRANSITION\", \"HYPOXIA\", \"KRAS_SIGNALING_UP\",\n              \"OXIDATIVE_PHOSPHORYLATION\", \"FATTY_ACID_METABOLISM\", \"ADIPOGENESIS\", \"BILE_ACID_METABOLISM\")\nTumorPanINvGoLPanIN_ridgeplot &lt;- ridgeplot(TumorPanIN_vs_GoLPanIN_GSEA, showCategory = pathways, decreasing = F) + \n  theme(axis.text.y = element_text(size = 8),\n        axis.text.x = element_text(size = 6),\n        legend.title = element_text(size = 6),\n        legend.text = element_text(size = 6))\nggsave(\"TumorPanINvGoLPanIN_ridgeplot.pdf\", TumorPanINvGoLPanIN_ridgeplot, width = 7, height = 3, units = 'in', dpi = 1200)\n\nplot_df &lt;- TumorPanIN_vs_GoLPanIN_GSEA %&gt;% \n  data.frame() %&gt;%\n  select(ID, NES, p.adjust) %&gt;%\n  filter(ID %in% pathways)\nTumorPanINvGoLPanIN_barplot &lt;- ggplot(plot_df, aes(x = reorder(ID, NES), y = NES, fill = p.adjust)) +\n  geom_col() +\n  coord_flip() +\n  scale_fill_gradient(low = \"red\", high = \"blue\", name = \"p-adj\") +\n  theme_minimal() +\n  labs(x = NULL, y = \"Normalized Enrichment Score (NES)\") +\n  theme(\n    panel.grid = element_blank(),\n    axis.text.y = element_text(size = 10)\n  )\nggsave(\"TumorPanINvGoLPanIN_barplot.pdf\", TumorPanINvGoLPanIN_barplot, width = 7, height = 3, units = 'in', dpi = 1200)\n\n\n# PDtumor_v_TumorPanIN_GSEA_RidgePlot ------------------------------------------------\n\npathways &lt;- c(\"INTERFERON_ALPHA_RESPONSE\", \"INTERFERON_GAMMA_RESPONSE\", \"INFLAMMATORY_RESPONSE\", \"TNFA_SIGNALING_VIA_NFKB\", \"EPITHELIAL_MESENCHYMAL_TRANSITION\",\"KRAS_SIGNALING_UP\",\n              \"IL6_JAK_STAT3_SIGNALING\",\n              \"OXIDATIVE_PHOSPHORYLATION\", \"FATTY_ACID_METABOLISM\", \"E2F_TARGETS\", \"G2M_CHECKPOINT\")\n\nPDTumorvTumorPanIN_ridgeplot &lt;- ridgeplot(PDTumor_vs_TumorPanIN_GSEA, showCategory = pathways, decreasing = F) + \n  theme(axis.text.y = element_text(size = 8),\n        axis.text.x = element_text(size = 6),\n        legend.title = element_text(size = 6),\n        legend.text = element_text(size = 6))\nggsave(\"PDTumorvTumorPanIN_ridgeplot.pdf\", PDTumorvTumorPanIN_ridgeplot, width = 7, height = 3, units = 'in', dpi = 1200)\n\nplot_df &lt;- PDTumor_vs_TumorPanIN_GSEA %&gt;% \n  data.frame() %&gt;%\n  select(ID, NES, p.adjust) %&gt;%\n  filter(ID %in% pathways)\nPDTumor_vs_TumorPanIN_barplot &lt;- ggplot(plot_df, aes(x = reorder(ID, NES), y = NES, fill = p.adjust)) +\n  geom_col() +\n  coord_flip() +\n  scale_fill_gradient(low = \"red\", high = \"blue\", name = \"p-adj\") +\n  theme_minimal() +\n  labs(x = NULL, y = \"Normalized Enrichment Score (NES)\") +\n  theme(\n    panel.grid = element_blank(),\n    axis.text.y = element_text(size = 10)\n  )\nggsave(\"PDTumor_vs_TumorPanIN_barplot.pdf\", PDTumor_vs_TumorPanIN_barplot, width = 7, height = 3, units = 'in', dpi = 1200)\n\n\n# Plot Leading Edge -------------------------------------------------------\n\nepi_aggregate_subset &lt;- subset(epi_aggregate, subset = new_annotation != 'TumorAdj_PanIN')\nepi_aggregate_subset@assays$epiexp@data &lt;- rlog(as.matrix(epi_aggregate_subset@assays$epiexp@counts))\nepi_aggregate_subset &lt;- ScaleData(epi_aggregate_subset)\n\npathway &lt;- \"MYC_TARGETS_V2\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\n\npathway &lt;- \"OXIDATIVE_PHOSPHORYLATION\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n        lab_fill = 'zscore',\n        facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"FATTY_ACID_METABOLISM\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"BILE_ACID_METABOLISM\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"E2F_TARGETS\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"G2M_CHECKPOINT\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"INTERFERON_ALPHA_RESPONSE\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"EPITHELIAL_MESENCHYMAL_TRANSITION\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"TNFA_SIGNALING_VIA_NFKB\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"HYPOXIA\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"KRAS_SIGNALING_UP\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)\n\npathway &lt;- \"IL6_JAK_STAT3_SIGNALING\"\nleading_edge1 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge2 &lt;- TumorPanIN_vs_GoLPanIN_GSEA@result %&gt;% \n  filter(ID == pathway) %&gt;%\n  pull(core_enrichment) %&gt;%\n  strsplit(\"/\") %&gt;% \n  unlist()\nleading_edge &lt;- unique(leading_edge1, leading_edge2)\ntoplot &lt;- CalcStats(epi_aggregate_subset, assay = 'epiexp', features = leading_edge)\nplot &lt;- Heatmap(toplot,\n                lab_fill = 'zscore',\n                facet_col = epi_aggregate_subset$new_annotation) +\n  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 10, face = 'bold')) +\n  ggtitle(pathway)\nggsave(filename = paste0(\"\", pathway, \"_leading_edge_epi_gsea.pdf\"), plot, width = 7, height = 10, dpi = 300)"
  },
  {
    "objectID": "scRNAseq_fibro.html",
    "href": "scRNAseq_fibro.html",
    "title": "scRNAseq Fibroblast Subpopulation Analysis",
    "section": "",
    "text": "This section focuses on a detailed sub-analysis of the fibroblast population. We subset the fibroblast cells from the main dataset, reclustered them to identify distinct fibroblast subtypes."
  },
  {
    "objectID": "scRNAseq_fibro.html#setup-and-environment-configuration",
    "href": "scRNAseq_fibro.html#setup-and-environment-configuration",
    "title": "scRNAseq Fibroblast Subpopulation Analysis",
    "section": "1 Setup and Environment Configuration",
    "text": "1 Setup and Environment Configuration\n\n\nCode\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratWrappers)\n  library(tidyverse)\n  library(scCustomize)\n  library(CellChat)\n  library(slurmR)\n  library(tidyverse)\n  library(reticulate)\n  library(qs)\n  library(clustree)\n  library(org.Hs.eg.db)\n  library(CoGAPS)\n  library(Seurat)\n  library(slurmR)\n  library(cowplot)\n  library(tidyverse)\n  library(pheatmap)\n  library(qs)\n})\n\nref &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef.qs\")"
  },
  {
    "objectID": "scRNAseq_fibro.html#subset-and-re-cluster-fibroblasts",
    "href": "scRNAseq_fibro.html#subset-and-re-cluster-fibroblasts",
    "title": "scRNAseq Fibroblast Subpopulation Analysis",
    "section": "2 Subset and Re-cluster Fibroblasts",
    "text": "2 Subset and Re-cluster Fibroblasts\n\n\nCode\nfibro &lt;- subset(ref, subset = main_annotation_scvi == 'Fibroblasts')\nsamples_keep &lt;- names(table(fibro$sample_id))[table(fibro$sample_id) &gt; 10]\nfibro$sample_id &lt;- factor(as.character(fibro$sample_id))\nfibro &lt;- subset(fibro, subset = sample_id %in% samples_keep)\nfibro &lt;- RunUMAP(fibro, reduction = 'integrated.scvi', dims = 1:30)\nfibro &lt;- FindNeighbors(fibro, reduction = 'integrated.scvi', dims = 1:30)\nres &lt;- seq(from = 0.05, to = 1, by = 0.05)\nfor (x in res) {\n  fibro &lt;- FindClusters(fibro, resolution = x, cluster.name = paste0(\"res.\", x))\n}\nclustree(fibro, prefix = 'res.', layout = \"sugiyama\")\nfibro &lt;- FindClusters(fibro, resolution = 0.2)\nfibro &lt;- JoinLayers(fibro)"
  },
  {
    "objectID": "scRNAseq_fibro.html#annotate-fibroblast-subtypes",
    "href": "scRNAseq_fibro.html#annotate-fibroblast-subtypes",
    "title": "scRNAseq Fibroblast Subpopulation Analysis",
    "section": "3 Annotate Fibroblast Subtypes",
    "text": "3 Annotate Fibroblast Subtypes\n\n\nCode\nmarkers &lt;- FindAllMarkers(fibro)\nmarkers$scores &lt;- markers$avg_log2FC * markers$pct.1\nfibro &lt;- subset(fibro, subset = seurat_clusters %in% c(0, 2, 3, 4, 5, 6, 7))\nfibro &lt;- RunUMAP(fibro, reduction = 'integrated.scvi', dims = 1:30)\nnew_idents &lt;- c(\n  '0' = 'IGF1+_Fibro',\n  '2' = 'SFRP4+_Fibro',\n  '3' = 'LRRC15+_Fibro',\n  '4' = 'RORA+_Fibro',\n  '5' = 'HAS1+_Fibro',\n  '6' = 'COL1A1+_Fibro',\n  '7' = 'CD74+_Fibro'\n)\nfibro &lt;- RenameIdents(fibro, new_idents)\nfibro$fibro_subtypes &lt;- Idents(fibro)\nfibro$fibro_subtypes &lt;- factor(\n  fibro$fibro_subtypes,\n  levels = c(\n    'IGF1+_Fibro',\n    'HAS1+_Fibro',\n    'COL1A1+_Fibro',\n    'LRRC15+_Fibro',\n    'SFRP4+_Fibro',\n    'RORA+_Fibro',\n    'CD74+_Fibro'\n  )\n)\nqsave(fibro, \"../outputs/scRNAseq_Analysis/scRef_fibro.qs\")\n\n\n\n\nCode\nref &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef_fibro.qs\")\n\n\n\n\nCode\ncols &lt;- scPalette(length(unique(fibro$fibro_subtypes)))\nnames(cols) &lt;- levels(fibro$fibro_subtypes)\nDimPlot(fibro, group.by = 'fibro_subtypes', cols = cols) +\n  ggtitle(\"scRNAseq Fibroblasts Subtypes\")\n\nmarkers &lt;- FindAllMarkers(fibro, group.by = 'fibro_subtypes')\nmarkers$scores &lt;- markers$avg_log2FC * markers$pct.1\ntop_markers &lt;- markers %&gt;%\n  group_by(cluster) %&gt;%\n  top_n(n = 30, wt = scores) %&gt;%\n  dplyr::select(cluster, gene) %&gt;%\n  split(.$cluster) %&gt;%\n  lapply(pull, gene)\n\n\n\n\nCode\nsessionInfo()"
  },
  {
    "objectID": "fig6.html",
    "href": "fig6.html",
    "title": "Figure 6",
    "section": "",
    "text": "Code\n# Setup ----\n\nsetwd(dirname(rstudioapi::getSourceEditorContext()$path))\n\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratExtend)\n  library(CellChat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(EnhancedVolcano)\n  library(qs)\n  library(sf)\n  library(SPATA2)\n  library(patchwork)\n  library(pheatmap)\n  library(numbat)\n})\n\n# Improting data ----\n\nfiorini_data &lt;- qread(\"../outputs/Xenium/xenium_data_fiorini_et_al/outputs/xenium_obj_harmony_integrated_w_fibro_scores.qs\")\nfiorini_data_rdist &lt;- qread(\"../outputs/Xenium/xenium_data_fiorini_et_al/outputs/xenium_obj_harmony_integrated_w_rdist.qs\")\nfiorini_data &lt;- AddMetaData(fiorini_data, metadata = fiorini_data_rdist@meta.data %&gt;% select(r_dist_Tumor, r_dist_Tumor_sqrt))\nvr01_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_fiorini_et_al/outputs/VR01_cells_geometry.qs\")\nvr06_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_fiorini_et_al/outputs/VR06_cells_geometry.qs\")\nvr23_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_fiorini_et_al/outputs/VR23_cells_geometry.qs\")\n\nbell_data &lt;- qread(\"../outputs/Xenium/xenium_data_bell_et_al/outputs/xenium_obj_harmony_integrated_w_fibro_scores.qs\")\nbell_data_rdist &lt;- qread(\"../outputs/Xenium/xenium_data_bell_et_al/outputs/xenium_obj_harmony_integrated_w_rdist.qs\")\nbell_data &lt;- AddMetaData(bell_data, metadata = bell_data_rdist@meta.data %&gt;% select(r_dist_PanIN_sqrt, r_dist_MUC5AC._PanIN_sqrt, r_dist_KRT17._PanIN_sqrt, r_dist_Ducts_sqrt))\nPanIN1131_S1A_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_bell_et_al/outputs/PanIN1131_S1A_cells_geometry.qs\")\nPanIN1131_S1C_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_bell_et_al/outputs/PanIN1131_S1C_cells_geometry.qs\")\nPanIN1132_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_bell_et_al/outputs/PanIN1132_cells_geometry.qs\")\nPanIN1134_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_bell_et_al/outputs/PanIN1134_cells_geometry.qs\")\nPanIN1144_polygons &lt;- qread(\"../outputs/Xenium/xenium_data_bell_et_al/outputs/PanIN1144_cells_geometry.qs\")\n\nfibro2_v_fibro2_DEGs &lt;- read.csv(\"../outputs/Fibroblasts_Analysis/stroma2_v_stroma3_DEGs.csv\", row.names = 1)\n\ncellTypes &lt;- unique(c(levels(fiorini_data$annotation), levels(bell_data$annotation)))\n# cols &lt;- scPalette(14)\ncols &lt;- c(\"#984EA3\",\"#377EB8\",\"#B2DF8A\",\"#E41A1C\",\"#F29403\",\"#F781BF\",\"#BC9DCC\",\"#2DAF5A\",\"#1B9E77\",\"#A65628\",\"#54B0E4\",\"#222F75\",\"#984EA3\",\"#FB9A99\")\nnames(cols) &lt;-  cellTypes\ncols['PanIN/Tumor'] &lt;- cols['Tumor']\n\n# all_cells_UMAP ----------------------------------------------------------\n\nbell_data_all_cells_dimplot &lt;- DimPlot(\n  bell_data,\n  group.by = \"annotation\",\n  cols = cols,\n  raster = T,\n  raster.dpi = c(1200,1200),\n  pt.size = 2) +\n  ggtitle(NULL) +\n  NoAxes() +\n  ggtitle(\"Bell et al Xenium Dataset (5 samples, 423018 cells)\")\nggsave(\"bell_data_all_cells_dimplot.pdf\", bell_data_all_cells_dimplot, width = 5, height = 5, dpi = 1200)\n\nbell_data$annotation2 &lt;- ifelse(bell_data$annotation == 'PanIN/Tumor', as.character(bell_data$sub_annotation), as.character(bell_data$annotation))\nbell_data_all_cells_dimplot_sub_annotation &lt;- DimPlot(\n  bell_data,\n  group.by = \"annotation2\",\n  cols = c(cols, \"KRT17+_PanIN\" = \"#984EA3\", \"MUC5AC+_PanIN\" = 'black'),\n  raster = T,\n  raster.dpi = c(1200,1200),\n  pt.size = 2) +\n  ggtitle(NULL) +\n  NoAxes() +\n  ggtitle(\"Bell et al Xenium Dataset (5 samples, 423018 cells)\")\nggsave(\"bell_data_all_cells_dimplot_sub_annotation.pdf\", bell_data_all_cells_dimplot_sub_annotation, width = 5, height = 5, dpi = 1200)\n\nfiorini_data_all_cells_dimplot &lt;- DimPlot(\n  fiorini_data,\n  group.by = \"annotation\",\n  cols = cols,\n  raster = T,\n  raster.dpi = c(1200,1200),\n  pt.size = 2) +\n  ggtitle(NULL) +\n  NoAxes() +\n  ggtitle(\"Fiorini et al Xenium Dataset (3 samples, 483858 cells)\")\nggsave(\"fiorini_data_all_cells_dimplot.pdf\", fiorini_data_all_cells_dimplot, width = 5, height = 5, dpi = 1200)\n\n# All samples polygon plots -----------------------------------------------\n\nPanIN1131_S1A_plot &lt;- ggplot(PanIN1131_S1A_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, size = 1)) +\n  ggtitle(\"PanIN1131_S1A\") +\n  NoLegend()\nggsave(\"PanIN1131_S1A_plot.pdf\", PanIN1131_S1A_plot, width = 5, height = 5, dpi = 1200)\n\nPanIN1131_S1C_plot &lt;- ggplot(PanIN1131_S1C_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, linewidth = 1)) +\n  ggtitle(\"PanIN1131_S1C\") +\n  NoLegend()\nggsave(\"PanIN1131_S1C_plot.pdf\", PanIN1131_S1C_plot, width = 10, height = 5, dpi = 1200)\n\nPanIN1132_plot &lt;- ggplot(PanIN1132_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, size = 1)) +\n  ggtitle(\"PanIN1132\") +\n  NoLegend()\nggsave(\"PanIN1132_plot.pdf\", PanIN1132_plot, width = 5, height = 5, dpi = 1200)\n\nPanIN1134_plot &lt;- ggplot(PanIN1134_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, size = 1)) +\n  ggtitle(\"PanIN1134\") +\n  NoLegend()\nggsave(\"PanIN1134_plot.pdf\", PanIN1134_plot, width = 5, height = 5, dpi = 1200)\n\nPanIN1144_plot &lt;- ggplot(PanIN1144_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, size = 1)) +\n  ggtitle(\"PanIN1144\") +\n  NoLegend()\nggsave(\"PanIN1144_plot.pdf\", PanIN1144_plot, width = 5, height = 5, dpi = 1200)\n\nvr01_plot &lt;- ggplot(vr01_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, size = 1)) +\n  ggtitle(\"VR01\") +\n  NoLegend()\nggsave(\"vr01_plot.pdf\", vr01_plot, width = 5, height = 5, dpi = 1200)\n\nvr06_plot &lt;- ggplot(vr06_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, size = 1)) +\n  ggtitle(\"VR06\") +\n  NoLegend()\nggsave(\"vr06_plot.pdf\", vr06_plot, width = 5, height = 5, dpi = 1200)\n\nvr23_plot &lt;- ggplot(vr23_polygons) +\n  rasterise(geom_sf(aes(fill = annotation), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = cols) +\n  theme_void() +\n  theme(panel.border = element_rect(color = 'black', fill = NA, size = 1)) +\n  ggtitle(\"VR23\") +\n  NoLegend()\nggsave(\"vr23_plot.pdf\", vr23_plot, width = 5, height = 5, dpi = 1200)\n\n# Signatures --------------------------------------------------------------\n\nfibro_sig_cols &lt;- c('fibro2_score_scaled' = \"#A65628\", 'fibro3_score_scaled' = \"#54B0E4\")\n\nfiorini_sig_trends &lt;- fiorini_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_Tumor_sqrt &gt; 0) |&gt;\n  select(fibro2_score_scaled, fibro3_score_scaled, r_dist_Tumor_sqrt) |&gt;\n  pivot_longer(c(\"fibro2_score_scaled\", \"fibro3_score_scaled\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_Tumor_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from Tumor)\") + ylab(\"Fibroblast-specific Fibro2/3 Score\") +\n  scale_color_manual(values = fibro_sig_cols) +\n  theme_bw()\nggsave(\"fiorini_sig_trends.pdf\", fiorini_sig_trends, width = 7, height = 5, dpi = 1200)\n\nbell_sig_trends &lt;- bell_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  select(fibro2_score_scaled, fibro3_score_scaled, r_dist_PanIN_sqrt) |&gt;\n  pivot_longer(c(\"fibro2_score_scaled\", \"fibro3_score_scaled\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_PanIN_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from PanIN/Tumor)\") + ylab(\"Fibroblast-specific Fibro2/3 Score\") +\n  scale_color_manual(values = fibro_sig_cols) +\n  theme_bw()\nggsave(\"bell_sig_trends.pdf\", bell_sig_trends, width = 7, height = 5, dpi = 1200)\n\n\nbell_muc5ac_sig_trends &lt;- bell_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_MUC5AC._PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  select(fibro2_score_scaled, fibro3_score_scaled, r_dist_MUC5AC._PanIN_sqrt) |&gt;\n  pivot_longer(c(\"fibro2_score_scaled\", \"fibro3_score_scaled\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_MUC5AC._PanIN_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from MUC5AC+ PanIN/Tumor)\") + ylab(\"Fibroblast-specific Fibro2/3 Score\") +\n  scale_color_manual(values = fibro_sig_cols) +\n  ylim(c(0.3, 0.7)) +\n  theme_bw()\nggsave(\"bell_muc5ac_sig_trends.pdf\", bell_muc5ac_sig_trends + NoLegend(), width = 6, height = 5, dpi = 1200)\n\nbell_krt17_sig_trends &lt;- bell_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_KRT17._PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  select(fibro2_score_scaled, fibro3_score_scaled, r_dist_KRT17._PanIN_sqrt) |&gt;\n  pivot_longer(c(\"fibro2_score_scaled\", \"fibro3_score_scaled\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_KRT17._PanIN_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from KRT17+ PanIN/Tumor)\") + ylab(\"Fibroblast-specific Fibro2/3 Score\") +\n  scale_color_manual(values = fibro_sig_cols) +\n  theme_bw()\nggsave(\"bell_krt17_sig_trends.pdf\", bell_krt17_sig_trends + NoLegend(), width = 6, height = 5, dpi = 1200)\n\nbell_krt17_sig_trends_legend &lt;- get_legend(bell_krt17_sig_trends)\nggsave(\"bell_krt17_sig_trends_legend.pdf\", bell_krt17_sig_trends_legend, width = 2, height = 5, dpi = 1200)\n\n\nfiorini_polarization_trends &lt;- fiorini_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_Tumor_sqrt &gt; 0) |&gt;\n  select(fibro_combined_score, r_dist_Tumor_sqrt) |&gt;\n  pivot_longer(c(\"fibro_combined_score\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_Tumor_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2, color = 'black') +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from Tumor)\") + ylab(\"log(Scaled Fibro2 Sig Score / Scaled Fibro3 Sig Score)\") +\n  theme_bw()\nggsave(\"fiorini_polarization_trends.pdf\", fiorini_polarization_trends, width = 5, height = 5, dpi = 1200)\n\nbell_muc5ac_polarization_trends &lt;- bell_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_MUC5AC._PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  select(fibro_combined_score, r_dist_MUC5AC._PanIN_sqrt) |&gt;\n  pivot_longer(c(\"fibro_combined_score\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_MUC5AC._PanIN_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2, color = 'black') +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from MUC5AC+ PanIN/Tumor)\") + ylab(\"log(Scaled Fibro2 Sig Score / Scaled Fibro3 Sig Score)\") +\n  theme_bw()\nggsave(\"bell_muc5ac_polarization_trends.pdf\", bell_muc5ac_polarization_trends, width = 5, height = 5, dpi = 1200)\n\nbell_KRT17_polarization_trends &lt;- bell_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_KRT17._PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  select(fibro_combined_score, r_dist_KRT17._PanIN_sqrt) |&gt;\n  pivot_longer(c(\"fibro_combined_score\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_KRT17._PanIN_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2, color = 'black') +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from KRT17+ PanIN/Tumor)\") + ylab(\"log(Scaled Fibro2 Sig Score / Scaled Fibro3 Sig Score)\") +\n  theme_bw()\nggsave(\"bell_KRT17_polarization_trends.pdf\", bell_KRT17_polarization_trends, width = 5, height = 5, dpi = 1200)\n\nbell_polarization_trends &lt;- bell_data[[]] |&gt;\n  filter(annotation == 'Fibroblasts' & r_dist_PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  select(fibro_combined_score, r_dist_PanIN_sqrt) |&gt;\n  pivot_longer(c(\"fibro_combined_score\"), names_to = \"Signature\", values_to = \"Score\") |&gt;\n  ggplot(aes(r_dist_PanIN_sqrt, Score, color = Signature)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), linewidth = 2, color = 'black') +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  xlab(\"sqrt(Radial Distance from Tumor)\") + ylab(\"log(Scaled Fibro2 Sig Score / Scaled Fibro3 Sig Score)\") +\n  theme_bw()\nggsave(\"bell_polarization_trends.pdf\", bell_polarization_trends, width = 5, height = 5, dpi = 1200)\n\n# genes --------------------------------------------------------------\n\nfiorini_fibro2_sig &lt;- c(\"ACTA2\", \"LOXL2\", \"COL5A2\", \"THBS2\", \"MFAP5\", \"INHBA\")\nfiorini_fibro2_sig_cols &lt;- scPalette(length(fiorini_fibro2_sig))\nnames(fiorini_fibro2_sig_cols) &lt;- fiorini_fibro2_sig\nfiorini_fibro2_genes_trends &lt;- fiorini_data[[]] |&gt; \n  bind_cols(FetchData(fiorini_data, vars = fiorini_fibro2_sig)) |&gt; \n  filter(annotation == 'Fibroblasts' & r_dist_Tumor_sqrt &gt; 0) |&gt;\n  pivot_longer(all_of(fiorini_fibro2_sig), names_to = \"Gene\", values_to = \"Expression\") |&gt; \n  ggplot(aes(r_dist_Tumor_sqrt, Expression, color = Gene)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\")) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  scale_color_manual(values = fiorini_fibro2_sig_cols) +\n  xlab(\"sqrt(Radial Distance from Tumor)\") + ylab(\"Fibroblasts-specific Expression\") +\n  theme_bw()\nggsave(\"fiorini_fibro2_genes_trends.pdf\", fiorini_fibro2_genes_trends, width = 7, height = 5, dpi = 1200)\n\nfiorini_fibro3_sig &lt;- c(\"CRISPLD2\", \"STEAP4\", \"CCL19\", \"PTN\",\"TNC\", \"MYC\",\"EDNRB\",\"TFPI\",\"EGFR\",\"PTGDS\",\"RSPO3\",\"FBLN1\",\"PDGFRA\",\"DPT\", \"RSPO1\",\"C7\",\"MEDAG\",\"MAMDC2\", \"OGN\")\nfiorini_fibro3_sig_cols &lt;- scPalette(length(fiorini_fibro3_sig))\nnames(fiorini_fibro3_sig_cols) &lt;- fiorini_fibro3_sig\nfiorini_fibro3_genes_trends &lt;- fiorini_data[[]] |&gt; \n  bind_cols(FetchData(fiorini_data, vars = fiorini_fibro3_sig)) |&gt; \n  filter(annotation == 'Fibroblasts' & r_dist_Tumor_sqrt &gt; 0) |&gt;\n  pivot_longer(all_of(fiorini_fibro3_sig), names_to = \"Gene\", values_to = \"Expression\") |&gt; \n  ggplot(aes(r_dist_Tumor_sqrt, Expression, color = Gene)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\")) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  scale_color_manual(values = fiorini_fibro3_sig_cols) +\n  xlab(\"sqrt(Radial Distance from Tumor)\") + ylab(\"Fibroblasts-specific Expression\") +\n  theme_bw()\nggsave(\"fiorini_fibro3_genes_trends.pdf\", fiorini_fibro3_genes_trends, width = 7, height = 5, dpi = 1200)\n\nbell_fibro2_sig &lt;- c(\"MMP11\", \"MFAP5\", \"GJB2\", \"CTHRC1\", \"INHBA\", \"POSTN\", \"FAP\", \"ACTA2\", \"MYL9\", \"TPM2\")\nbell_fibro2_sig_cols &lt;- scPalette(length(bell_fibro2_sig))\nnames(bell_fibro2_sig_cols) &lt;- bell_fibro2_sig\nbell_fibro2_genes_trends &lt;- bell_data[[]] |&gt; \n  bind_cols(FetchData(bell_data, vars = bell_fibro2_sig)) |&gt; \n  filter(annotation == 'Fibroblasts' & r_dist_PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  pivot_longer(all_of(bell_fibro2_sig), names_to = \"Gene\", values_to = \"Expression\") |&gt; \n  ggplot(aes(r_dist_PanIN_sqrt, Expression, color = Gene)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\")) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  scale_color_manual(values = bell_fibro2_sig_cols) +\n  xlab(\"sqrt(Radial Distance from PanIN/Tumor)\") + ylab(\"Fibroblasts-specific Expression\") +\n  theme_bw()\nggsave(\"bell_fibro2_genes_trends.pdf\", bell_fibro2_genes_trends, width = 7, height = 5, dpi = 1200)\n\nbell_fibro3_sig &lt;- c(\"CXCL12\", \"CCDC80\", \"ADH1B\", \"DCLK1\", \"HAS1\", \"FBLN1\", \"PDGFRA\", \"DPT\", \"EGFR\", \"PTN\", \"CRISPLD2\", \"PTGDS\", \"IGF1\")\nbell_fibro3_sig_cols &lt;- scPalette(length(bell_fibro3_sig))\nnames(bell_fibro3_sig_cols) &lt;- bell_fibro3_sig\nbell_fibro3_genes_trends &lt;- bell_data[[]] |&gt; \n  bind_cols(FetchData(bell_data, vars = bell_fibro3_sig)) |&gt; \n  filter(annotation == 'Fibroblasts' & r_dist_PanIN_sqrt &gt; 0) |&gt;\n  filter(sample_id %in% c(\"PanIN1132\",\"PanIN1134\",\"PanIN1144\")) |&gt;\n  pivot_longer(all_of(bell_fibro3_sig), names_to = \"Gene\", values_to = \"Expression\") |&gt; \n  ggplot(aes(r_dist_PanIN_sqrt, Expression, color = Gene)) +\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\")) +\n  geom_vline(aes(xintercept = 0, color = \"border\"), linetype = \"dashed\") +\n  scale_color_manual(values = bell_fibro3_sig_cols) +\n  xlab(\"sqrt(Radial Distance from PanIN/Tumor)\") + ylab(\"Fibroblasts-specific Expression\") +\n  theme_bw()\nggsave(\"bell_fibro3_genes_trends.pdf\", bell_fibro3_genes_trends, width = 7, height = 5, dpi = 1200)\n\n# Polygon Fibro2 Score ----------------------------------------------------\n\nlibrary(stars)\nraster &lt;- st_rasterize(PanIN1134_polygons)\nplot(raster[\"annotation3\"], reset = F, axes = T)\nbox()\nplot(raster[\"fibro2_score_scaled\"], col = rev(hcl.colors(20, \"RdYlBu\")), add = T)\n\nPanIN1134_polygons_non_fibro &lt;- PanIN1134_polygons[PanIN1134_polygons$annotation != 'Fibroblasts',]\nPanIN1134_fibro2_plot &lt;- ggplot(PanIN1134_polygons) +\n  rasterise(geom_sf(aes(fill = fibro2_score_scaled), linewidth = 0), dpi = 1200) +\n  scale_fill_gradient(low = \"green\", high = \"red\") +\n  new_scale_fill() +\n  rasterise(geom_sf(data = PanIN1134_polygons_non_fibro, aes(fill = annotation2), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw() +\n  theme(panel.grid = element_blank())\nggsave(\"PanIN1134_fibro2_plot.pdf\", PanIN1134_fibro2_plot + NoLegend(), width = 5, height = 5, dpi = 1200)\n\nPanIN1134_fibro2_plot_legend &lt;- get_legend(PanIN1134_fibro2_plot)\nggsave(\"PanIN1134_fibro2_plot_legend.pdf\", PanIN1134_fibro2_plot_legend, width = 2, height = 5, dpi = 1200)\n\nPanIN1134_polygons_cropped &lt;- st_crop(PanIN1134_polygons,\n                                      st_bbox(c(xmin = 5200, xmax = 6200, ymin = 3200, ymax = 4200)))\n# PanIN1134_polygons_cropped_non_fibro &lt;- PanIN1134_polygons_cropped %&gt;% filter(annotation != 'Fibroblasts')\nPanIN1134_polygons_cropped_non_fibro &lt;- PanIN1134_polygons_cropped[PanIN1134_polygons_cropped$annotation != 'Fibroblasts',]\nPanIN1134_polygons_cropped_fibro &lt;- PanIN1134_polygons_cropped[PanIN1134_polygons_cropped$annotation == 'Fibroblasts',]\nPanIN1134_fibro2_subplot &lt;- ggplot(PanIN1134_polygons_cropped_fibro) +\n  geom_sf(aes(fill = fibro2_score_scaled), linewidth = 0) +\n  scale_fill_gradient(low = \"green\", high = \"red\") +\n  new_scale_fill() +\n  geom_sf(data = PanIN1134_polygons_cropped_non_fibro, aes(fill = annotation2), linewidth = 0) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw() +\n  NoLegend() +\n  theme(panel.grid = element_blank())\nggsave(\"PanIN1134_fibro2_subplot.pdf\", PanIN1134_fibro2_subplot, width = 5, height = 5, dpi = 1200)\n\nvr01_polygons_non_fibro &lt;- vr01_polygons %&gt;% dplyr::filter(annotation != 'Fibroblasts')\nvr01_fibro2_plot &lt;- ggplot(vr01_polygons) +\n  rasterise(geom_sf(aes(fill = fibro2_score_scaled), linewidth = 0), dpi = 1200) +\n  scale_fill_gradient(low = \"green\", high = \"red\") +\n  new_scale_fill() +\n  rasterise(geom_sf(data = vr01_polygons_non_fibro, aes(fill = annotation2), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw() +\n  theme(panel.grid = element_blank())\nggsave(\"vr01_fibro2_plot.pdf\", vr01_fibro2_plot + NoLegend(), width = 5, height = 5, dpi = 1200)\n\nvr01_fibro2_plot_legend &lt;- get_legend(vr01_fibro2_plot)\nggsave(\"vr01_fibro2_plot_legend.pdf\", vr01_fibro2_plot_legend, width = 2, height = 5, dpi = 1200)\n\nvr01_polygons_cropped &lt;- st_crop(vr01_polygons,\n                                 st_bbox(c(xmin = 1000, xmax = 2000, ymin = 500, ymax = 1500)))\nvr01_polygons_cropped_non_fibro &lt;- vr01_polygons_cropped %&gt;% dplyr::filter(annotation != 'Fibroblasts')\nvr01_polygons_cropped_fibro &lt;- vr01_polygons_cropped %&gt;% dplyr::filter(annotation == 'Fibroblasts')\nvr01_fibro2_subplot &lt;- ggplot(vr01_polygons_cropped_fibro) +\n  geom_sf(aes(fill = fibro2_score_scaled), linewidth = 0) +\n  scale_fill_gradient(low = \"green\", high = \"red\") +\n  new_scale_fill() +\n  geom_sf(data = vr01_polygons_cropped_non_fibro, aes(fill = annotation2), linewidth = 0) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw() +\n  theme(panel.grid = element_blank())+\n  NoLegend()\nggsave(\"vr01_fibro2_subplot.pdf\", vr01_fibro2_subplot, width = 5, height = 5, dpi = 1200)\n\n# Polygon Fibro2/3 combined Score ----------------------------------------------------\n\nlibrary(stars)\nraster &lt;- st_rasterize(PanIN1134_polygons)\nplot(raster[\"annotation3\"], reset = F, axes = T)\nbox()\nplot(raster[\"fibro_combined_score\"], col = rev(hcl.colors(20, \"RdYlBu\")), add = T)\n\nPanIN1134_polygons_non_fibro &lt;- PanIN1134_polygons %&gt;% dplyr::filter(annotation != 'Fibroblasts')\nPanIN1134_fibro23_plot &lt;- ggplot(PanIN1134_polygons) +\n  rasterise(geom_sf(aes(fill = fibro_combined_score), linewidth = 0), dpi = 1200) +\n  scale_fill_gradient2(low = \"blue\", mid = \"white\", high = \"red\", midpoint = 0) +\n  new_scale_fill() +\n  rasterise(geom_sf(data = PanIN1134_polygons_non_fibro, aes(fill = annotation2), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw()\nggsave(\"PanIN1134_fibro23_plot.pdf\", PanIN1134_fibro23_plot, width = 5, height = 5, dpi = 1200)\n\nPanIN1134_polygons_cropped &lt;- st_crop(PanIN1134_polygons,\n                                      st_bbox(c(xmin = 4800, xmax = 5800, ymin = 3500, ymax = 4500)))\nPanIN1134_polygons_cropped_non_fibro &lt;- PanIN1134_polygons_cropped %&gt;% filter(annotation != 'Fibroblasts')\nPanIN1134_fibro23_subplot1 &lt;- ggplot(PanIN1134_polygons_cropped) +\n  geom_sf(aes(fill = fibro_combined_score), linewidth = 0) +\n  scale_fill_gradient2(low = \"blue\", mid = \"white\", high = \"red\", midpoint = 0) +\n  new_scale_fill() +\n  geom_sf(data = PanIN1134_polygons_cropped_non_fibro, aes(fill = annotation2), linewidth = 0) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw()\nggsave(\"PanIN1134_fibro23_subplot1.pdf\", PanIN1134_fibro23_subplot1, width = 5, height = 5, dpi = 1200)\n\nvr01_polygons_non_fibro &lt;- vr01_polygons %&gt;% dplyr::filter(annotation != 'Fibroblasts')\nvr01_fibro23_plot &lt;- ggplot(vr01_polygons) +\n  geom_sf(aes(fill = fibro_combined_score), linewidth = 0) +\n  scale_fill_gradient2(low = \"blue\", mid = \"white\", high = \"red\", midpoint = 0) +\n  new_scale_fill() +\n  geom_sf(data = vr01_polygons_non_fibro, aes(fill = annotation2), linewidth = 0) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw()\nggsave(\"vr01_fibro23_plot.pdf\", vr01_fibro23_plot, width = 5, height = 5, dpi = 1200)\n\nvr01_polygons_cropped &lt;- st_crop(vr01_polygons,\n                                 st_bbox(c(xmin = 1000, xmax = 2000, ymin = 500, ymax = 1500)))\nvr01_polygons_cropped_non_fibro &lt;- vr01_polygons_cropped %&gt;% dplyr::filter(annotation != 'Fibroblasts')\nvr01_fibro23_subplot &lt;- ggplot(vr01_polygons_cropped) +\n  geom_sf(aes(fill = fibro_combined_score), linewidth = 0) +\n  scale_fill_gradient2(low = \"blue\", mid = \"white\", high = \"red\", midpoint = 0) +\n  new_scale_fill() +\n  geom_sf(data = vr01_polygons_cropped_non_fibro, aes(fill = annotation2), linewidth = 0) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw()\nggsave(\"vr01_fibro23_subplot.pdf\", vr01_fibro23_subplot, width = 5, height = 5, dpi = 1200)"
  },
  {
    "objectID": "fig5.html",
    "href": "fig5.html",
    "title": "Figure 5",
    "section": "",
    "text": "Code\n# Setup ----\n\nsetwd(dirname(rstudioapi::getSourceEditorContext()$path))\n\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratExtend)\n  library(CellChat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(EnhancedVolcano)\n  library(qs)\n  library(SPATA2)\n  library(patchwork)\n  library(pheatmap)\n  library(numbat)\n  library(tidytext)\n})\n\n# Improting data ----\n\ndir.create(\"final_figures2\", showWarnings = F, recursive = T)\n\nspatial &lt;- qread(\"../outputs/Spatial_Clustering/spatial.qs\")\ncols &lt;- scPalette(length(levels(spatial$main_annotation)))\nnames(cols) &lt;- levels(spatial$main_annotation)\ngol_Nhood_Dist &lt;- qread(\"../outputs/Misc/GoL_Nhood_Dist.qs\")\naverage_gol_nhood_dist &lt;- qread(\"../outputs/Misc/average_gol_nhood_dist.qs\")\ntumor_Nhood_Dist &lt;- qread(\"../outputs/Misc/Tumor_Nhood_Dist.qs\")\naverage_tumor_nhood_dist &lt;- qread(\"../outputs/Misc/average_tumor_nhood_dist.qs\")\n\nfibro &lt;- qread(\"../outputs/scRNAseq_Analysis/fibro_all.qs\")\nspatial_fibro &lt;- qread(\"../outputs/Fibroblasts_Analysis/spatial_stroma.qs\")\nspatial_fibro_aggregate &lt;- qread(\"../outputs/Fibroblasts_Analysis/fibroblast_subtypes_deconvolution_F2F3.qs\")\nspatial_fibro_pca &lt;- qread(\"../outputs/Fibroblasts_Analysis/fibro_aggregate_pca.qs\")\n\nmacs &lt;- qread(\"../outputs/scRNAseq_Analysis/macs_all.qs\")\nspatial_macs_aggregate &lt;- qread(\"../outputs/Macs_Analysis/macs_subtypes_deconvolution.qs\")\ntcga_gsva_scores &lt;- qread(\"../outputs/Misc/tcga_gsva_score.qs\")\n\ntumor_spata2 &lt;- qread(\"../outputs/Misc/tumor_sample_spata2_object.qs\")\ntumor_spata2_2 &lt;- qread(\"../outputs/Misc/SU-21-54126_D2_tumor_sample_spata2_object.qs\")\ngol_spata2 &lt;- qread(\"../outputs/Misc/AKJD206_C1_gol_sample_spata2_object.qs\")\ngol_spata2_2 &lt;- qread(\"../outputs/Misc/AJJB111_B1_gol_sample_spata2_object.qs\")\n\nthin_margin &lt;- theme(plot.margin = unit(c(0, 0, 0, 0), \"in\"))\n\n# % Fibro / Total Fibro Histogram -----------------------------------------\n\nplot_data &lt;- spatial@meta.data %&gt;%\n  filter(main_annotation %in% c(\"Fibro1\", \"Fibro2\", \"Fibro3\", \"Fibro4(Hi_Mt)\")) %&gt;%\n  select(tissue, main_annotation) %&gt;%\n  mutate(main_annotation = as.character(main_annotation)) %&gt;%\n  table() %&gt;%\n  prop.table(margin = 1) %&gt;%\n  data.frame() \n\npercent_fibroblast_histogram &lt;- ggplot(plot_data, aes(x = tissue, y = Freq * 100, fill = main_annotation)) +\n  geom_bar(stat = 'identity') +\n  scale_fill_manual(values = cols) +\n  xlab(NULL) + ylab(\"% of Total Fibroblast-Enriched Spatial Domains\") +\n  theme_bw() +\n  theme(panel.border = element_rect(colour = 'black', linewidth = 1, fill = NA),\n        panel.grid = element_blank(),\n        axis.text.x = element_text(angle = 45, hjust = 1)) +\n  scale_x_discrete(expand = c(0,0)) + scale_y_continuous(expand = c(0,0))\nggsave(\"percent_fibroblast_histogram.pdf\", percent_fibroblast_histogram, width = 4, height = 5, units = 'in', dpi = 1200)\n\n# Nhood Wilcox Test -------------------------------------------------------\n\ngol_Nhood_Dist$tissue &lt;- \"Healthy\"\ntumor_Nhood_Dist$tissue &lt;- \"PDAC\"\nnhood_df &lt;- rbind(gol_Nhood_Dist, tumor_Nhood_Dist)\nnhood_df$tissue_domain &lt;- paste0(nhood_df$tissue, \"_\", nhood_df$domain)\nnhood_df$tissue_domain &lt;- gsub(\"_nbors\", \"\", nhood_df$tissue_domain)\nnhood_df &lt;- nhood_df[!(nhood_df$sample_id == 'AJJB111_B1' & nhood_df$domain == 'PanIN_nbors'),]\nnhood_df$tissue_domain &lt;- gsub(\"PDAC_PanIN\", \"PanIN/GLTumor\", nhood_df$tissue_domain)\nnhood_df$tissue_domain &lt;- gsub(\"PDAC_PDTumor\", \"PDTumor\", nhood_df$tissue_domain)\nnhood_df$tissue_domain &lt;- factor(nhood_df$tissue_domain, levels = c(\"Healthy_Ducts\", \"Healthy_PanIN\",\n                                                                    \"PDAC_Ducts\", \"PanIN/GLTumor\", \"PDTumor\"))\ncomparisons &lt;- combn(unique(as.character(nhood_df$tissue_domain)), 2, simplify = F)\n\nfibro2 &lt;- nhood_df %&gt;% filter(nhood == 'Fibro2')\nfibro2_boxplot &lt;- ggboxplot(fibro2, x = 'tissue_domain', y = 'fraction', fill = 'domain', outlier.shape = NA) +\n  stat_compare_means(method = 'wilcox.test', comparisons = comparisons[c(2,3,5,6,8,9,10)], hide.ns = T) +\n  theme_bw(base_size = 10) +\n  # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  NoLegend() +\n  xlab(NULL) +\n  ylab(\"Fibro2 Fraction in 150\\u00B5 Neighborhood\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + \n  scale_fill_manual(values = c(\"Ducts_nbors\" = \"#984EA3\", \"PanIN_nbors\" = \"#F29403\", \"PDTumor_nbors\" = \"#F781BF\"))\nggsave(\"Nhood_fibro2BoxPlot.pdf\", fibro2_boxplot, width = 3, height = 5, units = 'in', dpi = 1200)\n\nfibro3 &lt;- nhood_df %&gt;% filter(nhood == 'Fibro3')\nfibro3_boxplot &lt;- ggboxplot(fibro3, x = 'tissue_domain', y = 'fraction', fill = 'domain', outlier.shape = NA) +\n  stat_compare_means(method = 'wilcox.test', comparisons = comparisons[c(2,4,9)], hide.ns = T) +\n  theme_bw(base_size = 10) +\n  # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  NoLegend() +\n  xlab(NULL) +\n  ylab(\"Fibro3 Fraction in 150\\u00B5 Neighborhood\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + \n  scale_fill_manual(values = c(\"Ducts_nbors\" = \"#984EA3\", \"PanIN_nbors\" = \"#F29403\", \"PDTumor_nbors\" = \"#F781BF\"))\nggsave(\"Nhood_fibro3BoxPlot.pdf\", fibro3_boxplot, width = 3, height = 5, units = 'in', dpi = 1200)\n\n# Spatial DimPlot Fibro2 Fibro3 -------------------------------------------\n\ntumor_spata2@meta_obs &lt;- mutate(tumor_spata2@meta_obs, annotation = ifelse(main_annotation %in% c(\"Ducts\", \"PDTumor\", \"PanIN/GLTumor\", \"Fibro1\", \"Fibro2\", \"Fibro3\", \"Fibro4(Hi_Mt)\"), as.character(main_annotation), \"Other\"))\ntumor_spata2@meta_obs$annotation &lt;- factor(tumor_spata2@meta_obs$annotation, levels = c(\"Ducts\", \"PDTumor\", \"PanIN/GLTumor\", \"Fibro1\", \"Fibro2\", \"Fibro3\", \"Fibro4(Hi_Mt)\", \"Other\"))\ntumor_fibro &lt;- plotSurface(tumor_spata2, color_by = 'annotation', display_image = F, pt_size = 0.3,\n                            clrp_adjust = c(cols, \"Other\" = 'lightgrey')) +\n  thin_margin\n\ngol_spata2@meta_obs &lt;- mutate(gol_spata2@meta_obs, annotation = ifelse(main_annotation %in% c(\"Ducts\", \"PDTumor\", \"PanIN/GLTumor\", \"Fibro1\", \"Fibro2\", \"Fibro3\", \"Fibro4(Hi_Mt)\"), as.character(main_annotation), \"Other\"))\ngol_spata2@meta_obs$annotation &lt;- factor(gol_spata2@meta_obs$annotation, levels = c(\"Ducts\", \"PDTumor\", \"PanIN/GLTumor\", \"Fibro1\", \"Fibro2\", \"Fibro3\", \"Fibro4(Hi_Mt)\", \"Other\"))\ngol_fibro &lt;- plotSurface(gol_spata2, color_by = 'annotation', display_image = F, pt_size = 0.3,\n                          clrp_adjust = c(cols, \"Other\" = 'lightgrey')) +\n  thin_margin\n\nlegend &lt;- get_legend(tumor_fibro)\nfibro_dimplot &lt;- wrap_plots(gol_fibro + NoLegend(), tumor_fibro + NoLegend())  &\n  theme(plot.margin = margin(0, 0, 0, 0))\n\nggsave(\"fibro_dimplot.pdf\", fibro_dimplot, width = 5, height = 2.5, units = 'in', dpi = 600)\nggsave(\"fibro_dimplot_legend.pdf\", legend, width = 2, height = 2.5, units = 'in', dpi = 600)\n\n# Spatial DimPlot  ----------------------------------------------------------------\nspatial_fibro$tissue &lt;- factor(spatial_fibro$tissue, levels = c(\"GoL\", \"TumorAdj\", \"Tumor\"))\nspatial_fibro_dmplot &lt;- DimPlot2(\n  spatial_fibro,\n  group.by = c(\"main_annotation\"),\n  cols = cols,\n  raster = F,\n  shape.by = 'tissue',\n  pt.size = 3,\n  theme =  theme_umap_arrows()\n) +\n  scale_shape_manual(values = c(16,1,4))\nspatial_fibro_dmplot &lt;- DimPlot(spatial_fibro, group.by = 'main_annotation', cols = cols, alpha = c(0.6), )\nggsave(\"final_figures/Fig4E.pdf\", spatial_fibro_dmplot, width = 10, height = 8, units = 'in', dpi = 1200)\n\n# PCA -------------------------------------------------------------------\nfibro_pca$metadata$tissue &lt;- factor(fibro_pca$metadata$tissue, levels = c(\"GoL\", \"TumorAdj\", \"Tumor\"))\nfibro_pca_plot &lt;- PCAtools::biplot(fibro_pca,\n                                   colby = 'main_annotation',\n                                   colkey = c('Fibro2' = \"#A65628\", 'Fibro3' = \"#54B0E4\"),\n                                   lab = NULL,\n                                   shape = 'tissue',\n                                   encircle = F,\n                                   legendTitleSize = 12,\n                                   shapekey = c(16,1,4),\n                                   pointSize = 5,\n                                   legendPosition = 'right')\nggsave(\"final_figures/Fig4F.pdf\", fibro_pca_plot, width = 7, height = 5, units = 'in', dpi = 1200)\n\n# Fibro2 vs Fibro3 VP ------------------------------------------------\n\ngenes_to_highlight &lt;- c(\"COL11A1\", \"COL10A1\", \"FN1\", \"MMP11\",\"POSTN\", \"SULF1\",\n                        \"CTHRC1\", \"IGFL2\", \"IGFBP3\", \"LEF1\",\n                        \"GPX3\", \"C7\", \"EDNRB\", \"ADH1B\", \"CCL19\", \"STEAP4\", \"PTGDS\", \"MFAP4\")\n\nfibro2_v_fibro3_DEGs &lt;- fibro2_v_fibro3_DEGs %&gt;%\n  mutate(\n    sig = case_when(\n      padj &lt; 0.05 & log2FoldChange &gt;=  0.5 ~ \"Up\",\n      padj &lt; 0.05 & log2FoldChange &lt;= -0.5 ~ \"Down\",\n      TRUE ~ \"NS\"\n    ),\n    highlight = ifelse(gene %in% genes_to_highlight, TRUE, FALSE)\n  )\n\nfibro2_v_fibro3_VP &lt;- ggplot(fibro2_v_fibro3_DEGs, aes(x = log2FoldChange, y = -log10(padj))) +\n  geom_point(aes(color = sig, size = sqrt(baseMean), alpha = sqrt(baseMean))) +\n  geom_text_repel(\n    data = subset(fibro2_v_fibro3_DEGs, highlight),\n    aes(label = gene),\n    color = \"black\",\n    max.overlaps = Inf,\n    size = 5,\n    box.padding = 1,\n  ) +\n  geom_vline(xintercept = c(-0.5, 0.5), linetype = \"dashed\") +\n  geom_hline(yintercept = -log10(0.05), linetype = \"dashed\") +\n  scale_color_manual(values = c(Down = \"dodgerblue3\", Up = \"firebrick\", NS = \"grey70\")) +\n  scale_size_continuous(range = c(0.5, 5)) +\n  scale_alpha_continuous(range = c(0.3, 0.9), guide = \"none\") +\n  labs(\n    x = \"log2 Fold Change\",\n    y = \"-log10(p-adjusted)\",\n    color = \"\",\n    title = \"Fibro2 vs. Fibro3 DEGs\"\n  ) +\n  theme_bw()\n\nggsave(\"final_figures/fibro2_v_fibro3_VP.pdf\", fibro2_v_fibro3_VP, width = 7, height = 5, units = 'in', dpi = 1200)\n\n\n# scRNAseq dimplot --------------------------------------------------------\n\nscRNAseq_FibroDimPlot &lt;- DimPlot2(fibro, group.by = 'fibro_subtypes', cols = 'iwh_all', pt.size = 0.5, theme = list(theme_umap_arrows(), NoLegend()))\nggsave(\"scRNAseq_FibroDimPlot.pdf\", scRNAseq_FibroDimPlot, width = 3, height = 3, units = 'in', dpi = 1200)\n\nscRNAseq_fibrohistogram &lt;- ClusterDistrBar(origin = fibro$tissue, cluster = fibro$fibro_subtypes, cols = 'iwh_all', flip = F, reverse_order = F) +\n  xlab(NULL) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"scRNAseq_fibrohistogram.pdf\", scRNAseq_fibrohistogram, width = 3, height = 3, units = 'in', dpi = 1200)\n\nfeatures_of_interest &lt;- c(\"PDGFRA\", \"IGF1\", \"EDNRB\", \"C7\",\n                          \"IL6\", \"PI16\", \"HAS1\",\n                          \"SFRP4\", \"DPEP1\", \"ENG\",\n                          \"LRRC15\" , \"MMP11\", \"ACTA2\", \"LEF1\",\n                          \"COL1A1\", \"COL1A2\",\n                          \"RORA\", \"KAZN\", \"PVT1\",\n                          \"CD74\", \"HLA-DRA\")\nfibro_dotplot &lt;- DotPlot2(fibro, features = features_of_interest, group.by = 'fibro_subtypes', color_scheme = 'RdYlBu-rev', flip = T, show_grid = T, legend_position = 'bottom')\nggsave(\"scRNAseq_FibroDotPlot.pdf\", fibro_dotplot, width = 8, height = 4, units = 'in', dpi = 1200)\n\n# H-Deconv ----\n\navg &lt;- AverageExpression(fibro_aggregate, assays = 'subtype_fractions', group.by = 'main_annotation')$subtype_fractions\navg &lt;- avg[c(4,7,1,3),c(2,1)]\nfibro_h_deconv_heatmap &lt;- pheatmap(t(avg),\n                                   cluster_cols = F,\n                                   cluster_rows = F,\n                                   color = viridis(n = 1000, option = 'B'),\n                                   border_color = 'white',\n                                   main = 'Hierarchical deconvolution of fibroblasts in different niches')\nggsave(\"fibro_h_deconv_heatmap.pdf\", fibro_h_deconv_heatmap, width = 5, height = 3, units = 'in', dpi = 1200)\n\nfraction_vlnplot &lt;- VlnPlot2(fibro_aggregate, features = c(\"IGF1+-Fibro\", \"HAS1+-Fibro\", \"SFRP4+-Fibro\", \"LRRC15+-Fibro\"), group.by = 'main_annotation', violin = F, nrow = 2, stat.method = 'wilcox.test', label = 'p.adj') +\n  scale_fill_manual(values = c('Fibro2' = \"#A65628\", 'Fibro3' = \"#54B0E4\")) +\n  ylab(\"Fraction\")\nggsave(\"fibro_h_fraction_boxplot.pdf\", fraction_vlnplot, width = 4, height = 5, units = 'in', dpi = 1200)\n\nfibro_elbow_plot &lt;- cowplot::plot_grid(plotlist = fibro_elbow, ncol = 1)\nggsave(\"final_figures/Fig5Aa.pdf\", fibro_elbow_plot, width = 5, height = 6, units = 'in', dpi = 1200)\n\npatterns_featureplot_list &lt;- lapply(colnames(fibro_cogaps@sampleFactors), function(x){\n  FeaturePlot(sc_fibro, features = x, pt.size = 0.5) +\n    scale_color_viridis(option = 'B') +\n    theme(\n      axis.title = element_blank(),\n      axis.text = element_blank(),\n      axis.ticks = element_blank(),\n      axis.line = element_blank()\n    ) +\n    NoLegend()\n})\npatterns_featureplot_list &lt;- wrap_plots(patterns_featureplot_list, nrow = 2)\nggsave(\"final_figures/Fig5Bb.pdf\", patterns_featureplot_list, width = 15, height = 6, units = 'in', dpi = 300)\n\nlegend &lt;- get_legend(FeaturePlot(sc_fibro, features = colnames(fibro_cogaps@sampleFactors)[1], pt.size = 0.5) + scale_color_viridis(option = 'B'))\nggsave(\"final_figures/Fig5BLegend.pdf\", legend, width = 2, height = 5, units = 'in', dpi = 300)\n\ntop_markers &lt;- fibro_cogaps_markers$PatternMarkerScores %&gt;%\n  reshape2::melt(varnames = c('gene', \"pattern\"), value.name = 'score') %&gt;%\n  filter(pattern %in% paste0(\"Pattern_\",c(1,6,7,8,9,11))) %&gt;%\n  group_by(pattern) %&gt;%\n  top_n(n = 10, wt = score) %&gt;%\n  pull(gene) %&gt;% unique()\n\ntop_custom_markers &lt;- c(\"SFRP4\", \"CAPDS\", \"CST2\", \"AGT\", \"COMP\",\"THSD4\", \"ANO1\", \"WNT4\", \"LAMP5\", \"PIEZO2\", \"DPEP1\",\n                        \"PTPRC\", \"FYB1\", \"SKAP1\", \"CD52\", \"S100A9\", \"SAMSN1\", \"HLA-DRA\",\n                        \"MFAP5\", \"KLF4\", \"CXCL2\", \"GPRC5A\", \"IL6\", \"HAS1\", \"IL18\", \"PI16\",\n                        \"COL11A1\", \"MMP11\", \"GJB2\", \"SDC1\", \"IGFL2\", \"POSTN\", \"LRRC15\", \"TMEM158\",\n                        \"LMO3\")\n\ncolors &lt;- rev(RColorBrewer::brewer.pal(n = 11, name = \"RdYlBu\"))\ncolors.use &lt;- grDevices::colorRampPalette(colors = colors)(100)\n\nmarkers_hetamap &lt;- pheatmap(fibro_cogaps_markers$PatternMarkerScores[top_markers,paste0(\"Pattern_\",c(1,6,7,8,9,11))],\n                            color = colors.use,\n                            border_color = \"white\",\n                            cellwidth = 20,\n                            cellheight = 8,\n                            fontsize_row = 7,\n                            angle_col = 45,\n                            cluster_rows = F,\n                            cluster_cols = F)\nggsave(\"final_figures/Fig5Cc.pdf\", markers_hetamap, width = 4, height = 10, units = 'in', dpi = 300)\n\npheatmap::pheatmap(mat = t(top_acts_mat),\n                   color = colors.use,\n                   border_color = \"white\",\n                   breaks = my_breaks,\n                   # cellwidth = 15,\n                   # cellheight = 15,\n                   treeheight_row = 20,\n                   treeheight_col = 20)\n\nsc_fibro$fibro_subtypes &lt;- factor(sc_fibro$fibro_subtypes, levels = c(\"IGF1+_Fibro\", \"HAS1+_Fibro\", \"SFRP4+_Fibro\", \"LRRC15+_Fibro\", \"COL1A1+_Fibro\", \"RORA+_Fibro\", \"CD74+_Fibro\"))\nfibro_umap &lt;- DimPlot2(\n  sc_fibro,\n  group.by = c(\"fibro_subtypes\"),\n  cols = 'iwh_all',\n  raster = F,\n  pt.size = 0.5,\n  theme =  theme_umap_arrows()\n)\nggsave(\"final_figures/Fig5A.pdf\", fibro_umap, width = 6, height = 4, units = 'in', dpi = 1200)\n\nfibro_histogram_tissue &lt;- ClusterDistrBar(sc_fibro$tissue, sc_fibro$fibro_subtypes,\n                                          cols = 'iwh_all',\n                                          flip = F,\n                                          border = 'white', reverse_order = F) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  xlab(NULL) + labs(fill = \"Fibroblast Subtypes\")\nggsave(\"final_figures/Fig5C.pdf\", fibro_histogram_tissue,  width = 4, height = 4, dpi = 300)\n\ndoublet_score &lt;- VlnPlot2(\n  sc_fibro,\n  features = 'doublet_score',\n  cols = 'iwh_all',\n  group.by = 'fibro_subtypes',\n  pt = F,\n  box = F\n)\nggsave(\"final_figures/SuppFig5A.pdf\", doublet_score,  width = 4, height = 5, dpi = 300)\n\nplot_df &lt;- GetAssayData(stroma_aggregate, assay = 'subtype_fractions')[c(4,7,1,3),]\nann &lt;- stroma_aggregate@meta.data %&gt;% select(main_annotation_tissue)\nann$main_annotation_tissue &lt;- factor(ann$main_annotation_tissue, levels = c(\"Fibro3_GoL\", \"Fibro3_TumorAdj\", \"Fibro3_Tumor\", \"Fibro2_Tumor\"))\nann_cols &lt;- list(main_annotation_tissue = c('Fibro3_GoL'))\nsamples_heatmap &lt;- pheatmap(plot_df[,order(ann$main_annotation_tissue)],\n                            cluster_rows = F, cluster_cols = F,\n                            annotation = ann,\n                            color = viridis(option = 'B',n = 100), show_colnames = F)\nggsave(\"final_figures/SuppFig5B.pdf\", samples_heatmap,  width = 10, height = 5, dpi = 300)\n\n# Macs DimPlot ------------------------------------------------------------\n\nmacs$macs_subtypes &lt;- factor(macs$macs_subtypes, levels = c(\"Classical_Macs\", \"Nonclassical_Macs\", \"Resident_Macs\", \"AltAct_Macs\", \"THBS1+_Macs\", \"Cycling_Macs\", \"Dendritic\"))\nIdents(macs) &lt;- macs$macs_subtypes\nmacs_dimplot &lt;- DimPlot2(macs, group.by = 'macs_subtypes', pt.size = 0.5, cols = 'iwh_default', theme = list(theme_umap_arrows(), theme(legend.position = 'top')))\nggsave(\"scRNAseq_macs_dimplot.pdf\", macs_dimplot,  width = 7, height = 5, dpi = 300)\n\nmacs@misc$markers$cluster &lt;- factor(macs@misc$markers$cluster, levels = c(\"Classical_Macs\", \"Nonclassical_Macs\", \"Resident_Macs\", \"AltAct_Macs\", \"THBS1+_Macs\", \"Cycling_Macs\", \"Dendritic\"))\nmacs_top_markers &lt;-  macs@misc$markers %&gt;%\n  group_by(cluster) %&gt;%\n  top_n(n = 10, wt = scores) %&gt;%\n  dplyr::select(gene, cluster) %&gt;%\n  split(f = .$cluster) %&gt;%\n  lapply(pull, gene)\nselected_markers &lt;- c(\"S100A9\", \"S100A8\", \"FCN1\", \"FCGR3A\", \"CDKN1C\", \"FRMD4A\", \"C1QA\", \"C1QB\", \"SPP1\", \"FABP5\", \"APOE\", \"MARCO\", \"THBS1\", \"AREG\", \"EREG\", \"MKI67\",\"TOP2A\", \"CCSER1\", \"CLNK\", \"HLA-DRA\")\nmacs_dotplot &lt;- DotPlot2(macs, features = selected_markers, flip = T, color_scheme = 'RdYlBu-rev', legend_position = 'bottom')\nggsave(\"scRNAseq_macs_dotplot.pdf\", macs_dotplot,  width = 7, height = 4, dpi = 300)\n\nmacs_tissue_histogram &lt;- ClusterDistrBar(macs$tissue, macs$macs_subtypes, cols = 'iwh_default', flip = F, reverse_order = F) +\n  xlab(NULL) + theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"macs_tissue_histogram.pdf\", macs_tissue_histogram,  width = 4, height = 5, dpi = 300)\n\nplot_df &lt;- GetAssayData(spatial_macs_aggregate, assay = 'subtype_fractions') %&gt;%\n  data.frame() %&gt;%\n  rownames_to_column(\"mac_subtype\") %&gt;%\n  pivot_longer(cols = -mac_subtype, values_to = 'fraction')\n\nmacs_cols &lt;- color_iwh(n = length(levels(macs$macs_subtypes)), col.space = 'default')\nnames(macs_cols) &lt;- gsub(\"_\", \"-\", levels(macs$macs_subtypes))\nmacs_deconvolution_boxplot &lt;- ggplot(plot_df, aes(x = reorder_within(x = mac_subtype, within = mac_subtype, by = fraction), y = fraction,  fill = mac_subtype)) +\n  geom_boxplot() +\n  geom_point() +\n  scale_x_reordered() +\n  xlab(NULL) + ylab(\"Celltype Fraction\") +\n  theme_bw() +\n  scale_fill_manual(values = macs_cols) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"macs_deconvolution_boxplot.pdf\", macs_deconvolution_boxplot + NoLegend(),  width = 3, height = 4, dpi = 300)\n\nmacs_scores &lt;- tcga_gsva_scores[,7:12]\nfibro_scores &lt;- tcga_gsva_scores[,1:6]\ncorr &lt;- cor(fibro_scores, macs_scores, method = 'pearson')\nmy_palette &lt;- colorRampPalette(c(\"blue\", \"red\"))(10)\n# breaks &lt;- seq(-max(abs(corr)), max(abs(corr)), length.out = 101)\nfibro_macs_cor_heatmap &lt;- pheatmap(corr, color = my_palette, border_color = 'white',angle_col = 45, display_numbers = T, fontsize_number = 15, number_color = 'white')\nggsave(\"fibro_macs_cor_heatmap.pdf\", fibro_macs_cor_heatmap,  width = 7, height = 7, dpi = 300)\n\nlrrc_altact_points &lt;- ggplot(tcga_gsva_scores, aes(x = `LRRC15+_Fibro`, y = `AltAct_Macs`)) +\n  geom_point() +\n  xlab(\"LRRC15+ Fibro Score\") + ylab(\"AltAct Fibro Score\") +\n  theme_bw()\nggsave(\"lrrc_altact_points.pdf\", lrrc_altact_points,  width = 5, height = 5, dpi = 300)"
  },
  {
    "objectID": "st_processing.html",
    "href": "st_processing.html",
    "title": "Spatial Transcriptomics Data Processing",
    "section": "",
    "text": "Here we load essential packages and visium_samples_manifest.xlsx from the data directory, that includes information and metadata about visium samples. We use Seurat v5 (Hao et al. 2023) as data container for processing and visualization.\n\n\nCode\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(tidyverse)\n  library(parallel)\n  library(scCustomize)\n  library(SPATA2)\n  library(qs)\n  library(CellChat)\n})\n\n# loading manifest ------------------------------------------------------------\n\nvisium_samples &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")\n\n# processing data ------------------------------------------------------------\n\noutputDir &lt;- \"outputs/Preprocessing/spatial_seurat_objects/\"\ndir.create(outputDir, showWarnings = F, recursive = T)"
  },
  {
    "objectID": "st_processing.html#setup-data-loading",
    "href": "st_processing.html#setup-data-loading",
    "title": "Spatial Transcriptomics Data Processing",
    "section": "",
    "text": "Here we load essential packages and visium_samples_manifest.xlsx from the data directory, that includes information and metadata about visium samples. We use Seurat v5 (Hao et al. 2023) as data container for processing and visualization.\n\n\nCode\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(tidyverse)\n  library(parallel)\n  library(scCustomize)\n  library(SPATA2)\n  library(qs)\n  library(CellChat)\n})\n\n# loading manifest ------------------------------------------------------------\n\nvisium_samples &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")\n\n# processing data ------------------------------------------------------------\n\noutputDir &lt;- \"outputs/Preprocessing/spatial_seurat_objects/\"\ndir.create(outputDir, showWarnings = F, recursive = T)"
  },
  {
    "objectID": "st_processing.html#seurat-object-preparation",
    "href": "st_processing.html#seurat-object-preparation",
    "title": "Spatial Transcriptomics Data Processing",
    "section": "2 Seurat Object Preparation",
    "text": "2 Seurat Object Preparation\nHere we generate spatial Seurat objects for each patient sample, and save them separately. They will be merged later in Clustering Analysis with deconvolution and clustering results\n\n\nCode\nlapply(visium_samples$patient_id, function(x){\n  message(x)\n  path &lt;- visium_samples %&gt;% filter(patient_id == x) %&gt;% pull(cellranger_3.0.1_output_path)\n  seurat_obj &lt;- Load10X_Spatial(path)\n  seurat_obj &lt;- NormalizeData(seurat_obj)\n  seurat_obj &lt;- ScaleData(seurat_obj)\n  saveRDS(seurat_obj, paste0(outputDir, x,\".rds\"))\n})"
  },
  {
    "objectID": "st_nhood_analysis.html",
    "href": "st_nhood_analysis.html",
    "title": "Spatial Transcriptomics Neighborhood Analysis",
    "section": "",
    "text": "Here we will be using semla (Larsson et al. 2023) R Package to analyze the composition of the neighborhood of benign and neoplastic domains on spatial transcriptomics data. We calculate the radial distance from ductal, PanIN, GLTumor and PDTumor spatial domains and subset the spots in 150 microns from these domains. We then visualize the composition of the neighborhood using pie charts and barplots."
  },
  {
    "objectID": "st_nhood_analysis.html#setup-and-data-import",
    "href": "st_nhood_analysis.html#setup-and-data-import",
    "title": "Spatial Transcriptomics Neighborhood Analysis",
    "section": "1 Setup and data import",
    "text": "1 Setup and data import\nData can be downloaded from Zenodo here.\n\n\nCode\nlibrary(semla)\nlibrary(Seurat)\nlibrary(tidyverse)\n\nsamples_info &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")\nmerged &lt;- qs::qread(\"outputs/Spatial_Clustering/tumor_tumoradj_GoL_samples_annotated_v2_lite.qs\")\ncols &lt;- CellChat::scPalette(length(levels(merged$main_annotation)))\nnames(cols) &lt;- levels(merged$main_annotation)"
  },
  {
    "objectID": "st_nhood_analysis.html#tumor-tissue-neighborhood-analysis",
    "href": "st_nhood_analysis.html#tumor-tissue-neighborhood-analysis",
    "title": "Spatial Transcriptomics Neighborhood Analysis",
    "section": "2 Tumor tissue neighborhood analysis",
    "text": "2 Tumor tissue neighborhood analysis\n\n\nCode\ntumor &lt;- subset(merged, subset = tissue == 'Tumor')\ntumor_samples &lt;- SplitObject(tumor, split.by = 'sample_id')\n\n## Calculating the radial distance\ntumor_samples &lt;- lapply(tumor_samples, function(x){\n  x &lt;- UpdateSeuratForSemla(x)\n  x@tools$Staffli@meta_data &lt;- tibble(x@meta.data %&gt;%\n                                        select(barcode, array_row, array_col, pxl_row_in_fullres, pxl_col_in_fullres) %&gt;%\n                                        dplyr::rename(x = array_row, y = array_col) %&gt;%\n                                        mutate(sampleID = 1,\n                                        barcode = rownames(.)))\n  x &lt;- LoadImages(x, image_height = as.numeric(GetImageInfo(x)$height))\n  x &lt;- RadialDistance(x, column_name = \"main_annotation\", selected_groups = c(\"Ducts\", \"PanIN/GLTumor\", \"PDTumor\", \"Immune(TLS)\"), maxDist = 200, convert_to_microns = T)\n  x@meta.data &lt;- mutate(x@meta.data,\n                        PDTumor_nbors = ifelse(r_dist_PDTumor &lt; 0 | r_dist_PDTumor &gt; 150, \"FALSE\", \"TRUE\"),\n                        PanIN_nbors = ifelse(`r_dist_PanIN/GLTumor` &lt; 0 | `r_dist_PanIN/GLTumor` &gt; 150, \"FALSE\", \"TRUE\"),\n                        Ducts_nbors = ifelse(r_dist_Ducts &lt; 0 | r_dist_Ducts &gt; 150, \"FALSE\", \"TRUE\"),\n                        TLS_nbors = ifelse(`r_dist_Immune(TLS)` &lt; 0 | `r_dist_Immune(TLS)` &gt; 150, \"FALSE\", \"TRUE\"))\n  x &lt;- UpdateSeuratFromSemla(x)\n  x@images$slice1 &lt;- NULL\n  return(x)\n})\n\n## Subsetting spots in 150 microns distance\ntumor_Nhood_Dist &lt;- lapply(tumor_samples, function(x){\n  PDTumor_nbors &lt;- x@meta.data %&gt;% filter(PDTumor_nbors == 'TRUE') %&gt;% pull(main_annotation) %&gt;% table() %&gt;% prop.table() %&gt;% as.matrix()\n  PanIN_nbors &lt;- x@meta.data %&gt;% filter(PanIN_nbors == 'TRUE') %&gt;% pull(main_annotation) %&gt;% table() %&gt;% prop.table() %&gt;% as.matrix()\n  Ducts_nbors &lt;- x@meta.data %&gt;% filter(Ducts_nbors == 'TRUE') %&gt;% pull(main_annotation) %&gt;% table() %&gt;% prop.table() %&gt;% as.matrix()\n  ImmuneTLS_nbors &lt;- x@meta.data %&gt;% filter(TLS_nbors == 'TRUE') %&gt;% pull(main_annotation) %&gt;% table() %&gt;% prop.table() %&gt;% as.matrix()\n  res &lt;- data.frame(PDTumor_nbors = PDTumor_nbors,\n                    PanIN_nbors = PanIN_nbors,\n                    Ducts_nbors = Ducts_nbors,\n                    ImmuneTLS_nbors = ImmuneTLS_nbors) %&gt;%\n    rownames_to_column(var = 'domain') %&gt;%\n    reshape2::melt() %&gt;%\n    `colnames&lt;-`(c(\"nhood\", \"domain\", \"fraction\")) %&gt;%\n    select(domain, nhood, fraction)\n  return(res)\n}) %&gt;%\n  bind_rows(.id = 'sample_id')\nqsave(tumor_Nhood_Dist, \"outputs/Misc/Tumor_Nhood_Dist.qs\")\n\naverage_tumor_nhood_dist &lt;- tumor_Nhood_Dist %&gt;%\n  filter(domain != 'ImmuneTLS_nbors') %&gt;%\n  group_by(domain, nhood) %&gt;%\n  summarise(mean = mean(fraction))\naverage_tumor_nhood_dist$domain &lt;- factor(average_tumor_nhood_dist$domain, levels = c(\"Ducts_nbors\", \"PanIN_nbors\", \"PDTumor_nbors\"))\nqsave(average_tumor_nhood_dist, \"outputs/Misc/average_tumor_nhood_dist\")\n\nggplot(average_tumor_nhood_dist, aes(x = \"\", y = mean, fill = nhood)) +\n  geom_bar(stat = \"identity\", width = 1, color = 'white') +\n  coord_polar(\"y\") +\n  theme_void() +\n  facet_wrap(~domain) +\n  scale_fill_manual(values = cols)\n\naverage_TLS_nhood_dist &lt;- tumor_Nhood_Dist %&gt;%\n  filter(domain == 'ImmuneTLS_nbors') %&gt;%\n  group_by(domain, nhood) %&gt;%\n  summarise(mean = mean(fraction))\nqsave(average_TLS_nhood_dist, \"outputs/Misc/average_TLS_nhood_dist.qs\")\n\nggplot(average_TLS_nhood_dist, aes(x = \"\", y = mean, fill = nhood)) +\n  geom_bar(stat = \"identity\", width = 1, color = 'white') +\n  coord_polar(\"y\") +\n  theme_void() +\n  facet_wrap(~domain) +\n  scale_fill_manual(values = cols)"
  },
  {
    "objectID": "st_nhood_analysis.html#donor-tissue-neighborhood-analysis",
    "href": "st_nhood_analysis.html#donor-tissue-neighborhood-analysis",
    "title": "Spatial Transcriptomics Neighborhood Analysis",
    "section": "3 Donor tissue neighborhood analysis",
    "text": "3 Donor tissue neighborhood analysis\n\n\nCode\ngol &lt;- subset(merged, subset = tissue == 'GoL')\ngol_samples &lt;- SplitObject(gol, split.by = 'sample_id')\ngol_samples &lt;- lapply(gol_samples, function(x){\n  x &lt;- UpdateSeuratForSemla(x)\n  x@tools$Staffli@meta_data &lt;- tibble(x@meta.data %&gt;%\n                                        select(barcode, array_row, array_col, pxl_row_in_fullres, pxl_col_in_fullres) %&gt;%\n                                        dplyr::rename(x = array_row, y = array_col) %&gt;%\n                                        mutate(sampleID = 1,\n                                               barcode = rownames(.)))\n  x &lt;- LoadImages(x, image_height = as.numeric(GetImageInfo(x)$height))\n  x &lt;- RadialDistance(x, column_name = \"main_annotation\", selected_groups = c(\"Ducts\", \"PanIN/GLTumor\"), maxDist = 200, convert_to_microns = T)\n  x@meta.data &lt;- mutate(x@meta.data,\n                        PanIN_nbors = ifelse(`r_dist_PanIN/GLTumor` &lt; 0 | `r_dist_PanIN/GLTumor` &gt; 150, \"FALSE\", \"TRUE\"),\n                        Ducts_nbors = ifelse(r_dist_Ducts &lt; 0 | r_dist_Ducts &gt; 150, \"FALSE\", \"TRUE\"))\n  x &lt;- UpdateSeuratFromSemla(x)\n  x@images$slice1 &lt;- NULL\n  return(x)\n})\n\ngol_Nhood_Dist &lt;- lapply(gol_samples, function(x){\n  PanIN_nbors &lt;- x@meta.data %&gt;% filter(PanIN_nbors == 'TRUE') %&gt;% pull(main_annotation) %&gt;% table() %&gt;% prop.table() %&gt;% as.matrix()\n  Ducts_nbors &lt;- x@meta.data %&gt;% filter(Ducts_nbors == 'TRUE') %&gt;% pull(main_annotation) %&gt;% table() %&gt;% prop.table() %&gt;% as.matrix()\n  res &lt;- data.frame(PanIN_nbors = PanIN_nbors,\n                    Ducts_nbors = Ducts_nbors) %&gt;%\n    rownames_to_column(var = 'domain') %&gt;%\n    reshape2::melt() %&gt;%\n    `colnames&lt;-`(c(\"nhood\", \"domain\", \"fraction\")) %&gt;%\n    select(domain, nhood, fraction)\n  return(res)\n}) %&gt;%\n  bind_rows(.id = 'sample_id')\nqsave(gol_Nhood_Dist, \"outputs/Misc/GoL_Nhood_Dist.qs\")\n\naverage_gol_nhood_dist &lt;- gol_Nhood_Dist %&gt;%\n  group_by(domain, nhood) %&gt;%\n  summarise(mean = mean(fraction))\naverage_gol_nhood_dist$domain &lt;- factor(average_gol_nhood_dist$domain, levels = c(\"Ducts_nbors\", \"PanIN_nbors\"))\nqsave(average_gol_nhood_dist, \"outputs/Misc/average_gol_nhood_dist.qs\")\n\nggplot(average_gol_nhood_dist, aes(x = \"\", y = mean, fill = nhood)) +\n  geom_bar(stat = \"identity\", width = 1, color = 'white') +\n  coord_polar(\"y\") +\n  theme_void() +\n  facet_wrap(~domain) +\n  scale_fill_manual(values = cols)"
  },
  {
    "objectID": "scRNAseq_cellbender.html",
    "href": "scRNAseq_cellbender.html",
    "title": "scRNAseq Ambient RNA Correction",
    "section": "",
    "text": "The first step in the workflow, prior to analysis in R, is to correct the raw count matrices for ambient RNA contamination. This is performed using CellBender (Fleming et al. 2023)"
  },
  {
    "objectID": "scRNAseq_cellbender.html#environment-setup",
    "href": "scRNAseq_cellbender.html#environment-setup",
    "title": "scRNAseq Ambient RNA Correction",
    "section": "Environment Setup",
    "text": "Environment Setup\nThe exact conda environment used in this run can be installed using this yml file using conda env create -f cellbender.yml\nAlternatively you can create the environement as follows\n## Installing cellbender\nconda create -n cellbender python=3.7\nconda activate cellbender\npip install cellbender==0.3.0"
  },
  {
    "objectID": "scRNAseq_cellbender.html#running-cellbender",
    "href": "scRNAseq_cellbender.html#running-cellbender",
    "title": "scRNAseq Ambient RNA Correction",
    "section": "Running Cellbender",
    "text": "Running Cellbender\nThe following shell script is submitted to a high-performance computing (HPC) cluster as a SLURM job array to process each of the 48 samples in parallel.\nThe script pulls a cellbender_manifest.txt file from data directory with at two columns: sample_id and cellranger_output path for each sample as follow\n\n\n\nsample_1\npath/to/sample_1/cellranger_output\n\n\nsample_2\npath/to/sample_2/cellranger_output\n\n\nsample_3\npath/to/sample_3/cellranger_output\n\n\n\n#!/bin/bash\n\n#SBATCH --account=\n#SBATCH --job-name='Cellbender_scRNAseq_%a'\n#SBATCH --output=logs/Cellbender_scRNAseq_%a.log\n#SBATCH --partition=gpu\n#SBATCH --mem=128G\n#SBATCH --cpus-per-task=16\n#SBATCH --gres=gpu:1\n#SBATCH --time=04:00:00\n#SBATCH --array=1-48\n\n## Setting up environment\necho -e \"&gt;&gt;&gt; Start time $(date) &lt;&lt;&lt;\"\nstart_time=$(date +%s)\n\nsource activate cellbender\noutputDir=../outputs/scRNASeq_Analysis/cellbender/\nmkdir -p $outputDir\n\n## Importing samples info\nsamples_info=../data/cellbender_manifest.txt\nsample=$(cat $samples_info | cut -f1 | sed -n $[SLURM_ARRAY_TASK_ID]p)\npath=$(cat $samples_info | cut -f2 | sed -n $[SLURM_ARRAY_TASK_ID]p)\noutputDir=${outputDir}/${sample}\nmkdir -p $outputDir\necho -e \"&gt;&gt;&gt; Processing $sample &lt;&lt;&lt;\"\necho -e \"&gt;&gt;&gt; Sample path $path &lt;&lt;&lt;\"\necho -e \"&gt;&gt;&gt; Output in $outputDir &lt;&lt;&lt;\"\n\n## Running CellBender \ncd $outputDir\ncellbender remove-background \\\n--cuda \\\n--input ${path}/raw_feature_bc_matrix.h5 \\\n--output ${outputDir}/${sample}.h5\n\n## Reporting time\necho -e \"&gt;&gt;&gt; End time $(date) &lt;&lt;&lt;\"\nend_time=$(date +%s)\nruntime_seconds=$((end_time - start_time))\nruntime_minutes=$((runtime_seconds / 60))\necho \"Total runtime: $runtime_minutes minutes\""
  },
  {
    "objectID": "fig4.html",
    "href": "fig4.html",
    "title": "Figure 4",
    "section": "",
    "text": "Code\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratExtend)\n  library(CellChat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(EnhancedVolcano)\n  library(qs)\n  library(SPATA2)\n  library(patchwork)\n  library(pheatmap)\n  library(numbat)\n})\n\n\nscRef &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef.qs\")\nspatial &lt;- qread(\"../outputs/Spatial_Clustering/spatial.qs\")\ncols &lt;- scPalette(length(levels(spatial$main_annotation)))\nnames(cols) &lt;- levels(spatial$main_annotation)\n\ngol_Nhood_Dist &lt;- qread(\"../outputs/Misc/GoL_Nhood_Dist.qs\")\naverage_gol_nhood_dist &lt;- qread(\"../outputs/Misc/average_gol_nhood_dist.qs\")\ntumor_Nhood_Dist &lt;- qread(\"../outputs/Misc/Tumor_Nhood_Dist.qs\")\naverage_tumor_nhood_dist &lt;- qread(\"../outputs/Misc/average_tumor_nhood_dist.qs\")\n\ntumor_spata2 &lt;- qread(\"../outputs/Misc/tumor_sample_spata2_object.qs\")\ntumor_spata2_2 &lt;- qread(\"../outputs/Misc/SU-21-54126_D2_tumor_sample_spata2_object.qs\")\ngol_spata2 &lt;- qread(\"../outputs/Misc/gol_sample_spata2_object.qs\")\ngol_spata2_2 &lt;- qread(\"../outputs/Misc/AJJB111_B1_gol_sample_spata2_object.qs\")\n\ntumor_moran &lt;- qread(\"../outputs/CCC/liana_res_mapped_tumor_morans.qs\")\n\n# Pie Chart Healthy -------------------------------------------------------------------\ngol_pie_chart &lt;- ggplot(average_gol_nhood_dist, aes(x = \"\", y = mean, fill = nhood)) +\n  geom_bar(stat = \"identity\", width = 1, color = 'white') +\n  coord_polar(\"y\") +\n  theme_void() +\n  facet_wrap(~domain) +\n  scale_fill_manual(values = cols) +\n  NoLegend()\n\nggsave(\"Fig4A.pdf\", gol_pie_chart, width = 10, height = 5, units = 'in', dpi = 1200)\n\n# Pie Chart Tumor -------------------------------------------------------------------\ntumor_pie_chart &lt;- ggplot(average_tumor_nhood_dist, aes(x = \"\", y = mean, fill = nhood)) +\n  geom_bar(stat = \"identity\", width = 1, color = 'white') +\n  coord_polar(\"y\") +\n  theme_void() +\n  facet_wrap(~domain) +\n  scale_fill_manual(values = cols) +\n  NoLegend()\nggsave(\"Fig4B.pdf\", tumor_pie_chart, width = 10, height = 5, units = 'in', dpi = 1200)\n\n# Pie Chart Legend -------------------------------------------------------------------\nlegend &lt;- get_legend(ggplot(average_tumor_nhood_dist, aes(x = \"\", y = mean, fill = nhood)) +\n                       geom_bar(stat = \"identity\", width = 1, color = 'white') +\n                       scale_fill_manual(values = cols))\nggsave(\"Fig4AB_Legend.pdf\", legend, width = 2, height = 5, units = 'in', dpi = 1200)\n\n# Nhood Wilcox -------------------------------------------------------------------\ngol_Nhood_Dist$tissue &lt;- \"Healthy\"\ntumor_Nhood_Dist$tissue &lt;- \"PDAC\"\nnhood_df &lt;- rbind(gol_Nhood_Dist, tumor_Nhood_Dist)\nnhood_df$tissue_domain &lt;- paste0(nhood_df$tissue, \"_\", nhood_df$domain)\nnhood_df$tissue_domain &lt;- gsub(\"_nbors\", \"\", nhood_df$tissue_domain)\nnhood_df &lt;- nhood_df[!(nhood_df$sample_id == 'AJJB111_B1' & nhood_df$domain == 'PanIN_nbors'),]\nnhood_df$tissue_domain &lt;- gsub(\"PDAC_PanIN\", \"PanIN/GLTumor\", nhood_df$tissue_domain)\nnhood_df$tissue_domain &lt;- gsub(\"PDAC_PDTumor\", \"PDTumor\", nhood_df$tissue_domain)\nnhood_df$tissue_domain &lt;- factor(nhood_df$tissue_domain, levels = c(\"Healthy_Ducts\", \"Healthy_PanIN\",\n                                                                    \"PDAC_Ducts\", \"PanIN/GLTumor\", \"PDTumor\"))\ncomparisons &lt;- combn(unique(as.character(nhood_df$tissue_domain)), 2, simplify = F)\n\nplasma &lt;- nhood_df %&gt;% filter(nhood == 'Immune(Plasma_Cells)')\nplasma_boxplot &lt;- ggboxplot(plasma, x = 'tissue_domain', y = 'fraction', fill = 'domain', outlier.shape = NA) +\n  stat_compare_means(method = 'wilcox.test', comparisons = comparisons[c(1,2,3,4,5)], hide.ns = T) +\n  theme_bw(base_size = 10) +\n  # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  NoLegend() +\n  xlab(NULL) +\n  ylab(\"Plasma Fraction in 150\\u00B5 Neighborhood\") +\n  scale_fill_manual(values = c(\"Ducts_nbors\" = \"#984EA3\", \"PanIN_nbors\" = \"#F29403\", \"PDTumor_nbors\" = \"#F781BF\"))\nggsave(\"Nhood_PlasmaBoxPlot.pdf\", plasma_boxplot, width = 5, height = 5, units = 'in', dpi = 1200)\n\nmacs &lt;- nhood_df %&gt;% filter(nhood == 'Macrophages')\nmacs_boxplot &lt;- ggboxplot(macs, x = 'tissue_domain', y = 'fraction', fill = 'domain', outlier.shape = NA) +\n  stat_compare_means(method = 'wilcox.test', comparisons = comparisons[c(2,3,5,6,8,9,10)], hide.ns = T) +\n  theme_bw() +\n  NoLegend() +\n  xlab(NULL) + ylab(\"Macrophages Fraction in 150\\u00B5 Neighborhood\") +\n  scale_fill_manual(values = c(\"Ducts_nbors\" = \"#984EA3\", \"PanIN_nbors\" = \"#F29403\", \"PDTumor_nbors\" = \"#F781BF\"))\nggsave(\"Nhood_MacsBoxPlot.pdf\", macs_boxplot, width = 5, height = 5, units = 'in', dpi = 1200)\n\n# SpatialDimPlot Plasma + Macs ----------------------------------------------------------\n\nspatial@meta.data &lt;- mutate(spatial@meta.data, annotation = ifelse(main_annotation %in% c(\"Ducts\", \"PDTumor\", \"PanIN/GLTumor\", \"Plasma_Cells\", \"Macrophages\"), as.character(main_annotation), \"Other\"))\nspatial$annotation &lt;- factor(spatial$annotation, levels = c(\"Ducts\",\"PanIN/GLTumor\", \"PDTumor\", \"Plasma_Cells\", \"Macrophages\", \"Other\"))\n\nimmune_gol &lt;- SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = c(\"AJGG315_C2\")) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1))\nimmune_pdac &lt;- SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 5, cols = c(cols, \"Other\" = 'lightgrey'), images = c(\"SU.19.53682_B9\")) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1))\nimmune_combined &lt;- wrap_plots(immune_gol+ NoLegend(), immune_pdac + NoLegend())\nggsave(\"immune_combined_dimplot.pdf\", immune_combined, height = 5, width = 10, dpi = 1200)\nimmune_combined_legend &lt;- get_legend(DimPlot(spatial, group.by = 'annotation', cols = c(cols, \"Other\" = 'lightgrey')))\nggsave(\"immune_combined_dimplot_legend.pdf\", immune_combined_legend, height = 5, width = 2, dpi = 1200)\n\nrest_gol &lt;- c(\"AIH3216_C1\", \"AIJK200_C1\", \"AKJD206_C1\", \"AJJB111_B1\")\nrest_PDAC &lt;- c(\"SU.22.1926_A3\", \"SU.22.3416_A8\", \"SU.21.54126_D2\", \"SU.21.56758_I10\", \"SU.21.2784_B15\", \"SU.22.3416_A1\")\nrest_AdjNorm &lt;- c(\"SU.21.56768_E18\", \"SU.21.63367_AF52\")\n\nrest_immune &lt;- lapply(c(rest_gol, rest_PDAC, rest_AdjNorm), function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_immune &lt;- wrap_plots(rest_immune, ncol = 4)\nggsave(\"immune_rest.pdf\", rest_immune, height = 15, width = 20, dpi = 1200)\n\n\nrest_immune_gol &lt;- lapply(rest_gol, function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_immune_gol &lt;- wrap_plots(rest_immune_gol, nrow = 1)\nggsave(\"immune_rest_gol.pdf\", rest_immune_gol, height = 5, width = 20, dpi = 1200)\n\nrest_immune_pdac &lt;- lapply(rest_PDAC, function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_immune_pdac &lt;- wrap_plots(rest_immune_pdac, nrow = 2)\nggsave(\"immune_rest_pdac.pdf\", rest_immune_pdac, height = 10, width = 20, dpi = 1200)\n\nrest_immune_AdjNorm &lt;- lapply(rest_AdjNorm, function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_immune_AdjNorm &lt;- wrap_plots(rest_immune_AdjNorm, nrow = 1)\nggsave(\"immune_rest_Adjnorm.pdf\", rest_immune_AdjNorm, height = 10, width = 20, dpi = 1200)\n\n# SpatialDimPlot TLS ----------------------------------------------------------\n\nspatial@meta.data &lt;- mutate(spatial@meta.data, annotation = ifelse(main_annotation %in% c(\"PDTumor\", \"PanIN/GLTumor\", \"TLS\"), as.character(main_annotation), \"Other\"))\nspatial$annotation &lt;- factor(spatial$annotation, levels = c(\"PanIN/GLTumor\", \"PDTumor\", \"TLS\", \"Other\"))\ntls_gol &lt;- SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = c(\"AJGG315_C2\")) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1))\ntls_pdac &lt;- SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 5, cols = c(cols, \"Other\" = 'lightgrey'), images = c(\"SU.19.53682_B9\")) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1))\ntls_combined &lt;- wrap_plots(tls_gol+ NoLegend(), tls_pdac + NoLegend())\nggsave(\"tls_combined_dimplot.pdf\", tls_combined, height = 5, width = 10, dpi = 1200)\ntls_combined_legend &lt;- get_legend(DimPlot(spatial, group.by = 'annotation', cols = c(cols, \"Other\" = 'lightgrey')))\nggsave(\"tls_combined_dimplot_legend.pdf\", tls_combined_legend, height = 5, width = 2, dpi = 1200)\n\nrest_tls &lt;- lapply(c(rest_gol, rest_PDAC, rest_AdjNorm), function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_tls &lt;- wrap_plots(rest_tls, ncol = 4)\nggsave(\"tls_rest.pdf\", rest_tls, height = 15, width = 20, dpi = 1200)\n\nrest_gol &lt;- c(\"AIH3216_C1\", \"AIJK200_C1\", \"AKJD206_C1\", \"AJJB111_B1\")\nrest_tls_gol &lt;- lapply(rest_gol, function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_tls_gol &lt;- wrap_plots(rest_tls_gol, nrow = 1)\nggsave(\"tls_rest_gol.pdf\", rest_tls_gol, height = 5, width = 20, dpi = 1200)\n\nrest_PDAC &lt;- c(\"SU.22.1926_A3\", \"SU.22.3416_A8\", \"SU.21.54126_D2\", \"SU.21.56758_I10\", \"SU.21.2784_B15\", \"SU.22.3416_A1\")\nrest_tls_pdac &lt;- lapply(rest_PDAC, function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_tls_pdac &lt;- wrap_plots(rest_tls_pdac, nrow = 2)\nggsave(\"tls_rest_pdac.pdf\", rest_tls_pdac, height = 10, width = 20, dpi = 1200)\n\nrest_AdjNorm &lt;- c(\"SU.21.56768_E18\", \"SU.21.63367_AF52\")\nrest_tls_AdjNorm &lt;- lapply(rest_AdjNorm, function(x){\n  SpatialDimPlot(spatial, group.by = 'annotation', image.alpha = 0, pt.size.factor = 3, cols = c(cols, \"Other\" = 'lightgrey'), images = x) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1)) + NoLegend()\n})\nrest_tls_AdjNorm &lt;- wrap_plots(rest_tls_AdjNorm, nrow = 1)\nggsave(\"tls_rest_Adjnorm.pdf\", rest_tls_AdjNorm, height = 10, width = 20, dpi = 1200)\n\n# CCLs ViolinPlot --------------------------------------------------------\n\nccls_exp &lt;- VlnPlot2(spatial, c(\"CCL19\", \"CCL5\", \"CCL21\"), group.by = 'main_annotation', pt = F, box = F, cols = cols, ncol = 1) +\n  theme_classic(base_size = 10) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))+\n  NoLegend()\nggsave(\"ccls_exp.pdf\", ccls_exp, width = 4, height = 5, units = 'in', dpi = 600)\n\n# CCLs Moran --------------------------------------------------------------\n\nDefaultAssay(tumor_moran) &lt;- 'LRMoran'\nccl_ccr_vlnplot &lt;- VlnPlot2(tumor_moran, features = c('CCL19^CCR7', 'CCL5^CCR4', 'CCL21^CCR7'),\n                            group.by = 'main_annotation', pt = F, box = F, ncol = 1) +\n  theme_classic(base_size = 10) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  NoLegend()\nggsave(\"ccl_ccr_vlnplot.pdf\", ccl_ccr_vlnplot, width = 4, height = 5, units = 'in', dpi = 600)\n\n\n\nDefaultAssay(tumor_moran) &lt;- 'LRMoran'\nccl19_ccr7_pdac &lt;- SpatialFeaturePlot(tumor_moran, features = c('CCL19^CCR7'), image.alpha = 0, pt.size.factor = 5, images = c(\"SU.19.53682_B9\")) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1))\nggsave(\"ccl19_ccr7_pdac.pdf\", ccl19_ccr7_pdac, height = 5, width = 10, dpi = 1200)\n\nother_ccl_ccr &lt;- c('CCL21^CCR7', 'CCL5^CCR4')\nother_ccl_ccr_pdac &lt;- lapply(other_ccl_ccr, function(x){\n  SpatialFeaturePlot(tumor_moran, features = x, image.alpha = 0, pt.size.factor = 5, images = c(\"SU.19.53682_B9\")) + scale_y_reverse() + theme(panel.border = element_rect(colour = 'black', fill = NA, linewidth = 1))\n})\nother_ccl_ccr_pdac &lt;- wrap_plots(other_ccl_ccr_pdac, nrow = 1)\nggsave(\"other_ccl_ccr_pdac.pdf\", other_ccl_ccr_pdac, height = 5, width = 10, dpi = 1200)\n\n# CCL_CCR_DotPlot_scRef ---------------------------------------------------\n\nscRef$main_annotation_scvi &lt;- gsub(\"T_Cells\\\\(Hi_Ribo\\\\)\", \"T_Cells\", scRef$main_annotation_scvi)\nscRef[['Cell Type']] &lt;- factor(scRef$main_annotation_scvi,\n                               levels = c(\"CHRM3+\",\"Acinar\", \"Acinar/ADM\", \"ADM\", \"Ducts\", \"Tumor_Epithelial\",\n                                          \"Macrophages\", \"Granulocytes\", \"T_Cells\", \"NK_Cells\",\n                                          \"B_Cells\",\"Plasma\", \"Mast_Cells\",\n                                          \"Endothelial\", \"Lymphatic_Endothelial\", \"Endocrine\",\n                                          \"Fibroblasts\",\"Pericytes\",\n                                          \"Neurons\",\"Muscle\"))\n\nfeatures &lt;- list(\"Chemokine\" = c(\"CCL19\", \"CCL21\", \"CCL5\"), \"Receptors\" = c(\"CCR7\", \"CCR4\"))\nscRef_CCL_CCR_dotplot &lt;- DotPlot2(scRef, features = features, group.by = 'Cell Type', color_scheme = 'RdYlBu-rev')\nggsave(\"scRef_CCL_CCR_dotplot.pdf\", scRef_CCL_CCR_dotplot + NoLegend(), width = 5, height = 3, units = 'in', dpi = 600)\n\nscRef_CCL_CCR_dotplot_legend &lt;- get_legend(scRef_CCL_CCR_dotplot)\nggsave(\"scRef_CCL_CCR_dotplot_legend.pdf\", scRef_CCL_CCR_dotplot_legend, width = 2, height = 6, units = 'in', dpi = 600)\n\n# Nhood Histogram Healthy -------------------------------------------------------------------\ngol_samples_nhood &lt;- ggplot(gol_Nhood_Dist, aes(x = sample_id, y = fraction, fill = nhood)) +\n  geom_bar(stat = 'identity') +\n  facet_wrap(~ domain) +\n  scale_fill_manual(values = cols) +\n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"final_figures/gol_samples_nhood_histogram.pdf\", gol_samples_nhood, width = 10, height = 5, units = 'in', dpi = 1200)\n\n# Nhood Histogram Tumor -------------------------------------------------------------------\ntumor_samples_nhood &lt;- ggplot(tumor_Nhood_Dist, aes(x = sample_id, y = fraction, fill = nhood)) +\n  geom_bar(stat = 'identity') +\n  facet_wrap(~ domain) +\n  scale_fill_manual(values = cols) +\n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"final_figures/tumor_samples_nhood_histogram.pdf\", tumor_samples_nhood, width = 15, height = 5, units = 'in', dpi = 1200)"
  },
  {
    "objectID": "fig7.html",
    "href": "fig7.html",
    "title": "Figure 7",
    "section": "",
    "text": "Code\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratExtend)\n  library(CellChat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(EnhancedVolcano)\n  library(qs)\n  library(SPATA2)\n  library(patchwork)\n  library(pheatmap)\n  library(numbat)\n})\n\n# Improting data ----\n\nscRef &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef_filtered_integrated_annotated.qs\")\nscRef$main_annotation_scvi &lt;- gsub(\"T_Cells\\\\(Hi_Ribo\\\\)\", \"T_Cells\", scRef$main_annotation_scvi)\nscRef[['Cell Type']] &lt;- factor(scRef$main_annotation_scvi,\n                               levels = c(\"CHRM3+\",\"Acinar\", \"Acinar/ADM\", \"ADM\", \"Ducts\", \"Tumor_Epithelial\",\n                                          \"Macrophages\", \"Granulocytes\", \"T_Cells\", \"NK_Cells\",\n                                          \"B_Cells\",\"Plasma\", \"Mast_Cells\",\n                                          \"Endothelial\", \"Lymphatic_Endothelial\", \"Endocrine\",\n                                          \"Fibroblasts\",\"Pericytes\",\n                                          \"Neurons\",\"Muscle\"))\nscRef[['tissue']] &lt;- factor(scRef$tissue, levels = c(\"Healthy\", \"AdjNormal\", \"PDAC\"))\n\nspatial &lt;- qread(\"../outputs/Spatial_Clustering/spatial.qs\")\nfibro_aggregate &lt;- qread(\"../outputs/Fibroblasts_Analysis/stroma_aggregate_F2F3.qs\")\nepi &lt;- qread(\"../outputs/Epithelial_Analysis/epi_aggregate.qs\")\norganoids &lt;- qread(\"../outputs/Organoids_Data_Analysis/integrated_obj_tumor_only.qs\")\n\nDimPlot2(scRef, group.by = 'Cell Type', reduction = 'umap.scvi')\n\nDimPlot2(scRef, features = c(\"WNT2\", \"WNT5A\"), reduction = 'umap.scvi', pt.size = 3, priority = 'expr')\nDimPlot2(scRef, features = c(\"WNT7A\", \"WNT7B\", \"WNT10A\"), reduction = 'umap.scvi', pt.size = 2, priority = 'expr')\nDotPlot(scRef, features = , group.by = 'Cell Type')\n\nWNT_scRef_DotPlot &lt;- DotPlot2(scRef, features = c(\"LEF1\", \"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT7B\", \"WNT10A\"),\n                              group.by = 'Cell Type', color_scheme = 'RdYlBu-rev', flip = T)\nggsave(\"WNT_scRef_DotPlot.pdf\", WNT_scRef_DotPlot, width = 5, height = 5, units = 'in', dpi = 1200)\n\nWNT_spatial_DotPlot &lt;- DotPlot2(spatial, features = c(\"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT7B\", \"WNT10A\"),\n                                group.by = 'main_annotation', color_scheme = 'RdYlBu-rev', flip = T)\nggsave(\"WNT_spatial_DotPlot.pdf\", WNT_spatial_DotPlot, width = 5, height = 5, units = 'in', dpi = 1200)\n\n\nDefaultAssay(fibro_aggregate) &lt;- 'fibroexp'\nfibro_aggregate$main_annotation &lt;- factor(fibro_aggregate$main_annotation, levels = c(\"Fibro3\", \"Fibro2\"))\nLEF1_Fibro2_Fibro3_boxplot &lt;- VlnPlot2(fibro_aggregate, \"LEF1\", group.by = 'main_annotation', violin = F) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) +\n  NoLegend()\n\nWNT5A_Fibro2_Fibro3_boxplot &lt;- VlnPlot2(fibro_aggregate, \"WNT5A\", group.by = 'main_annotation', violin = F) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) +\n  NoLegend()\n\nWNT2_Fibro2_Fibro3_boxplot &lt;- VlnPlot2(fibro_aggregate, \"WNT2\", group.by = 'main_annotation', violin = F) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) +\n  NoLegend()\n\nWNT7A_PDTumor_boxplot &lt;- VlnPlot2(epi, features = \"WNT7A\", group.by = 'new_annotation', violin = F) + \n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) +\n  NoLegend()\n\nWNT7B_PDTumor_boxplot &lt;- VlnPlot2(epi, features = \"WNT7B\", group.by = 'new_annotation', violin = F) + \n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) +\n  NoLegend()\n\nWNT10A_PDTumor_boxplot &lt;- VlnPlot2(epi, features = \"WNT10A\", group.by = 'new_annotation', violin = F) + \n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) +\n  NoLegend()\ncombined_lef1_wnt_boxplots &lt;- wrap_plots(LEF1_Fibro2_Fibro3_boxplot, WNT2_Fibro2_Fibro3_boxplot, WNT5A_Fibro2_Fibro3_boxplot,\n                                         WNT7A_PDTumor_boxplot, WNT7B_PDTumor_boxplot, WNT10A_PDTumor_boxplot, nrow = 1)\nggsave(\"combined_lef1_wnt_boxplots.pdf\", combined_lef1_wnt_boxplots,  width = 10, height = 4, dpi = 300)\n\norganoids$final_annotation &lt;- factor(organoids$final_annotation, levels = c(\"CAFs(Monoculture)\", \"CAFs(Coculture)\", \"TumorOrganoids(Monoculture)\", \"TumorOrganoids(Coculture)\"))\norganoids_dimplot &lt;- DimPlot(organoids, group.by = 'final_annotation', cols = c(\"darkred\",\"blue\", \"darkorange\", \"darkgreen\")) + \n  theme(legend.position = 'top', legend.justification = 'center') +\n  guides(color = guide_legend(nrow = 2, override.aes = list(size = 3))) +\n  NoAxes() +\n  ggtitle(NULL)\nggsave(\"organoids_dimplot.pdf\", organoids_dimplot,  width = 6, height = 6, dpi = 300)\n\norganoids_fp &lt;- DimPlot2(organoids, features = c(\"PDGFRA\", \"EPCAM\", \"COL1A1\", \"KRT19\"), theme = list(NoAxes(), theme(legend.position = 'top', legend.justification = 'center'))) \nggsave(\"organoids_fp.pdf\", organoids_fp,  width = 8, height = 6, dpi = 300)\n\nlef1_wnt_organoids_dotplot &lt;- DotPlot2(organoids,\n                                       features = list(\"WNT Target\" = \"LEF1\",\n                                                       \"WNT Ligands\" = c(\"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT7B\", \"WNT10A\"),\n                                                       \"Classical PDAC Markers\" = c(\"MUC5AC\", \"TFF1\", \"GATA6\"),\n                                                       \"Basal PDAC Markers\" = c(\"KRT17\", \"S100A2\", \"KRT6A\")),\n                                       group.by = 'final_annotation',\n                                       color_scheme = 'RdYlBu-rev', flip = T, legend_position = 'top') +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) \nggsave(\"lef1_wnt_organoids_dotplot.pdf\", lef1_wnt_organoids_dotplot,  width = 12, height = 3, dpi = 300)\n\nclassical_basal_organoids_dotplot &lt;- DotPlot2(organoids,\n                                       features = list(),\n                                       group.by = 'final_annotation',\n                                       color_scheme = 'RdYlBu-rev', flip = T) +\n  theme(legend.position = 'top',\n        axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) \nggsave(\"classical_basal_organoids_dotplot.pdf\", classical_basal_organoids_dotplot,  width = 8, height = 5, dpi = 300)\n\nwnt_ligands &lt;- CellChatDB.human$interaction %&gt;% filter(pathway_name %in% c(\"ncWNT\", \"WNT\")) %&gt;% pull(ligand) %&gt;% unique()\nwnt_ligands &lt;- wnt_ligands[order(as.numeric(str_extract(wnt_ligands, '\\\\d+')))]\nwnt_receptors &lt;- CellChatDB.human$interaction %&gt;% filter(pathway_name %in% c(\"ncWNT\", \"WNT\")) %&gt;%\n  pull(receptor) %&gt;% strsplit(\"_\") %&gt;% unlist() %&gt;% unique()\nwnt_downstream &lt;- c(\"PORCN\" ,\"TCF3\", \"TCF4\",\"TCF7\",\"LEF1\", \"AXIN1\",\"AXIN2\")\n\nlef1_wnt_organoids_dotplot &lt;- DotPlot2(organoids,\n                                       features = list(\"WNT Ligands\" = wnt_ligands,\n                                                       \"WNT Target\" = wnt_receptors),\n                                       group.by = 'final_annotation',\n                                       color_scheme = 'RdYlBu-rev', flip = T) +\n  theme(legend.position = 'top',\n        axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = 'bold'),\n        axis.text.y = element_text(size = 10)) \n\nscRef_subset &lt;- subset(scRef, subset = tissue != \"AdjNormal\")\nscRef_subset &lt;- scRef_subset[,!(scRef_subset$tissue == \"Healthy\" & scRef_subset$main_annotation_scvi == 'Tumor_Epithelial')]\nspatial_subset &lt;- subset(spatial, subset = tissue != \"AdjNormal\")\nspatial_subset &lt;- spatial_subset[,!(spatial_subset$tissue == 'Healthy' & spatial_subset$main_annotation %in% c(\"Immune(TLS)\", \"Fibro2\", \"PDTumor\"))]\nDefaultAssay(spatial_subset) &lt;- 'Spatial'\n\nscRef_wnt &lt;- DotPlot2(scRef_subset,\n                      features = list(\"WNT Ligands\" = wnt_ligands,\n                                      \"WNT Receptoprs\" = wnt_receptors,\n                                      \"WNT Downstream Targets\" = wnt_downstream),\n                      group.by = 'Cell Type',\n                      split.by = 'tissue',\n                      color_scheme = 'RdYlBu-rev')\nggsave(\"scRef_wnt.pdf\", scRef_wnt,  width =15, height = 10, dpi = 300)\n\n\nspatial_wnt &lt;- DotPlot2(spatial_subset,\n                        features = list(\"WNT Ligands\" = wnt_ligands,\n                                        \"WNT Receptoprs\" = wnt_receptors,\n                                        \"WNT Downstream Targets\" = wnt_downstream),\n                        group.by = 'main_annotation',\n                        split.by = 'tissue',\n                        color_scheme = 'RdYlBu-rev')\nggsave(\"spatial_wnt.pdf\", spatial_wnt,  width = 15, height = 10, dpi = 300)\n\nscRef_wnt_subset &lt;- DotPlot2(scRef_subset[, scRef_subset$`Cell Type` %in% c(\"Ducts\", \"Tumor_Epithelial\", \"Fibroblasts\") & scRef_subset$tissue == 'PDAC'],\n                             features = list(\"WNT Ligands\" = c(\"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT10A\"),\n                                             \"WNT Receptoprs\" = c(\"FZD1\", \"FZD2\", \"FZD5\", \"FZD6\", \"FZD7\", \"FZD8\"),\n                                             \"WNT Downstream Targets\" = c(\"TCF3\",\"AXIN1\", \"TCF4\", \"AXIN2\", \"LEF1\")),\n                             group.by = 'Cell Type',\n                             scale = F,\n                             flip = T)\nggsave(\"final_figures/WntFig1A.pdf\", scRef_wnt_subset,  width = 10, height = 5, unit = 'in', dpi = 300)\n\nscRef_wnt_subset &lt;- DotPlot(scRef_subset[, scRef_subset$`Cell Type` %in% c(\"Ducts\", \"Tumor_Epithelial\", \"Fibroblasts\") & scRef_subset$tissue == 'PDAC'],\n                            features = c(\"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT10A\",\n                                         \"FZD1\", \"FZD2\", \"FZD5\", \"FZD6\", \"FZD7\", \"FZD8\",\n                                         \"TCF3\",\"AXIN1\", \"TCF4\", \"AXIN2\", \"LEF1\"),\n                            group.by = 'Cell Type',\n                            scale = F) +\n  scale_color_gradientn(colors = viridis(100, option = 'B')) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"final_figures/WntFig1Aa.pdf\", scRef_wnt_subset,  width = 10, height = 5, unit = 'in', dpi = 300)\n\nepi_wnt_featureplot &lt;- FeaturePlot(sc_epi, c(\"WNT7A\", \"WNT10A\"), order = T)\nggsave(\"final_figures/WntFig1Aaa.pdf\", epi_wnt_featureplot,  width = 10, height = 5, unit = 'in', dpi = 300)\n\n\nspatial_wnt_subset &lt;- DotPlot2(spatial_subset[, spatial_subset$main_annotation %in% c(\"Fibro2\", \"Fibro3\", \"Ducts\", \"PanIN/GLTumor\", \"PDTumor\") & spatial_subset$tissue == 'PDAC'],\n                               features = list(\"WNT Ligands\" = c(\"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT10A\"),\n                                               \"WNT Receptoprs\" = c(\"FZD1\", \"FZD2\", \"FZD5\", \"FZD6\", \"FZD7\", \"FZD8\"),\n                                               \"WNT Downstream Targets\" = c(\"TCF3\",\"AXIN1\", \"TCF4\", \"AXIN2\", \"LEF1\")),\n                               group.by = 'main_annotation',\n                               flip = T,\n                               color_scheme = 'RdYlBu-rev',\n                               legend_position = 'bottom')\nggsave(\"final_figures/WntFig1B.pdf\", spatial_wnt_subset,  width = 10, height = 5, dpi = 300)\n\nspatial_wnt_subset &lt;- DotPlot(spatial_subset[, spatial_subset$main_annotation %in% c(\"Fibro2\", \"Fibro3\", \"Ducts\", \"PanIN/GLTumor\", \"PDTumor\") & spatial_subset$tissue == 'PDAC'],\n                              features = c(\"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT10A\",\n                                           \"FZD1\", \"FZD2\", \"FZD5\", \"FZD6\", \"FZD7\", \"FZD8\",\n                                           \"TCF3\",\"AXIN1\", \"TCF4\", \"AXIN2\", \"LEF1\"),\n                              group.by = 'main_annotation',\n                              scale = F)+\n  scale_color_gradientn(colors = viridis(100, option = 'B')) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"final_figures/WntFig1Bb.pdf\", spatial_wnt_subset,  width = 10, height = 5, dpi = 300)\n\nfibro_subsets_wnt &lt;- DotPlot2(sc_fibro,\n                              features = list(\"WNT Ligands\" = c(\"WNT2\", \"WNT5A\"),\n                                              \"WNT Receptoprs\" = c(\"FZD1\", \"FZD2\", \"FZD6\", \"FZD7\"),\n                                              \"WNT Downstream Targets\" = c(\"TCF4\", \"AXIN2\", \"LEF1\")),\n                              group.by = 'fibro_subtypes',\n                              flip = T,\n                              color_scheme = 'RdYlBu-rev')\nggsave(\"final_figures/WntFig1C.pdf\", fibro_subsets_wnt,  width = 10, height = 5, dpi = 300)\n\nfibro_subsets_wnt &lt;- DotPlot(sc_fibro,\n                             features = c(\"WNT2\", \"WNT5A\", \"WNT7A\", \"WNT10A\", \"FZD1\", \"FZD2\", \"FZD5\", \"FZD6\", \"FZD7\", \"FZD8\", \"TCF3\",\"AXIN1\", \"TCF4\", \"AXIN2\", \"LEF1\"),\n                             group.by = 'fibro_subtypes',\n                             scale = F) +\n  scale_color_gradientn(colors = viridis(100, option = 'B')) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\"final_figures/WntFig1Cc.pdf\", fibro_subsets_wnt,  width = 10, height = 5, dpi = 300)\n\n\ntumor_moran &lt;- qread(\"outputs/CCC/liana_res_mapped_tumor_morans.qs\")\ngol_moran &lt;-  qread(\"outputs/CCC/liana_res_mapped_gol_morans.qs\")\nall_LR_GlobalMoran &lt;- qread(\"outputs/CCC/all_LR_GlobalMoran.qs\")\ndiffItx &lt;- qread(\"outputs/CCC/Differential_Itx.qs\")\ncellchat_tumor &lt;- qread(\"outputs/CCC/cellchat_tumor_all_domains.rds\")\ncellchat_gol &lt;- qread(\"outputs/CCC/cellchat_gol_all_domains.rds\")\naverage_TLS_dist &lt;- qread(\"outputs/Misc/average_TLS_nhood_dist.qs\")\ncols &lt;- scPalette(length(levels(spatial$main_annotation)))\nnames(cols) &lt;- levels(spatial$main_annotation)\n\ntls_pie_chart &lt;- ggplot(average_TLS_dist, aes(x = \"\", y = mean, fill = nhood)) +\n  geom_bar(stat = \"identity\", width = 1, color = 'white') +\n  coord_polar(\"y\") +\n  theme_void() +\n  facet_wrap(~domain) +\n  scale_fill_manual(values = cols) +\n  NoLegend()\nggsave(\"final_figures/SuppFig6Aa.pdf\", tls_pie_chart, width = 5, height = 5, units = 'in', dpi = 1200)\n\nlaminin_integrins &lt;- c(\"LAMB3^ITGA2_ITGB1\", \"LAMB3^ITGA3_ITGB1\",\"LAMB3^ITGA6_ITGB1\", \"LAMB3^ITGA6_ITGB4\",\n                       \"LAMC2^ITGA2_ITGB1\", \"LAMC2^ITGA3_ITGB1\",\"LAMC2^ITGA6_ITGB4\", \"LAMC2^ITGA6_ITGB1\",\n                       \"LAMA3^ITGA2_ITGB1\", \"LAMA3^ITGA3_ITGB1\", \"LAMA3^ITGA6_ITGB1\",\"LAMA3^ITGA6_ITGB4\",\"LAMA3^ITGA6_ITGB4\")\ncollagen_integrins &lt;- c(\"COL10A1^ITGA11_ITGB1\", \"COL10A1^ITGA2_ITGB1\",\"COL10A1^ITGA1_ITGB1\",\n                        \"COL17A1^ITGA2_ITGB1\",\"COL5A2^ITGA11_ITGB1\",\"COL5A1^ITGA11_ITGB1\",\n                        \"\")\nitx &lt;- c(\"SPINT1^ST14\", \"EFNA1^EPHA2\",\"CCN2^LRP1\",\n         \"MMP2^FGFR1\", \"POSTN^ITGAV_ITGB5\", \"POSTN^PTK7\",\n         \"PLAU^PLAUR\",\"CCL19^CCR7\",\n         \"TFF1^MUC5AC\", \"TFF2^MUC6\", \"GCG^FAP\", \"SST^SSTR1\", \"SST^SSTR3\"\n)\n\ndf &lt;- t(all_LR_GlobalMoran[,itx])\ncolnames(df) &lt;- all_LR_GlobalMoran$sample\nann &lt;- data.frame(tissue = all_LR_GlobalMoran$tissue, row.names = all_LR_GlobalMoran$sample)\npheatmap(df, annotation_col = ann, cluster_cols = F, cluster_rows = F, scale = 'row')\n\nEnhancedVolcano(diffItx,\n                lab = diffItx$pair,\n                labSize = 0,\n                x = 'mean_difference',\n                y = 'p_adj',\n                FCcutoff = 0.1,\n                pCutoff = 0.05,\n                xlim = c(-0.5,0.5),\n                ylim = c(0,3),\n                title = \"Differential Interactome Analysis\",\n                subtitle = NULL,\n                xlab = \"Mean Difference in LR Moran's I \\n\n                \\u2190 Interactions Enriched in GoL | Interactions Enriched in Tumor \\u2192\",\n                arrowheads = T, caption = NULL)\n\nall_samples_moran &lt;- merge(tumor_moran, gol_moran)\nDefaultAssay(all_samples_moran) &lt;- 'LRMoran'\nSpatialFeaturePlot(all_samples_moran, features = \"LAMC2^ITGA2-ITGB1\", images = c('SU.21.54126_D2'), pt.size.factor = 2)\nSpatialFeaturePlot(all_samples_moran, features = \"LAMC2^ITGA2-ITGB1\", images = c('AJGG315_C2'), pt.size.factor = 3)\nVlnPlot(tumor_moran, features = 'LAMC2^ITGA2-ITGB1', group.by = 'main_annotation', pt.size = 0) +\n  xlab(NULL) + ylab(\"Local Moran's I\") + NoLegend()\nnetVisual_aggregate(cellchat_tumor, signaling = 'LAMININ', sources.use = c(\"PanIN/GLTumor\", \"PDTumor\"),label.edge = T, layout = \"circle\", edge.weight.max = 3.2)\nnetVisual_aggregate(cellchat_gol, signaling = 'LAMININ', sources.use = c(\"PanIN/GLTumor\"),label.edge = T, layout = \"circle\", edge.weight.max = 3.2)\n\nSpatialFeaturePlot(all_samples_moran, features = \"CCL19^CCR7\", images = c('SU.19.53682_B9'), pt.size.factor = 4)\nSpatialFeaturePlot(all_samples_moran, features = \"CCL19^CCR7\", images = c('AJGG315_C2'), pt.size.factor = 3)\nVlnPlot(tumor_moran, features = 'CCL19^CCR7', group.by = 'main_annotation', pt.size = 0) +\n  xlab(NULL) + ylab(\"Local Moran's I\") + NoLegend()\nnetVisual_individual(cellchat_tumor, signaling = 'CCL', pairLR.use = 'CCL19_CCR7', sources.use = c(\"Immune(TLS)\"),label.edge = T, layout = \"chord\")\nnetVisual_chord_cell(cellchat_tumor, pairLR.use = data.frame('interaction_name' = 'CCL19_CCR7'))\n\nnetVisual_aggregate(cellchat_gol, signaling = 'LAMININ', sources.use = c(\"PanIN/GLTumor\"),label.edge = T, layout = \"circle\", edge.weight.max = 3.2)\n\nSpatialFeaturePlot(all_samples_moran, features = 'SPINT1^ST14', images = c('AJGG315_C2','SU.21.54126_D2'), pt.size.factor = 3)\nggplot(average_tumor_nhood_dist, aes(x = \"\", y = mean, fill = nhood)) +\n  geom_bar(stat = \"identity\", width = 1, color = 'white') +\n  coord_polar(\"y\") +\n  theme_void() +\n  facet_wrap(~domain) +\n  scale_fill_manual(values = cols)"
  },
  {
    "objectID": "scRNAseq_CellRanger.html",
    "href": "scRNAseq_CellRanger.html",
    "title": "CellRanger Alignmnet",
    "section": "",
    "text": "We aligned all the raw data using CellRanger (v7.1.0). We used the module installed on our HPC, but you can download as follows\n\ncurl -o cellranger-7.1.0.tar.gz \"https://cf.10xgenomics.com/releases/cell-exp/cellranger-7.1.0.tar.gz?Expires=1761892950&Key-Pair-Id=APKAI7S6A5RYOXBWRPDA&Signature=Q-tZwrJgZZlHEk3xY05gLIX~q-ZhDFa7UXGD0BpAnHZuxJQfyzMTyhwY3C6aE3ARRQfVS5XEVTlGiMQRX8~cFF7VzafPjFQPCAQD2sZjb1p4hmot0SqVRp4jCdf~ISTdr~I9pKMsjjkx3DtGSQ6htXAqKJYocn8UTz5fOHkLNCIlBeW4jykdacAFRZJVkAJAKxf0dBAned37xA9liwnx1nqFKPREbqpIdRW1e8wdSQiO4P50ODrnqMZ23q0Ylp7e7uqQoIIxD1~Nf6OcwwSg8ZLNnyZbyuMDB7CB74sad1SLyMQL9N2mMaZhg6krDsN001ATHWk4epNMOs95DONDKw__\"\nInstallation instructions can be found detailed here\n\nWe used GRCh38 reference genome that can be downloaded as follows\n\n# Create directory\nmkdir -p ../data/references\nrefDir=../data/references\n\n# Download reference file\ncurl --output ../data/references/refdata-gex-GRCh38-2020-A.tar.gz \\\nhttps://cf.10xgenomics.com/supp/cell-exp/refdata-gex-GRCh38-2020-A.tar.gz\n\n# Uncompress zipped file\ntar -xvf ../data/references/refdata-gex-GRCh38-2020-A.tar.gz \\\n-C ../data/references/\nrm ../data/references/refdata-gex-GRCh38-2020-A.tar.gz"
  },
  {
    "objectID": "scRNAseq_CellRanger.html#cellranger-and-reference-genome-configuration",
    "href": "scRNAseq_CellRanger.html#cellranger-and-reference-genome-configuration",
    "title": "CellRanger Alignmnet",
    "section": "",
    "text": "We aligned all the raw data using CellRanger (v7.1.0). We used the module installed on our HPC, but you can download as follows\n\ncurl -o cellranger-7.1.0.tar.gz \"https://cf.10xgenomics.com/releases/cell-exp/cellranger-7.1.0.tar.gz?Expires=1761892950&Key-Pair-Id=APKAI7S6A5RYOXBWRPDA&Signature=Q-tZwrJgZZlHEk3xY05gLIX~q-ZhDFa7UXGD0BpAnHZuxJQfyzMTyhwY3C6aE3ARRQfVS5XEVTlGiMQRX8~cFF7VzafPjFQPCAQD2sZjb1p4hmot0SqVRp4jCdf~ISTdr~I9pKMsjjkx3DtGSQ6htXAqKJYocn8UTz5fOHkLNCIlBeW4jykdacAFRZJVkAJAKxf0dBAned37xA9liwnx1nqFKPREbqpIdRW1e8wdSQiO4P50ODrnqMZ23q0Ylp7e7uqQoIIxD1~Nf6OcwwSg8ZLNnyZbyuMDB7CB74sad1SLyMQL9N2mMaZhg6krDsN001ATHWk4epNMOs95DONDKw__\"\nInstallation instructions can be found detailed here\n\nWe used GRCh38 reference genome that can be downloaded as follows\n\n# Create directory\nmkdir -p ../data/references\nrefDir=../data/references\n\n# Download reference file\ncurl --output ../data/references/refdata-gex-GRCh38-2020-A.tar.gz \\\nhttps://cf.10xgenomics.com/supp/cell-exp/refdata-gex-GRCh38-2020-A.tar.gz\n\n# Uncompress zipped file\ntar -xvf ../data/references/refdata-gex-GRCh38-2020-A.tar.gz \\\n-C ../data/references/\nrm ../data/references/refdata-gex-GRCh38-2020-A.tar.gz"
  },
  {
    "objectID": "scRNAseq_CellRanger.html#running-cellranger",
    "href": "scRNAseq_CellRanger.html#running-cellranger",
    "title": "CellRanger Alignmnet",
    "section": "Running CellRanger",
    "text": "Running CellRanger\nThe following shell script is submitted to a high-performance computing (HPC) cluster as a SLURM job array to process each of the samples in parallel.\nThe script pulls a cellranger_manifest.txt file from data directory with at two columns: sample_id and cellranger_output path for each sample as follow\n\n\n\nsample_1\npath/to/sample_1/fastq\n\n\nsample_2\npath/to/sample_2/fastq\n\n\nsample_3\npath/to/sample_3/fastq\n\n\n\n#!/bin/bash\n\n#SBATCH --account=\n#SBATCH --job-name='cellranger_hg38_%a'\n#SBATCH --output=logs/cellranger_hg38_%a.log\n\n#SBATCH --partition=standard\n#SBATCH --mem=128G\n#SBATCH --cpus-per-task=16\n#SBATCH --time=48:00:00\n\n#SBATCH --array=1-7\n\nmkdir -p logs\n\n# Import modules\nml cellranger/7.1.0\n\n# Setting up variables\nsamples_manifest=../data/cellranger_manifest.txt\nref=../data/references/refdata-gex-GRCh38-2020-A\noutputDir=../outputs/alignment\nmkdir -p $outputDir\n\n# Extracting sample for the current job \ncurrent_sample_name=$(cat $samples_manifest | cut -f1 | sed -n ${SLURM_ARRAY_TASK_ID}p)\ncurrent_sample_path=$(cat $samples_manifest | cut -f2 | sed -n ${SLURM_ARRAY_TASK_ID}p)\n\necho \"Analyzing Sample $current_sample_name\" \necho -e \"Fastq path $current_sample_path\"\n\n# Running cellranger\ncellranger count --id=${current_sample_name} \\\n--transcriptome=$ref \\\n--fastqs=$current_sample_path \\\n--sample=$current_sample_name \\\n--localcores=16\n\nmv ${current_sample_name} $outputDir"
  },
  {
    "objectID": "fig2.html",
    "href": "fig2.html",
    "title": "Figure 2",
    "section": "",
    "text": "Code\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(SeuratExtend)\n  library(CellChat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(EnhancedVolcano)\n  library(qs)\n  library(SPATA2)\n  library(patchwork)\n  library(pheatmap)\n  library(numbat)\n  library(cowplot)\n})\n\ndir.create(\"final_figures\", showWarnings = F, recursive = T)\nRdYlBu_scale &lt;- scale_color_gradientn(colors = c(\"blue\", \"yellow\", \"red\"))\n\nscRef &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef.qs\")\nclone_profiles &lt;- read.table(\n  \"../outputs/scRNAseq_Analysis/Numbat_Analysis/clone_profile.txt\",\n  header = T,\n  sep = '\\t'\n)\nspatial &lt;- qread(\n  \"../outputs/Spatial_Clustering/tumor_tumoradj_GoL_samples_annotated_v2_lite_new_deconv.qs\"\n)\nda_results &lt;- qread(\"../outputs/Spatial_Clustering/spatial_milo_da_results.qs\")\ntumor_spata2 &lt;- qread(\n  \"../outputs/Spatial_Clustering/tumor_sample_spata2_object.qs\"\n)\ngol_spata2 &lt;- qread(\"../outputs/Spatial_Clustering/gol_sample_spata2_object.qs\")\n\nNoTicks &lt;- theme(\n  axis.ticks = element_blank(),\n  axis.text = element_blank(),\n  axis.title = element_blank()\n)\nbreaks &lt;- str_c(0:20, \"mm\")\ncols &lt;- scPalette(length(levels(spatial$main_annotation)))\nnames(cols) &lt;- levels(spatial$main_annotation)\ntumor_axes &lt;- ggpLayerAxesSI(\n  tumor_spata2,\n  unit = \"mm\",\n  breaks = breaks,\n  add_labs = F\n)\ntumor_scalebar &lt;- ggpLayerScaleBarSI(\n  tumor_spata2,\n  sb_dist = \"1mm\",\n  text_size = 3,\n  sgmt_size = 0.5\n)\ngol_axes &lt;- ggpLayerAxesSI(\n  gol_spata2,\n  unit = \"mm\",\n  breaks = breaks,\n  add_labs = F\n)\ngol_scalebar &lt;- ggpLayerScaleBarSI(\n  gol_spata2,\n  sb_dist = \"1mm\",\n  text_size = 3,\n  sgmt_size = 0.5\n)\nthin_margin &lt;- theme(plot.margin = unit(c(0, 0, 0, 0), \"in\"))\npt_size = 0.1\n\n# scRNAseq_UMAP -----------------------------------------------------------------\nscRef$main_annotation_scvi &lt;- gsub(\n  \"T_Cells\\\\(Hi_Ribo\\\\)\",\n  \"T_Cells\",\n  scRef$main_annotation_scvi\n)\nscRef[['Cell Type']] &lt;- factor(\n  scRef$main_annotation_scvi,\n  levels = c(\n    \"CHRM3+\",\n    \"Acinar\",\n    \"Acinar/ADM\",\n    \"ADM\",\n    \"Ducts\",\n    \"Tumor_Epithelial\",\n    \"Macrophages\",\n    \"Granulocytes\",\n    \"T_Cells\",\n    \"NK_Cells\",\n    \"B_Cells\",\n    \"Plasma\",\n    \"Mast_Cells\",\n    \"Endothelial\",\n    \"Lymphatic_Endothelial\",\n    \"Endocrine\",\n    \"Fibroblasts\",\n    \"Pericytes\",\n    \"Neurons\",\n    \"Muscle\"\n  )\n)\nscRef[['tissue']] &lt;- factor(\n  scRef$tissue,\n  levels = c(\"Healthy\", \"AdjNormal\", \"PDAC\")\n)\nscCols &lt;- color_iwh(\n  n = length(levels(scRef$`Cell Type`)),\n  col.space = 'intense'\n)\nnames(scCols) &lt;- levels(scRef$`Cell Type`)\n\nall_cells_dimplot &lt;- DimPlot(\n  scRef,\n  group.by = \"Cell Type\",\n  reduction = 'umap.scvi',\n  split.by = 'tissue',\n  cols = scCols,\n  raster = T,\n  raster.dpi = c(1200, 1200),\n  pt.size = 3\n) +\n  ggtitle(NULL) +\n  NoAxes() +\n  ggtitle(\"Pancreas scRNAseq Atlas (208282 cells)\") +\n  NoLegend()\nggsave(\n  \"all_cells_dimplot.pdf\",\n  all_cells_dimplot,\n  width = 15,\n  height = 5,\n  dpi = 1200\n)\n\nall_cells_dimplot_legend &lt;- get_legend(\n  DimPlot(\n    scRef,\n    group.by = \"Cell Type\",\n    reduction = 'umap.scvi',\n    cols = scCols,\n    raster = T,\n    raster.dpi = c(1200, 1200),\n    pt.size = 3\n  ) +\n    guides(color = guide_legend(ncol = 1))\n)\nggsave(\n  \"all_cells_dimplot_legend.pdf\",\n  all_cells_dimplot_legend,\n  width = 2,\n  height = 5,\n  dpi = 1200\n)\n\n# Numbat_FeaturePlot -----------------------------------------------------------------\n\ntumor &lt;- subset(scRef, subset = tissue == 'PDAC')\ntumor$joint_cnv_prop[is.na(tumor$joint_cnv_prop)] &lt;- 0\n\nnumbat_fp &lt;- FeaturePlot(\n  tumor,\n  features = \"joint_cnv_prop\",\n  reduction = 'umap.scvi',\n  raster = T,\n  raster.dpi = c(1200, 1200),\n  cols = c(\"navy\", \"red3\"),\n  pt.size = 2\n) +\n  NoAxes() +\n  ggtitle(\"Joint CNV Probability\")\nggsave(\"Numbat_FeaturePlot.pdf\", numbat_fp, width = 5, height = 5, dpi = 1200)\n\n# Combined_HE -----------------------------------------------------------------\n\ntumor_he &lt;- plotSurface(tumor_spata2, pt_alpha = 0) +\n  tumor_scalebar +\n  NoTicks +\n  thin_margin\ngol_he &lt;- plotSurface(gol_spata2, pt_alpha = 0) +\n  gol_scalebar +\n  NoTicks +\n  thin_margin\ncombined_he &lt;- wrap_plots(list(gol_he, tumor_he), nrow = 2, ncol = 1) &\n  theme(plot.margin = margin(0, 0, 0, 0))\nggsave(\n  \"Combined_HE.pdf\",\n  combined_he,\n  width = 1.5,\n  height = 4,\n  units = 'in',\n  dpi = 2400\n)\n\n# Combined_Deconv_FeaturePlot -----------------------------------------------------------------\ntumor_acinar &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Acinar',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_epi &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Tumor Epithelial',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_ducts &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Ducts',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_fibro &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Fibroblasts',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\n\ngol_acinar &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Acinar',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_epi &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Tumor Epithelial',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_ducts &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Ducts',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_fibro &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Fibroblasts',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\n\nplot_list &lt;- list(\n  gol_acinar,\n  gol_epi,\n  gol_ducts,\n  gol_fibro,\n  tumor_acinar,\n  tumor_epi,\n  tumor_ducts,\n  tumor_fibro\n)\ncombined_deconv &lt;- wrap_plots(plot_list, nrow = 2, ncol = 4) &\n  theme(plot.margin = margin(0, 0, 0, 0))\nggsave(\n  \"Combined_Deconv_FeaturePlot.pdf\",\n  combined_deconv,\n  width = 6,\n  height = 4,\n  units = 'in',\n  dpi = 1200\n)\n\nlegend &lt;- get_legend(\n  plotSurface(\n    tumor_spata2,\n    color_by = 'Acinar',\n    pt_size = pt_size,\n    pt_alpha = 1\n  ) +\n    RdYlBu_scale +\n    labs(color = \"Cell Type Fraction\")\n)\nggsave(\n  \"Combined_Deconv_FeaturePlot_legend.pdf\",\n  legend,\n  width = 2,\n  height = 4,\n  units = 'in',\n  dpi = 1200\n)\n\n# Combined_SpatialClusters_SpatialDimPlot -----------------------------------------------------------------\ntumor_annotation &lt;- plotSurface(\n  tumor_spata2,\n  color_by = \"main_annotation\",\n  clrp_adjust = cols,\n  pt_size = 0.2\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin\ngol_annotation &lt;- plotSurface(\n  gol_spata2,\n  color_by = \"main_annotation\",\n  clrp_adjust = cols,\n  pt_size = 0.2\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin\ndomain_cols &lt;- cols\nnames(domain_cols) &lt;- levels(spatial$domains)\nlegend &lt;- get_legend(plotSurface(\n  gol_spata2,\n  color_by = \"domains\",\n  clrp_adjust = domain_cols,\n  pt_size = 0.2\n))\ncombined_annotation &lt;- wrap_plots(\n  list(gol_annotation, tumor_annotation),\n  nrow = 1,\n  ncol = 2\n) &\n  theme(plot.margin = margin(0, 0, 0, 0))\nggsave(\n  \"Combined_SpatialClusters_SpatialDimPlot.pdf\",\n  combined_annotation,\n  width = 6,\n  height = 3,\n  units = 'in',\n  dpi = 1200\n)\nggsave(\n  \"Combined_SpatialClusters_SpatialDimPlot_legend.pdf\",\n  legend,\n  width = 1,\n  height = 5,\n  units = 'in',\n  dpi = 1200\n)\n\n# Deconvolution_ViolinPlot -----------------------------------------------------------------\n\nDefaultAssay(spatial) &lt;- 'RCTD_sub_wts'\nfeatures &lt;- c(\n  \"Acinar\",\n  \"Acinar/ADM\",\n  \"Ducts\",\n  \"Tumor-Epithelial\",\n  \"Fibroblasts\",\n  \"Pericytes\",\n  \"Endocrine\",\n  \"Neurons\",\n  \"T-Cells\",\n  \"B-Cells\",\n  \"Plasma\",\n  \"Macrophages\"\n)\nvlnplot_deconv &lt;- VlnPlot(\n  spatial,\n  features = features,\n  cols = scCols,\n  fill.by = 'feature',\n  group.by = 'main_annotation',\n  pt.size = 0,\n  same.y.lims = T,\n  stack = T,\n  flip = T\n) +\n  ggtitle(NULL) +\n  NoLegend() +\n  xlab(NULL) +\n  ylab(\"Cell Type Fraction\")\nggsave(\n  \"Deconvolution_ViolinPlot.pdf\",\n  vlnplot_deconv,\n  width = 12,\n  height = 8,\n  units = 'in',\n  dpi = 1200\n)\n\n# SpatialClusters_UMAP -----------------------------------------------------------------\n\ndomains_col &lt;- scPalette(length(levels(spatial$domain_annotation)))\nnames(domains_col) &lt;- levels(spatial$domain_annotation)\n\nall_spatial_spots_dimplot &lt;- DimPlot(\n  spatial,\n  group.by = \"domain_annotation\",\n  cols = domains_col,\n  raster = T,\n  raster.dpi = c(1200, 1200),\n  pt.size = 2\n) +\n  ggtitle(NULL) +\n  NoAxes() +\n  ggtitle(\"Spatial Domains (164198 spots)\") +\n  NoLegend()\nggsave(\n  \"all_cells_dimplot.pdf\",\n  all_spatial_spots_dimplot,\n  width = 5,\n  height = 5,\n  dpi = 1200\n)\n\nall_spatial_spots_dimplot_legend &lt;- get_legend(\n  DimPlot(\n    spatial,\n    group.by = \"domain_annotation\",\n    cols = domains_col,\n    raster = T,\n    raster.dpi = c(1200, 1200),\n    pt.size = 2\n  ) +\n    guides(color = guide_legend(ncol = 1))\n)\nggsave(\n  \"all_spatial_spots_dimplot_legend.pdf\",\n  all_spatial_spots_dimplot_legend,\n  width = 2,\n  height = 5,\n  dpi = 1200\n)\n\n# SpatialClusters_Histogram --------------------------------------------------------------------\nspatial$tissue &lt;- factor(\n  spatial$tissue,\n  levels = c(\"Healthy\", \"AdjNormal\", \"PDAC\")\n)\nspatial_histogram_tissue &lt;- ClusterDistrBar(\n  spatial$tissue,\n  spatial$domain_annotation,\n  cols = domains_col,\n  flip = T,\n  border = 'white',\n  reverse_order = F\n) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  xlab(NULL) +\n  labs(fill = \"Spatial Domain\") +\n  NoLegend()\nggsave(\n  \"SpatialClusters_Histogram.pdf\",\n  spatial_histogram_tissue,\n  width = 10,\n  height = 3,\n  dpi = 300\n)\n\n# SpatialClusters_BeeswarmPlot -----------------------------------------------------------------\nbeeswarm_plot &lt;- plotDAbeeswarm(\n  da_results,\n  group.by = \"domain_annotation\",\n  alpha = 0.1\n) +\n  ylab(\"\\u2190 Enriched in Healthy | Enriched in PDAC \\u2192\") +\n  xlab(\"\") +\n  scale_color_distiller(palette = \"RdBu\", direction = -1) +\n  facet_wrap(~category, scales = 'free_y', ncol = 1)\nggsave(\n  \"SpatialClusters_BeeswarmPlot.pdf\",\n  beeswarm_plot,\n  width = 12,\n  height = 9,\n  units = 'in',\n  dpi = 1200\n)\n\n# scRNAseq_markers_DotPlot -----------------------------------------------------------------\nfeatures &lt;- list(\n  'Acinar/ADM Markers' = c(\n    \"CHRM3\",\n    \"MECOM\",\n    \"PRSS1\",\n    \"SPINK1\",\n    \"AMY2A\",\n    \"FXYD2\",\n    \"CFTR\",\n    \"AQP1\",\n    \"BICC1\"\n  ),\n  'Ductal/Tumor Markers' = c(\n    \"MUC6\",\n    \"SOX9\",\n    \"MUC5B\",\n    \"CRISP3\",\n    \"MSLN\",\n    \"CEACAM6\",\n    \"KRT19\",\n    \"KRT17\",\n    \"LAMB3\",\n    \"GPRC5A\",\n    \"KLK10\"\n  ),\n  'Immune Stroma Markers' = c(\n    \"APOE\",\n    \"CD68\",\n    \"S100A8\",\n    \"S100A9\",\n    \"FCGR3B\",\n    \"CSF3R\",\n    \"CD3E\",\n    \"IL7R\",\n    \"NKG7\",\n    \"GNLY\",\n    \"MS4A1\",\n    \"CD79A\",\n    \"JCHAIN\",\n    \"IGKC\"\n  ),\n  'Non-immune Stroma Markers' = c(\n    \"CPA3\",\n    \"TPSAB1\",\n    \"VWF\",\n    \"CDH5\",\n    \"NTS\",\n    \"MMRN1\",\n    \"PKHD1L1\",\n    \"INS\",\n    \"GCG\",\n    \"CHGA\",\n    \"PDGFRA\",\n    \"COL1A1\",\n    \"LUM\",\n    \"DCN\",\n    \"RGS5\",\n    \"TAGLN\",\n    \"PLP1\",\n    \"NRXN1\",\n    \"NCAM2\",\n    \"TRDN\",\n    \"MYBPC1\",\n    \"NEB\"\n  )\n)\n\nmarkers_dotplot &lt;- DotPlot2(\n  scRef,\n  features = features,\n  flip = T,\n  color_scheme = 'RdYlBu-rev',\n  group.by = 'Cell Type'\n)\nggsave(\n  \"scRNAseq_markers_DotPlot.pdf\",\n  markers_dotplot,\n  width = 15,\n  height = 5,\n  dpi = 300\n)\n\n# scRNAseq_Tissue_Histogram -----------------------------------------------------------------\nhistogram_tissue &lt;- ClusterDistrBar(\n  scRef$tissue,\n  scRef$`Cell Type`,\n  cols = 'iwh_intense',\n  flip = F,\n  border = 'white',\n  reverse_order = F\n) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\nggsave(\n  \"scRNAseq_Tissue_Histogram.pdf\",\n  histogram_tissue + NoLegend(),\n  width = 5,\n  height = 7,\n  dpi = 300\n)\n\n# scRNAseq_Samples_Histogram -------------------------------------------------------------\nscRef$sample_id &lt;- factor(\n  scRef$sample_id,\n  levels = unique(scRef$sample_id[order(scRef$tissue)])\n)\nhistogram_samples &lt;- ClusterDistrBar(\n  scRef$sample_id,\n  scRef$`Cell Type`,\n  cols = 'iwh_intense',\n  flip = F,\n  border = 'white',\n  reverse_order = F\n) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  guides(color = guide_legend(ncol = 1))\nggsave(\n  \"scRNAseq_Samples_Histogram.pdf\",\n  histogram_samples,\n  width = 15,\n  height = 7,\n  dpi = 300\n)\n\n# Numbat_Samples_FeaturePlot ---------------------------------------------------------------\n\ntumor_samples &lt;- SplitObject(tumor, split.by = 'sample_id')\nnumbat_fp_by_sample &lt;- lapply(tumor_samples, function(x) {\n  if (any(x$joint_cnv_prop &gt; 0)) {\n    FeaturePlot(\n      x,\n      features = \"joint_cnv_prop\",\n      reduction = 'umap.scvi',\n      raster = T,\n      raster.dpi = c(1200, 1200),\n      cols = c(\"navy\", \"red3\"),\n      pt.size = 3\n    ) +\n      NoAxes() +\n      ggtitle(unique(x$sample_id)) +\n      NoLegend()\n  }\n})\n\nnumbat_fp_by_sample &lt;- numbat_fp_by_sample[\n  !unlist(lapply(numbat_fp_by_sample, is.null))\n]\nnumbat_fp_by_sample &lt;- wrap_plots(numbat_fp_by_sample, ncol = 4)\n\nggsave(\n  \"Numbat_Samples_FeaturePlot.pdf\",\n  numbat_fp_by_sample,\n  width = 15,\n  height = 10,\n  dpi = 300\n)\n\n# Numbat_Clones_Heatmap ---------------------------------------------------------------\ncnv_heatmap &lt;- cnv_heatmap(clone_profiles, var = 'sample_clone')\nggsave(\n  \"Numbat_Clones_Heatmap.pdf\",\n  cnv_heatmap,\n  width = 20,\n  height = 10,\n  dpi = 300\n)\n\n# Supp_Combined_Deconv_FeaturePlot -------------------------------------------------------------\n\ntumor_macs &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Macrophages',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_tcells &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'T-Cells',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_bcells &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'B-Cells',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_plasma &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Plasma',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_endocrine &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Endocrine',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_pericytes &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Pericytes',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ntumor_neurons &lt;- plotSurface(\n  tumor_spata2,\n  color_by = 'Neurons',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\n\ngol_macs &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Macrophages',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_tcells &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'T-Cells',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_bcells &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'B-Cells',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_plasma &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Plasma',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_endocrine &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Endocrine',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_pericytes &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Pericytes',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\ngol_neurons &lt;- plotSurface(\n  gol_spata2,\n  color_by = 'Neurons',\n  pt_size = pt_size,\n  pt_alpha = 1\n) +\n  NoTicks +\n  NoLegend() +\n  thin_margin +\n  RdYlBu_scale\n\nplot_list &lt;- list(\n  gol_macs,\n  gol_tcells,\n  gol_bcells,\n  gol_plasma,\n  gol_endocrine,\n  gol_pericytes,\n  gol_neurons,\n  tumor_macs,\n  tumor_tcells,\n  tumor_bcells,\n  tumor_plasma,\n  tumor_endocrine,\n  tumor_pericytes,\n  tumor_neurons\n)\ncombined_deconv &lt;- wrap_plots(plot_list, nrow = 2, ncol = 7) &\n  theme(plot.margin = margin(0, 0, 0, 0))\nggsave(\n  \"final_figures/Supp_Combined_Deconv_FeaturePlot.pdf\",\n  combined_deconv,\n  width = 6,\n  height = 4,\n  units = 'in',\n  dpi = 1200\n)\n\nlegend &lt;- get_legend(\n  plotSurface(\n    tumor_spata2,\n    color_by = 'Macrophages',\n    pt_size = pt_size,\n    pt_alpha = 1\n  ) +\n    RdYlBu_scale +\n    labs(color = \"Cell Type Fraction\")\n)\nggsave(\n  \"final_figures/Supp_Combined_Deconv_FeaturePlot_legend.pdf\",\n  legend,\n  width = 2,\n  height = 4,\n  units = 'in',\n  dpi = 1200\n)\n\n# SpatialClusters_Markers_DotPlot -----------------------------------------------------------------\nfeatures_of_interest &lt;- list(\n  \"Epithelial Markers\" = c(\n    \"PRSS1\",\n    \"AMY2A\",\n    \"AQP1\",\n    \"FXYD2\",\n    \"CRISP3\",\n    \"MUC5B\",\n    \"MUC5AC\",\n    \"CLDN18\",\n    \"KRT17\",\n    \"KRT19\"\n  ),\n  \"Non-Immune Stroma\" = c(\n    \"COL1A1\",\n    \"PDGFRA\",\n    \"MMP11\",\n    \"CTHRC1\",\n    \"TAGLN\",\n    \"ACTA2\",\n    \"MYH11\",\n    \"RGS5\",\n    \"PLA2G2A\",\n    \"ADIPOQ\",\n    \"INS\",\n    \"GCG\",\n    \"NRXN1\",\n    \"MBP\",\n    \"NGFR\"\n  ),\n  \"Immune Stroma\" = c(\"CD3E\", \"GZMK\", \"CD79A\", \"JCHAIN\", \"SPP1\", \"APOE\", \"CD68\")\n)\nDefaultAssay(spatial) &lt;- 'Spatial'\nspatial_dotplot &lt;- DotPlot2(\n  spatial,\n  features = features_of_interest,\n  group.by = 'domain_annotation',\n  color_scheme = 'RdYlBu-rev',\n  flip = T,\n  show_grid = T\n)\nggsave(\n  \"SpatialClusters_Markers_DotPlot.pdf\",\n  spatial_dotplot,\n  width = 10,\n  height = 5,\n  units = 'in',\n  dpi = 1200\n)\n\n# SpatialClusters_Samples_Histogram -----------------------------------------------------------------\nspatial_histogram_sample &lt;- ClusterDistrBar(\n  spatial$sample_id,\n  spatial$domain_annotation,\n  cols = domains_col,\n  flip = F,\n  border = 'white',\n  reverse_order = F\n) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  xlab(NULL) +\n  labs(fill = \"Spatial Domain\")\nggsave(\n  \"SpatialClusters_Samples_Histogram.pdf\",\n  spatial_histogram_sample,\n  width = 14,\n  height = 7,\n  dpi = 300\n)"
  },
  {
    "objectID": "st_xenium_segmentation.html",
    "href": "st_xenium_segmentation.html",
    "title": "Xenium Resegmentation",
    "section": "",
    "text": "Here we will use Proseg (Jones et al. (2025)) for segmentation. The following script sets up a SLURM job for running Proseg on the Xenium data, then the data is converted to Bayesor format to be imported to the xenium.experiment file for viewing.\n#!/bin/bash\n\n#SBATCH --account=\n#SBATCH --job-name='proseg_%a'\n#SBATCH --output=logs/proseg_%a.log\n#SBATCH --partition=standard\n#SBATCH --mem=128G\n#SBATCH --cpus-per-task=16\n#SBATCH --time=24:00:00\n#SBATCH --array=2-4\n\nmkdir -p logs\nml xeniumranger\n\n# Setting up variables\nsamples_manifest=data/samples_manifest.txt\nsample=$(cat $samples_manifest | cut -f1 | sed -n ${SLURM_ARRAY_TASK_ID}p)\nxenium_outDir=$(cat $samples_manifest | cut -f2 | sed -n ${SLURM_ARRAY_TASK_ID}p)\n\nproseg ${xenium_outDir}/transcripts.parquet --xenium --output-path ${xenium_outDir}\n\nproseg-to-baysor \\\n    ${xenium_outDir}/transcript-metadata.csv.gz \\\n    ${xenium_outDir}/cell-polygons.geojson.gz \\\n    --output-transcript-metadata ${xenium_outDir}/baysor-transcript-metadata.csv \\\n    --output-cell-polygons ${xenium_outDir}/baysor-cell-polygons.geojson\n\nxeniumranger import-segmentation \\\n    --id ${sample} \\\n    --xenium-bundle ${xenium_outDir} \\\n    --viz-polygons ${xenium_outDir}/baysor-cell-polygons.geojson \\\n    --transcript-assignment ${xenium_outDir}/baysor-transcript-metadata.csv \\\n    --units microns\n\n\n\n\nReferences\n\nJones, Daniel C, Anna E Elz, Azadeh Hadadianpour, Heeju Ryu, David R Glass, and Evan W Newell. 2025. â€œCell Simulation as Cell Segmentation.â€ Nature Methods, 1â€“12."
  },
  {
    "objectID": "st_stroma_analysis.html",
    "href": "st_stroma_analysis.html",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "",
    "text": "Here we will be analyzing the stroma-enriched regions in the spatial transcriptomics data. We will be using the same hierarchical deconvolution used for the Stromal domains analysis using BayesPrism (Chu et al. 2022)."
  },
  {
    "objectID": "st_stroma_analysis.html#setup-and-import-data",
    "href": "st_stroma_analysis.html#setup-and-import-data",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "1 Setup and import data",
    "text": "1 Setup and import data\n\n\nCode\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(qs)\n  library(spatstat)\n  library(DESeq2)\n  library(PCAtools)\n  library(tidytext)\n  library(GSVA)\n})\n\nsamples_info &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")\n\n# Importing data ----------------------------------------------------------\n\nbp_scRef &lt;- qread(\"outputs/Deconvolution/BayesPrism_scRef.qs\")\nfibro &lt;- qread(\"outputs/scRNAseq_Analysis/fibro_all.qs\")\nmacs &lt;- qread(\"outputs/scRNAseq_Analysis/macs_all.qs\")\nmerged &lt;- qs::qread(\"outputs/Spatial_Clustering/tumor_tumoradj_GoL_samples_annotated_v2_lite_new_deconv.qs\")"
  },
  {
    "objectID": "st_stroma_analysis.html#subsetting-fibroblasts-enriched-domains",
    "href": "st_stroma_analysis.html#subsetting-fibroblasts-enriched-domains",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "2 Subsetting Fibroblasts-enriched domains",
    "text": "2 Subsetting Fibroblasts-enriched domains\n\n\nCode\ncols &lt;- scPalette(length(levels(merged$main_annotation)))\nnames(cols) &lt;- levels(merged$main_annotation)\nall_fibro &lt;- subset(merged,\n                    subset = main_annotation %in% c(\"Fibro1\", \"Fibro2\", \"Fibro3\", \"Fibro4(Hi_Mt)\"))\nhistogram_samples &lt;- ClusterDistrBar(all_fibro$tissue, all_fibro$main_annotation,\n                                     cols = cols, flip = F,\n                                     border = 'white', reverse_order = F) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  xlab(NULL) + ylab(\"% of Total Fibroblast-Enriched Domains\")\n\nstroma &lt;- subset(merged, subset = main_annotation %in% c(\"Fibro2\", \"Fibro3\"))\nstroma &lt;- RunUMAP(stroma, reduction = 'integrated.rpca', dims = 1:50)\nqsave(stroma, \"outputs/Fibroblasts_Analysis/spatial_stroma.qs\")\n\nsamples_keep &lt;- table(stroma$sample_id, stroma$main_annotation) %&gt;%\n  data.frame() %&gt;%\n  filter(Freq &gt; 50)\nstroma$sample_main_annotation &lt;- paste0(stroma$sample_id, \"_\", stroma$main_annotation)\nstroma &lt;- subset(stroma, subset = sample_main_annotation %in% paste0(samples_keep$Var1,\"_\", samples_keep$Var2))\n\nstroma_aggregate &lt;- AggregateExpression(stroma, assays = 'Spatial', group.by = c(\"main_annotation\", \"tissue\", \"sample_id\"), return.seurat = T)\nstroma_aggregate$main_annotation_tissue &lt;- paste0(stroma_aggregate$main_annotation, \"_\", stroma_aggregate$tissue)"
  },
  {
    "objectID": "st_stroma_analysis.html#generating-scref-bayesprism-reference",
    "href": "st_stroma_analysis.html#generating-scref-bayesprism-reference",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "3 Generating scRef BayesPrism Reference",
    "text": "3 Generating scRef BayesPrism Reference\n\n\nCode\n# Creating scRef ----------------------------------------------------------\nscRef &lt;- qread(\"outputs/scRNAseq_Analysis/scRef_filtered_integrated_annotated.qs\")\nscRef &lt;- subset(scRef, subset = tissue != 'AdjNormal')\nscRef &lt;- subset(scRef, subset = main_annotation_scvi != 'T_Cells(Hi_Rb)')\nscRef$main_annotation_scvi_tissue &lt;- paste0(scRef$main_annotation_scvi, \"_\", scRef$tissue)\n\nmetadata &lt;- scRef@meta.data\nsc.dat &lt;- t(GetAssayData(scRef, assay = 'RNA', layer = 'counts'))\nsc.dat.filtered &lt;- cleanup.genes(input=as.matrix(sc.dat),\n                                input.type=\"count.matrix\",\n                                species=\"hs\",\n                                gene.group=c(\"Rb\",\"Mrp\",\"other_Rb\",\"chrM\",\"MALAT1\",\"chrX\",\"chrY\") ,\n                                exp.cells=10)\nsc.dat.filtered.pc &lt;-  select.gene.type(sc.dat.filtered, gene.type = \"protein_coding\")\nrm(sc.dat.filtered); gc()\nscRef &lt;- list(sc.dat = sc.dat.filtered.pc, metadata = metadata)"
  },
  {
    "objectID": "st_stroma_analysis.html#extracting-fibroblast-specific-expression-from-spatial-domains",
    "href": "st_stroma_analysis.html#extracting-fibroblast-specific-expression-from-spatial-domains",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "4 Extracting Fibroblast-specific expression from spatial domains",
    "text": "4 Extracting Fibroblast-specific expression from spatial domains\n\n\nCode\nct_mtx &lt;- as.matrix(t(GetAssayData(stroma_aggregate, assay = 'Spatial', layer = 'counts')))\nintersect_genes &lt;- intersect(colnames(ct_mtx), colnames(bp_scRef$sc.dat))\nmyPrism &lt;- new.prism(\n  reference=bp_scRef$sc.dat[,intersect_genes],\n  mixture=ct_mtx[,intersect_genes],\n  input.type=\"count.matrix\",\n  cell.type.labels = bp_scRef$metadata$main_annotation_scvi,\n  cell.state.labels = bp_scRef$metadata$main_annotation_scvi_tissue,\n  key = 'Tumor_Epithelial')\nbp_res &lt;- run.prism(myPrism, n.cores = parallel::detectCores() - 1)\n\nstroma_aggregate[['fibroexp']] &lt;- CreateAssayObject(round(t(get.exp(bp_res, state.or.type = 'type', cell.name = 'Fibroblasts'))))\nstroma_aggregate[['celltype_fractions']] &lt;- CreateAssayObject(round(t(get.fraction(bp_res, which.theta = 'final', state.or.type = 'type')), digits = 2))\nstroma_aggregate@assays$fibroexp$data &lt;- vst(as.matrix(GetAssayData(stroma_aggregate, assay = 'fibroexp', layer = 'counts')))"
  },
  {
    "objectID": "st_stroma_analysis.html#pseudobulk-dge-analysis",
    "href": "st_stroma_analysis.html#pseudobulk-dge-analysis",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "5 Pseudobulk DGE analysis",
    "text": "5 Pseudobulk DGE analysis\nWe will use DESeq2 (Love, Huber, and Anders 2014) for differential expression analysis of the fibroblast-specific expression from Fibro2 and Fibro3 spatial domains.\n\n\nCode\nct_data &lt;- GetAssayData(stroma_aggregate, assay = 'fibroexp', layer = 'counts')\ncolData &lt;- stroma_aggregate@meta.data\nrun_id &lt;- samples_info %&gt;%\n  dplyr::select(patient_id, run_id) %&gt;%\n  dplyr::rename(sample_id = patient_id) %&gt;% \n  mutate(sample_id = gsub(\"\\\\_\", \"-\", sample_id)) %&gt;%\n  data.frame()\ncolData &lt;- merge(colData, run_id, by = 'sample_id') %&gt;%\n  column_to_rownames(var = 'orig.ident')\n\n# PCA\nvst &lt;- vst(as.matrix(ct_data))\npca &lt;- pca(vst, colData[colnames(vst),])\nqsave(pca, \"outputs/Fibroblasts_Analysis/fibro_aggregate_pca.qs\")\nbiplot(pca,\n       colby = 'main_annotation',\n       lab = NULL,\n       shape = 'tissue',\n       encircle = F, legendTitleSize = 12,\n       legendPosition = 'right')\n\ncolData$main_annotation &lt;- factor(colData$main_annotation, levels = c(\"Fibro3\", \"Fibro2\"))\ndds &lt;- DESeqDataSetFromMatrix(countData = ct_data,\n                              colData = colData[colnames(ct_data),],\n                              design = ~ sample_id + main_annotation)\n\ndds &lt;- DESeq(dds)\nstroma2_v_stroma3 &lt;- lfcShrink(dds, coef = 'main_annotation_Fibro2_vs_Fibro3', type = 'ashr') %&gt;% data.frame()\n\nEnhancedVolcano(\n  stroma3_v_stroma2,\n  rownames(stroma3_v_stroma2),\n  'log2FoldChange',\n  'padj',\n  pCutoff = 0.05,\n  title = 'Fibro3 vs Fibro2',\n  subtitle = NULL,\n  drawConnectors = T,\n  labSize = 2,\n  titleLabSize = 15,\n  legendPosition = 'none',\n  caption = NULL,\n  # border = 'full',\n  axisLabSize = 10\n)"
  },
  {
    "objectID": "st_stroma_analysis.html#hierarchical-deconvolution-using-scrnaseq-defined-fibroblast-subtypes",
    "href": "st_stroma_analysis.html#hierarchical-deconvolution-using-scrnaseq-defined-fibroblast-subtypes",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "6 Hierarchical Deconvolution using scRNAseq-defined fibroblast subtypes",
    "text": "6 Hierarchical Deconvolution using scRNAseq-defined fibroblast subtypes\nHere we will be using Fibroblast subtypes defined from scRNAseq data to dissect the composition of Fibro2 and Fibro3 spatial domains.\n\n6.1 Generating fibroblasts scRNAseq BayesPrism Reference\nWe will remove the AdjNormal tissue samples from scRNAseq reference in the analysis as we described in Epithelial Domains Analysis\n\n\nCode\nfibro &lt;- subset(fibro, subset = tissue != 'AdjNormal')\nmetadata &lt;- fibro@meta.data\nmetadata$fibro_subtypes_tissue &lt;- paste0(metadata$fibro_subtypes, \"_\", metadata$tissue)\nsc.dat &lt;- t(GetAssayData(fibro, assay = 'RNA', layer = 'counts'))\nsc.dat.filtered &lt;- cleanup.genes(input=as.matrix(sc.dat),\n                                 input.type=\"count.matrix\",\n                                 species=\"hs\",\n                                 gene.group=c( \"Rb\",\"Mrp\",\"other_Rb\",\"chrM\",\"MALAT1\",\"chrX\",\"chrY\") ,\n                                 exp.cells=5)\nsc.dat.filtered.pc &lt;-  select.gene.type(sc.dat.filtered, gene.type = \"protein_coding\")\nfibro_scRef &lt;- list(sc.dat = sc.dat.filtered.pc, metadata = metadata)\n\n\n\n\n6.2 Running BayesPrism\n\n\nCode\nct_mtx &lt;- as.matrix(t(GetAssayData(stroma_aggregate, assay = 'fibroexp', layer = 'counts')))\nintersect_genes &lt;- intersect(colnames(ct_mtx), colnames(fibro_scRef$sc.dat))\nmyPrism &lt;- new.prism(\n  reference=fibro_scRef$sc.dat[,intersect_genes],\n  mixture=ct_mtx[,intersect_genes],\n  input.type=\"count.matrix\",\n  cell.type.labels = fibro_scRef$metadata$fibro_subtypes,\n  cell.state.labels = fibro_scRef$metadata$fibro_subtypes_tissue,\n  key = NULL)\nfibro_bp_res &lt;- run.prism(myPrism, n.cores = parallel::detectCores() - 1)\nqsave(fibro_bp_res, \"outputs/Fibroblasts_Analysis/fibro_subtypes_F2F3.qs\")\n\nstroma_aggregate[['subtype_fractions']] &lt;- CreateAssayObject(round(t(get.fraction(fibro_bp_res, which.theta = 'final', state.or.type = 'type')), digits = 2))\nDefaultAssay(stroma_aggregate) &lt;-  'subtype_fractions'\nqsave(stroma_aggregate, \"outputs/Fibroblasts_Analysis/fibroblast_subtypes_deconvolution_F2F3.qs\")\n\n\n\n\n6.3 Visualizing Fibroblast Subtype Fractions\n\n\nCode\navg &lt;- AverageExpression(stroma_aggregate, assays = 'subtype_fractions', group.by = 'main_annotation_tissue')$subtype_fractions\navg &lt;- avg[c(4,7,1,3),c(2,4, 3,1)]\npheatmap(as.data.frame(avg), cluster_cols = F, cluster_rows = F, color = viridis(n = 100, option = 'B', direction = 1), cellwidth = 40, cellheight = 20)\n\nann &lt;- stroma_aggregate@meta.data %&gt;% dplyr::select(new_annotation)\nann$new_annotation &lt;- factor(ann$new_annotation,\n                             levels = c(\"Fibro3_GoL\", \"Fibro3_Tumor\", \"Fibro2_Tumor\"))\nfractions &lt;- get.fraction(fibro_bp_res, which.theta = 'final', state.or.type = 'type')\npheatmap(t(fractions)[c(4,7,1,3),order(ann$new_annotation)], \n         cellwidth = 10, cellheight = 10,\n         cluster_cols = F, cluster_rows = F, show_colnames = F, annotation_col = ann, viridis(option = 'B', n = 100, direction = 1))"
  },
  {
    "objectID": "st_stroma_analysis.html#hierarchical-deconvolution-using-scrnaseq-defined-macrophage-subtypes",
    "href": "st_stroma_analysis.html#hierarchical-deconvolution-using-scrnaseq-defined-macrophage-subtypes",
    "title": "Spatial Transcriptomics Stromal Domains Analysis",
    "section": "7 Hierarchical Deconvolution using scRNAseq-defined macrophage subtypes",
    "text": "7 Hierarchical Deconvolution using scRNAseq-defined macrophage subtypes\n\n7.1 Extracting Macrophage-specific expression from spatial domains\n\n\nCode\nspatial_macs &lt;- subset(merged, subset = main_annotation == 'Macrophages' & tissue == \"PDAC\")\nspatial_macs_aggregate &lt;- AggregateExpression(spatial_macs, assays = 'Spatial', group.by = c(\"sample_id\"), return.seurat = T)\n\nct_mtx &lt;- as.matrix(t(GetAssayData(spatial_macs_aggregate, assay = 'Spatial', layer = 'counts')))\nintersect_genes &lt;- intersect(colnames(ct_mtx), colnames(bp_scRef$sc.dat))\nmyPrism &lt;- new.prism(\n  reference=bp_scRef$sc.dat[,intersect_genes],\n  mixture=ct_mtx[,intersect_genes],\n  input.type=\"count.matrix\",\n  cell.type.labels = bp_scRef$metadata$main_annotation_scvi,\n  cell.state.labels = bp_scRef$metadata$main_annotation_scvi_tissue,\n  key = 'Tumor_Epithelial')\nbp_res &lt;- run.prism(myPrism, n.cores = parallel::detectCores() - 1)\n\nspatial_macs_aggregate[['macexp']] &lt;- CreateAssayObject(round(t(get.exp(bp_res, state.or.type = 'type', cell.name = 'Macrophages'))))\nspatial_macs_aggregate[['celltype_fractions']] &lt;- CreateAssayObject(round(t(get.fraction(bp_res, which.theta = 'final', state.or.type = 'type')), digits = 2))\nspatial_macs_aggregate@assays$macexp$data &lt;- vst(as.matrix(GetAssayData(spatial_macs_aggregate, assay = 'macexp', layer = 'counts')))\n\n\n\n\n7.2 Hierarchical Deconvolution using scRNAseq-defined fibroblast subtypes\n\n7.2.1 Generating macrophages scRNAseq BayesPrism Reference\n\n\nCode\nmacs &lt;- subset(macs, subset = tissue != 'AdjNormal')\nmetadata &lt;- macs@meta.data\nmetadata$macs_subtypes_tissue &lt;- paste0(metadata$macs_subtypes, \"_\", metadata$tissue)\nsc.dat &lt;- t(GetAssayData(macs, assay = 'RNA', layer = 'counts'))\nsc.dat.filtered &lt;- cleanup.genes(input=as.matrix(sc.dat),\n                                 input.type=\"count.matrix\",\n                                 species=\"hs\",\n                                 gene.group=c( \"Rb\",\"Mrp\",\"other_Rb\",\"chrM\",\"MALAT1\",\"chrX\",\"chrY\") ,\n                                 exp.cells=5)\nsc.dat.filtered.pc &lt;-  select.gene.type(sc.dat.filtered, gene.type = \"protein_coding\")\nmacs_scRef &lt;- list(sc.dat = sc.dat.filtered.pc, metadata = metadata)\n\n\n\n\n7.2.2 Running BayesPrism\n\n\nCode\nct_mtx &lt;- as.matrix(t(GetAssayData(spatial_macs_aggregate, assay = 'macexp', layer = 'counts')))\nintersect_genes &lt;- intersect(colnames(ct_mtx), colnames(macs_scRef$sc.dat))\nmyPrism &lt;- new.prism(\n  reference=macs_scRef$sc.dat[,intersect_genes],\n  mixture=ct_mtx[,intersect_genes],\n  input.type=\"count.matrix\",\n  cell.type.labels = macs_scRef$metadata$macs_subtypes,\n  cell.state.labels = macs_scRef$metadata$macs_subtypes_tissue,\n  key = NULL)\nmacs_bp_res &lt;- run.prism(myPrism, n.cores = parallel::detectCores() - 1)\n\n\n\n\n7.2.3 Visualizing Fibroblast Subtype Fractions\n\n\nCode\nspatial_macs_aggregate[['subtype_fractions']] &lt;- CreateAssayObject(round(t(get.fraction(macs_bp_res, which.theta = 'final', state.or.type = 'type')), digits = 2))\nDefaultAssay(spatial_macs_aggregate) &lt;-  'subtype_fractions'\nqsave(spatial_macs_aggregate, \"outputs/Macs_Analysis/macs_subtypes_deconvolution.qs\")\n\nplot_df &lt;- GetAssayData(spatial_macs_aggregate, assay = 'subtype_fractions') %&gt;%\n  data.frame() %&gt;%\n  rownames_to_column(\"mac_subtype\") %&gt;%\n  pivot_longer(cols = -mac_subtype, values_to = 'fraction')\n\nggplot(plot_df, aes(x = reorder_within(x = mac_subtype, within = mac_subtype, by = fraction), y = fraction)) +\n  geom_boxplot() +\n  scale_x_reordered() +\n  labs(x = \"Macrophage Subtype\", y = \"Fraction\", title = \"Macrophage Subtype Fractions in Spatial Domains\") +\n  theme_minimal()"
  },
  {
    "objectID": "scRNASeq_TCGA_Scoring.html",
    "href": "scRNASeq_TCGA_Scoring.html",
    "title": "TCGA-PAAD Scoring",
    "section": "",
    "text": "Here we will use GSVA (HÃ¤nzelmann, Castelo, and Guinney 2013) R package to score certain gene sets of interest in TCGA-PAAD dataset and get their correlation."
  },
  {
    "objectID": "scRNASeq_TCGA_Scoring.html#setup-and-data-import",
    "href": "scRNASeq_TCGA_Scoring.html#setup-and-data-import",
    "title": "TCGA-PAAD Scoring",
    "section": "Setup and data import",
    "text": "Setup and data import\nSeurat objects can be downloaded from Zenodo here.\n\n\nCode\nlibrary(TCGAbiolinks)\nlibrary(SummarizedExperiment)\nlibrary(edgeR)\nlibrary(qs)\nlibrary(Seurat)\nlibrary(GSVA)\nlibrary(tidyverse)\n\nfibro &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef_fibro.qs\")\nmacs &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef_macs.qs\")\n\nfibro_top_markers &lt;-  fibro@misc$markers %&gt;%\n  group_by(cluster) %&gt;%\n  top_n(n = 30, wt = scores) %&gt;%\n  dplyr::select(gene, cluster) %&gt;%\n  split(f = .$cluster) %&gt;%\n  lapply(pull, gene)\nfibro_top_markers &lt;- fibro_top_markers[-7]\n\nmacs_top_markers &lt;-  macs@misc$markers %&gt;%\n  group_by(cluster) %&gt;%\n  top_n(n = 30, wt = scores) %&gt;%\n  dplyr::select(gene, cluster) %&gt;%\n  split(f = .$cluster) %&gt;%\n  lapply(pull, gene)\nmacs_top_markers &lt;- macs_top_markers[-5]\n\n# Download TCGA-PAAD RNA-seq (raw counts)\nquery &lt;- GDCquery(project = \"TCGA-PAAD\",\n                  data.category = \"Transcriptome Profiling\",\n                  data.type = \"Gene Expression Quantification\",\n                  workflow.type = \"STAR - Counts\")\nGDCdownload(query)\ndata &lt;- GDCprepare(query)\n\n# Extract expression matrix\nexpr &lt;- assay(data, 'fpkm_uq_unstrand')\ngenes &lt;- rowData(data)$gene_name\nrownames(expr) &lt;- genes\nkeep &lt;- setdiff(genes, unique(genes[duplicated(genes)]))\nexpr &lt;- expr[keep,]\n\ntcga_gsva_scores &lt;- ssgseaParam(expr,\n                                # kcdf = 'Gaussian',\n                                geneSets = c(fibro_top_markers, macs_top_markers)) %&gt;%\n  gsva() %&gt;%\n  t()\n\nqsave(tcga_gsva_scores, \"../outputs/scRNAseq_Analysis/tcga_gsva_score.qs\")\n\n\n\n\nCode\ntcga_gsva_scores &lt;- qread(\"../outputs/scRNAseq_Analysis/tcga_gsva_score.qs\")\n\n\n\n\nCode\nmacs_scores &lt;- tcga_gsva_scores[,7:12]\nfibro_scores &lt;- tcga_gsva_scores[,1:6]\ncorr &lt;- cor(fibro_scores, macs_scores, method = 'pearson')\nmy_palette &lt;- colorRampPalette(c(\"blue\", \"red\"))(10)\npheatmap(corr, color = my_palette, border_color = 'white',angle_col = 45, display_numbers = T, fontsize_number = 15, number_color = 'white')\n\nggplot(tcga_gsva_scores, aes(x = `LRRC15+_Fibro`, y = `AltAct_Macs`)) +\n  geom_point() +\n  xlab(\"LRRC15+ Fibro Score\") + ylab(\"AltAct Fibro Score\") +\n  theme_bw()"
  },
  {
    "objectID": "scRNASeq_TCGA_Scoring.html#session-information",
    "href": "scRNASeq_TCGA_Scoring.html#session-information",
    "title": "TCGA-PAAD Scoring",
    "section": "Session Information",
    "text": "Session Information\n\n\nCode\nsessionInfo()"
  },
  {
    "objectID": "scRNAseq_processing.html",
    "href": "scRNAseq_processing.html",
    "title": "scRNAseq Data Processing and Integration",
    "section": "",
    "text": "Here, we load essential libraries and configure the reticulate package to use a specific Conda environment. This is crucial for running Python-based tools within the R environment. The exact conda environment used in this run can be installed using this yml file using conda env create -f single_cell.yml\n\n\nCode\nsuppressPackageStartupMessages({\nlibrary(Seurat)\nlibrary(SeuratWrappers)\nlibrary(tidyverse)\nlibrary(scCustomize)\nlibrary(CellChat)\nlibrary(slurmR)\nlibrary(reticulate)\nlibrary(qs)\nlibrary(numbat)\nlibrary(dplyr)\nlibrary(data.table)\nlibrary(stringr)\nlibrary(glue)\nlibrary(Matrix)\nlibrary(unix)\nlibrary(readxl)\n})\n\nuse_condaenv(\"path/to/conda/envs/single_cell/\", required = TRUE)\nsc &lt;- import(\"scanpy\", convert = F)\nanndata &lt;- import(\"anndata\", convert = F)\nscipy &lt;- import('scipy', convert = F)"
  },
  {
    "objectID": "scRNAseq_processing.html#setup-and-environment-configuration",
    "href": "scRNAseq_processing.html#setup-and-environment-configuration",
    "title": "scRNAseq Data Processing and Integration",
    "section": "",
    "text": "Here, we load essential libraries and configure the reticulate package to use a specific Conda environment. This is crucial for running Python-based tools within the R environment. The exact conda environment used in this run can be installed using this yml file using conda env create -f single_cell.yml\n\n\nCode\nsuppressPackageStartupMessages({\nlibrary(Seurat)\nlibrary(SeuratWrappers)\nlibrary(tidyverse)\nlibrary(scCustomize)\nlibrary(CellChat)\nlibrary(slurmR)\nlibrary(reticulate)\nlibrary(qs)\nlibrary(numbat)\nlibrary(dplyr)\nlibrary(data.table)\nlibrary(stringr)\nlibrary(glue)\nlibrary(Matrix)\nlibrary(unix)\nlibrary(readxl)\n})\n\nuse_condaenv(\"path/to/conda/envs/single_cell/\", required = TRUE)\nsc &lt;- import(\"scanpy\", convert = F)\nanndata &lt;- import(\"anndata\", convert = F)\nscipy &lt;- import('scipy', convert = F)"
  },
  {
    "objectID": "scRNAseq_processing.html#data-loading-and-object-preparation",
    "href": "scRNAseq_processing.html#data-loading-and-object-preparation",
    "title": "scRNAseq Data Processing and Integration",
    "section": "2 Data Loading and Object Preparation",
    "text": "2 Data Loading and Object Preparation\nWe use Seurat V2 (Hao et al. 2023) We define the main output directory where all results and intermediate files will be saved. We then read the sc_samples_manifest.xlsx from the data directory, containing metadata for each sample, which will be used to annotate the cells.\nWe load CellBender-processed HDF5 count data for each sample using Read_CellBender_h5_Mat from scCustomize R package, iterating through all sample IDs to read the data, create Seurat objects, and append metadata such as sample ID, patient ID, and tissue type from the manifest. Cell barcodes are prefixed with their sample IDs to ensure unique identifiers across samples, and all resulting Seurat objects are then merged into a single comprehensive object named ref.\n\n\nCode\noutputDir &lt;- '../outputs/scRNAseq_Analysis/'\ndir.create(outputDir, showWarnings = F, recursive = T)\n\nsamples_info &lt;- readxl::read_xlsx(\"../data/sc_samples_manifest.xlsx\")\n\nref &lt;- lapply(samples_info$sample_id, function(x) {\n  sample_info &lt;- samples_info %&gt;% filter(sample_id == x)\n  seurat &lt;- Read_CellBender_h5_Mat(paste0(\n    \"../outputs/scRNASeq_Analysis/cellbender/\",\n    x,\n    \"/\",\n    x,\n    \"_filtered.h5\"\n  )) %&gt;%\n    CreateSeuratObject()\n  seurat$sample_id &lt;- x\n  seurat$patient_id &lt;- sample_info$patient_id\n  seurat$tissue &lt;- sample_info$tissue\n  seurat &lt;- RenameCells(seurat, add.cell.id = x)\n  return(seurat)\n})\nref &lt;- reduce(ref, merge)\nref &lt;- JoinLayers(ref, assay = 'RNA')"
  },
  {
    "objectID": "scRNAseq_processing.html#quality-control-and-doublet-detection",
    "href": "scRNAseq_processing.html#quality-control-and-doublet-detection",
    "title": "scRNAseq Data Processing and Integration",
    "section": "3 Quality Control and Doublet Detection",
    "text": "3 Quality Control and Doublet Detection\n\n3.1 Initial QC Metrics and Filtering\nWe calculate the percentage of mitochondrial genes for each cell (percent.mt), a key quality control metric for cell quality. We also perform an initial filtering step to remove cells and genes that have zero counts across the entire dataset.\n\n\nCode\nref[[\"percent.mt\"]] &lt;- PercentageFeatureSet(object = ref, pattern = \"^MT-\")\nref &lt;- ref[,!(colSums(GetAssayData(ref, assay = 'RNA', layer = 'counts')) == 0)]\nref &lt;- ref[!(rowSums(GetAssayData(ref, assay = 'RNA', layer = 'counts')) == 0),]\n\n\n\n\n3.2 Doublet Detection with Scrublet\nWe run Scrublet (Wolock, Lopez, and Klein 2019), a Python-based tool, to identify potential doublets (two or more cells captured as a single droplet). We run it on each sample separately, then the results are transferred back to R and added as metadata to the main Seurat object.\n\n\nCode\nscrublet_res &lt;- lapply(unique(ref$sample_id), function(x) {\n  message(x)\n  sample &lt;- subset(ref, subset = sample_id == x)\n  adata &lt;- anndata$AnnData(\n    X = scipy$sparse$csr_matrix(\n      Matrix::t(LayerData(sample, assay = 'RNA', layer = \"counts\"))\n    )\n  )\n  sc$pp$scrublet(adata)\n  scrublet_res &lt;- py_to_r(adata$obs) %&gt;%\n    select(doublet_score, predicted_doublet)\n  rownames(scrublet_res) &lt;- colnames(sample)\n  scrublet_res$predicted_doublet &lt;- unlist(scrublet_res$predicted_doublet)\n  return(scrublet_res)\n}) %&gt;%\n  bind_rows()\nref &lt;- AddMetaData(ref, scrublet_res)\n\n\n\n\n3.3 Apply Filters\nWe apply standard quality control filters, removing cells with high mitochondrial content (percent.mt &lt; 15) or a low number of detected features (nFeature_RNA &gt; 200).\n\n\nCode\nref &lt;- subset(ref, subset = percent.mt &lt; 15 & nFeature_RNA &gt; 200)"
  },
  {
    "objectID": "scRNAseq_processing.html#data-integration",
    "href": "scRNAseq_processing.html#data-integration",
    "title": "scRNAseq Data Processing and Integration",
    "section": "4 Data Integration",
    "text": "4 Data Integration\n\n4.1 Normalization and Pre-processing\nBefore integration, we perform standard Seurat pre-processing steps. The RNA assay is split by sample to prepare for integration, the data is log-normalized, highly variable features are identified, the data is scaled, and Principal Component Analysis (PCA) is run.\n\n\nCode\nref[[\"RNA\"]] &lt;- split(ref[[\"RNA\"]], f = ref$sample_id)\nref &lt;- NormalizeData(ref)\nref &lt;- FindVariableFeatures(ref)\nref &lt;- ScaleData(ref)\nref &lt;- RunPCA(ref)\n\n\n\n\n4.2 Integration with scVI\nTo correct for batch effects between different samples, we perform data integration using scVI (Lopez et al. 2018), A deep learning-based method implemented via SeuratWrappers. A new dimensional reduction slots (integrated.scvi) is created in the Seurat object.\n\n\nCode\nref &lt;- IntegrateLayers(\n  object = ref,\n  method = scVIIntegration,\n  conda_env = \"path/to/conda/envs/single_cell/\",\n  new.reduction = \"integrated.scvi\",\n  verbose = TRUE\n)"
  },
  {
    "objectID": "scRNAseq_processing.html#dimensionality-reduction-and-clustering",
    "href": "scRNAseq_processing.html#dimensionality-reduction-and-clustering",
    "title": "scRNAseq Data Processing and Integration",
    "section": "5 Dimensionality Reduction and Clustering",
    "text": "5 Dimensionality Reduction and Clustering\n\n5.1 UMAP Embedding\nWe then calculate UMAP (Uniform Manifold Approximation and Projection) coordinates based on the scVI reduction.\n\n\nCode\nref &lt;- JoinLayers(ref)\nref &lt;- RunUMAP(\n  ref,\n  reduction = 'integrated.scvi',\n  dims = 1:30\n)\n\n\n\n\n5.2 Clustering and Annotation\nUsing the scVI-based reduction, we generate graph and perform graph-based clustering. A range of resolutions is tested (from 0.05 to 1.0) to explore different clustering granularities. The clustree (Zappia and Oshlack 2018) R package helps visualize how cells move between clusters at different resolutions, aiding in the selection of an optimal resolution.\nA final clustering resolution of 0.2 is chosen. We then find markers for these clusters and load a pre-defined annotation table from an Excel file scvi_cluster_annotation.xlsx in outputs/scRNAseq_Analysis/ directory, created to assign cell type labels to the clusters.\n\n\nCode\nref &lt;- FindNeighbors(ref, reduction = 'integrated.scvi', dims = 1:30)\nres &lt;- seq(from = 0.05, to = 1, by = 0.05)\nfor (x in res) {\n  ref &lt;- FindClusters(ref, resolution = x, cluster.name = paste0(\"res.\", x))\n}\nclustree(ref, prefix = 'res.', layout = \"sugiyama\")\nref &lt;- FindClusters(ref, cluster.name = 'scvi_clusters', resolution = 0.2)\nref@misc$markers_scvi &lt;- FindAllMarkers(ref, assay = 'RNA')\nref@misc$markers_scvi$score &lt;- ref@misc$markers_scvi$avg_log2FC *\n  ref@misc$markers_scvi$pct.1\n\nannotation &lt;- readxl::read_xlsx(\n  \"outputs/scRNAseq_Analysis/scvi_cluster_annotation.xlsx\"\n)\nCellTypes &lt;- setNames(annotation$celltype, annotation$cluster)\nIdents(ref) &lt;- ref$scvi_clusters\nref &lt;- RenameIdents(ref, CellTypes)\nref$CellTypes &lt;- Idents(ref)"
  },
  {
    "objectID": "scRNAseq_processing.html#finalize-cell-type-annotations-and-generate-plots",
    "href": "scRNAseq_processing.html#finalize-cell-type-annotations-and-generate-plots",
    "title": "scRNAseq Data Processing and Integration",
    "section": "6 Finalize Cell Type Annotations and Generate Plots",
    "text": "6 Finalize Cell Type Annotations and Generate Plots\n\n6.1 Renaming Clusters\nThe CellTypes metadata column is converted to a factor with a specific level order. This ensures that cell types appear in a consistent and logical order in all subsequent plots. A list of canonical marker genes is defined for visualization.\n\n\nCode\nref$main_annotation_scvi &lt;- factor(\n  ref$main_annotation_scvi,\n  levels = c(\n    \"CHRM3+\", \"Acinar\", \"Acinar/ADM\", \"ADM\", \"Ducts\", \"Tumor_Epithelial\",\n    \"Macrophages\", \"Granulocytes\", \"T_Cells\", \"NK_Cells\", \"B_Cells\", \"Plasma\", \"Mast_Cells\",\n    \"Endothelial\", \"Lymphatic_Endothelial\", \"Endocrine\", \"Fibroblasts\", \"Pericytes\",\n    \"Neurons\", \"Muscle\"))\n    \nfeatures &lt;- c(\n  \"CHRM3\",\"MECOM\",\"PRSS1\",\"SPINK1\",\"AMY2A\",\"SOX9\",\"MUC6\",\"FXYD2\",\"CFTR\",\"AQP1\",\"BICC1\",\"MUC5B\",\"CRISP3\",\"MSLN\",\n  \"CEACAM6\",\"KRT19\",\"KRT17\",\"LAMB3\",\"GPRC5A\",\"KLK10\",\"APOE\",\"CD68\",\"S100A8\",\"S100A9\",\"FCGR3B\",\"CSF3R\",\"CD3E\",\"IL7R\",\n  \"NKG7\",\"GNLY\",\"MS4A1\",\"CD79A\",\"JCHAIN\",\"IGKC\",\"CPA3\",\"TPSAB1\",\"VWF\",\"CDH5\",\"NTS\",\"MMRN1\",\"PKHD1L1\",\"INS\",\"GCG\",\n  \"CHGA\",\"PDGFRA\",\"COL1A1\",\"LUM\",\"DCN\",\"RGS5\",\"TAGLN\",\"PLP1\",\"NRXN1\",\"NCAM2\",\"TRDN\",\"MYBPC1\",\"NEB\"\n)\n\n\n\n\nCode\nref &lt;- qread(\"objects/scRef.qs\")\n\n\n\n\nCode\nDimPlot_scCustom(\n  ref,\n  group.by = 'CellTypes',\n  reduction = 'umap.scvi'\n)\nDotPlot_scCustom(\n  ref,\n  features = features,\n  group.by = 'CellTypes',\n  flip_axes = T,\n  x_lab_rotate = T\n) +\n  theme(\n    axis.text.x = element_text(face = 'bold'),\n    axis.text.y = element_text(face = 'bold')\n  )"
  },
  {
    "objectID": "scRNAseq_processing.html#save-final-annotated-object",
    "href": "scRNAseq_processing.html#save-final-annotated-object",
    "title": "scRNAseq Data Processing and Integration",
    "section": "7 Save Final Annotated Object",
    "text": "7 Save Final Annotated Object\nThe fully processed, integrated, and annotated Seurat object is saved to a file using qsave. This final object can be easily loaded for any further downstream analyses.\n\n\nCode\nqsave(ref, \"outputs/scRNAseq_Analysis/scRef.qs\")\n\n\nThe final processed file is deposited in Zenodo and can be downloaded from here"
  },
  {
    "objectID": "scRNAseq_processing.html#session-info",
    "href": "scRNAseq_processing.html#session-info",
    "title": "scRNAseq Data Processing and Integration",
    "section": "8 Session Info",
    "text": "8 Session Info\n\n\nCode\nsessionInfo()"
  },
  {
    "objectID": "st_xenium_viz.html",
    "href": "st_xenium_viz.html",
    "title": "Xenium Polygons Visualization",
    "section": "",
    "text": "Here we will be generating a sf object for each sampleâ€™s cell polygons for visualization. We are adding fibro2/fibro3 scores and the cell type annotation as well.\n\n\nCode\nsource(\"utils.R\")\nlibrary(qs)\nlibrary(Seurat)\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(ggnewscale)\n\nxenium_samples &lt;- qread(\"outputs/xenium_obj_harmony_integrated_w_fibro_scores.qs\")\nxenium_samples &lt;- SplitObject(xenium_samples, split.by = 'sample_id')\n\n# VR01 ---------------------------------------------------------------\n\nVR01_processed &lt;- xenium_samples[[1]]\nVR01_processed &lt;- RenameCells(VR01_processed, new.names = gsub(\"VR01_\", \"\", colnames(VR01_processed)))\nVR01 &lt;- ProsegToSeurat(\"outputs/proseg/VR01/\")\nVR01 &lt;- AddMetaData(VR01, metadata = VR01_processed@meta.data %&gt;%\n                      select(annotation, fibro2_sig_UCell, fibro2_score_scaled, fibro3_sig_UCell, fibro3_score_scaled, fibro_combined_score))\nVR01_cells_geometry &lt;- st_read(\"outputs/proseg/VR01/cell-polygons.geojson\")\nst_geometry(VR01_cells_geometry) &lt;- st_set_crs(st_geometry(VR01_cells_geometry), NA)\nVR01_cells_geometry$annotation &lt;- VR01$annotation\nVR01_cells_geometry$fibro3_sig_UCell &lt;- VR01$fibro3_sig_UCell\nVR01_cells_geometry$fibro3_score_scaled &lt;- VR01$fibro3_score_scaled\nVR01_cells_geometry$fibro2_sig_UCell &lt;- VR01$fibro2_sig_UCell\nVR01_cells_geometry$fibro2_score_scaled &lt;- VR01$fibro2_score_scaled\nVR01_cells_geometry$fibro_combined_score &lt;- VR01$fibro_combined_score\nVR01_cells_geometry &lt;- VR01_cells_geometry %&gt;% filter(!is.na(VR01_cells_geometry$annotation))\nVR01_cells_geometry &lt;- mutate(VR01_cells_geometry, annotation2 = ifelse(annotation %in% c(\"Tumor\"), as.character(annotation), \"Other\"))\nVR01_cells_geometry$annotation2 &lt;- factor(VR01_cells_geometry$annotation2, levels = c(\"Tumor\", \"Other\"))\nqsave(VR01_cells_geometry, \"outputs/VR01_cells_geometry.qs\")\n\n\nFor visualization we use\n\n\nCode\nvr01_polygons_non_fibro &lt;- VR01_cells_geometry %&gt;% dplyr::filter(annotation != 'Fibroblasts')\nvr01_fibro2_plot &lt;- ggplot(VR01_cells_geometry) +\n  rasterise(geom_sf(aes(fill = fibro2_score_scaled), linewidth = 0), dpi = 1200) +\n  scale_fill_gradient(low = \"green\", high = \"red\") +\n  new_scale_fill() +\n  rasterise(geom_sf(data = vr01_polygons_non_fibro, aes(fill = annotation2), linewidth = 0), dpi = 1200) +\n  scale_fill_manual(values = c(cols, \"Other\" = 'lightgrey')) +\n  labs(fill = NULL) +\n  theme_bw() +\n  theme(panel.grid = element_blank())"
  },
  {
    "objectID": "st_LIANA_Analysis.html",
    "href": "st_LIANA_Analysis.html",
    "title": "LIANA+ Analysis",
    "section": "",
    "text": "Here we will use LIANA+ (liana?) to analyze cell-cell communication in our dataset. LIANA+ uses geospatial metrics in cell-type agnostic approach to infer potential ligand-receptor interactions between spots. It only takes the expression values and spatial coordinates of the spots as input, and generates metrics for spatial correlation of their expression as a proxy for potential interactions."
  },
  {
    "objectID": "st_LIANA_Analysis.html#setup-and-data-import",
    "href": "st_LIANA_Analysis.html#setup-and-data-import",
    "title": "LIANA+ Analysis",
    "section": "1 Setup and data import",
    "text": "1 Setup and data import\nLIANA+ is a python-package, so we will use reticulate to interface with it with R. The exact conda environment used in this run can be installed using this yml file using conda env create -f liana.yml. Data can be downloaded from Zenodo here.\n\n\nCode\n# Setup -------------------------------------------------------------------\n\nsetwd(dirname(rstudioapi::getSourceEditorContext()$path))\n\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(tidyverse)\n  library(reticulate)\n  library(qs)\n  library(parallel)\n  library(pbapply)\n  use_condaenv(\"/envs/liana/\")\n})\n\nsc &lt;- import('scanpy', convert = F)\nli &lt;- import('liana', convert = F)\nad &lt;- import('anndata', convert = F)\nnp &lt;- import('numpy', convert = F)\n\nmerged &lt;- qread(\"outputs/Spatial_Clustering/tumor_tumoradj_GoL_samples_annotated_v2_lite_new_deconv.qs\")\n\n# Running LIANA on tumor samples ------------------------------------------\n\ntumor &lt;- subset(merged, subset = tissue == 'PDAC')\ntumor &lt;- SplitObject(tumor, split.by = 'sample_id')\n\ncl &lt;- makeCluster(detectCores() - 1) \nclusterEvalQ(cl, {\n  library(Seurat)\n  library(tidyverse)\n  library(reticulate)\n  library(qs)\n  library(parallel)\n  use_condaenv(\"/envs/liana/\")\n})\n\ntumor_LR_itx &lt;- pblapply(cl = cl, X = tumor, FUN = function(x){\n  \n  sc &lt;- import('scanpy', convert = F)\n  li &lt;- import('liana', convert = F)\n  ad &lt;- import('anndata', convert = F)\n  np &lt;- import('numpy', convert = F)\n  \n  DefaultAssay(x) &lt;- 'Spatial'\n  adata &lt;- ad$AnnData(\n    X = t(GetAssayData(x, assay = 'Spatial', layer = 'data')),\n    obs = x@meta.data\n  )\n  adata$var_names &lt;- rownames(x)\n  adata$obs_names &lt;- colnames(x)\n  adata$obsm['spatial'] &lt;- GetTissueCoordinates(x)[,c('x','y')]\n  bandwidth &lt;- li$ut$query_bandwidth(coordinates=adata$obsm['spatial'],\n                                     start= as.integer(0),\n                                     end= as.integer(500),\n                                     interval_n= as.integer(20)) %&gt;% py_to_r()\n  bandwidth &lt;- \n    bandwidth[[2]] %&gt;%\n    filter(neighbours == 6) %&gt;%\n    pull(bandwith) %&gt;%\n    min()\n  li$ut$spatial_neighbors(\n    adata,\n    bandwidth = as.integer(bandwidth),\n    cutoff = 0.1,\n    kernel = 'gaussian',\n    set_diag = TRUE\n  )\n  # li$pl$connectivity(adata, idx=as.integer(0), size=1.3)\n  lrdata = li$mt$bivariate(adata,\n                           resource_name='cellchatdb', \n                           local_name=\"norm_product\", \n                           global_name=\"morans\", \n                           n_perms=as.integer(100), \n                           mask_negatives=TRUE, \n                           add_categories=TRUE, \n                           nz_prop=0.01,\n                           use_raw=FALSE,\n                           verbose=TRUE\n  )\n  \n  ranked_itx &lt;- lrdata$var$sort_values(\"morans\", ascending=FALSE) %&gt;%\n    py_to_r() %&gt;%\n    mutate(p_adj = p.adjust(morans_pvals, method = 'BH')) %&gt;%\n    rownames_to_column(var = 'pair') \n  ranked_itx$sample &lt;- unique(py_to_r(lrdata$obs['sample_id']))\n  \n  co_exp &lt;- t(py_to_r(lrdata$X))\n  colnames(co_exp) &lt;- py_to_r(lrdata$obs_names$to_list())\n  rownames(co_exp) &lt;- py_to_r(lrdata$var_names$to_list())\n  \n  cats &lt;- t(py_to_r(lrdata$layers['cats']))\n  colnames(cats) &lt;- py_to_r(lrdata$obs_names$to_list())\n  rownames(cats) &lt;- py_to_r(lrdata$var_names$to_list())\n  \n  return(list(ranked_itx = ranked_itx, co_exp = co_exp, cats = cats))\n})\nqsave(tumor_LR_itx, \"liana_res_tumor_global_morans_local_norm_product.qs\")\n\ntumor_LR_itx &lt;- qread(\"liana_res_tumor_global_morans_local_norm_product.qs\")\ntumor_LR_ranks &lt;- lapply(tumor_LR_itx, function(x){x[[1]]}) %&gt;%\n  bind_rows()\n\ntumor &lt;- lapply(tumor, function(x){\n  x[['LRMoran']] &lt;- CreateAssayObject(tumor_LR_itx[[unique(x$sample_id)]][[2]])\n  x[['cat']] &lt;- CreateAssayObject(tumor_LR_itx[[unique(x$sample_id)]][[3]])\n  return(x)\n})\ntumor &lt;- reduce(tumor, merge)\ntumor &lt;- JoinLayers(tumor, assay = 'Spatial')\nqsave(tumor, \"liana_res_mapped_tumor_global_morans_local_norm_product.qs\")\n\n# Running LIANA on GoL samples ------------------------------------------\n\ngol &lt;- subset(merged, subset = tissue == 'Healthy')\nrm(merged);gc()\ngol &lt;- SplitObject(gol, split.by = 'sample_id')\n\ncl &lt;- makeCluster(detectCores() - 1) \nclusterEvalQ(cl, {\n  library(Seurat)\n  library(tidyverse)\n  library(reticulate)\n  library(qs)\n  library(parallel)\n  use_condaenv(\"envs/liana/\")\n})\n\nGoL_LR_itx &lt;- pblapply(cl = cl, X = gol, FUN = function(x){\n  \n  sc &lt;- import('scanpy', convert = F)\n  li &lt;- import('liana', convert = F)\n  ad &lt;- import('anndata', convert = F)\n  np &lt;- import('numpy', convert = F)\n  \n  DefaultAssay(x) &lt;- 'Spatial'\n  adata &lt;- ad$AnnData(\n    X = t(GetAssayData(x, assay = 'Spatial', layer = 'data')),\n    obs = x@meta.data\n  )\n  adata$var_names &lt;- rownames(x)\n  adata$obs_names &lt;- colnames(x)\n  adata$obsm['spatial'] &lt;- GetTissueCoordinates(x)[,c('x','y')]\n  bandwidth &lt;- li$ut$query_bandwidth(coordinates=adata$obsm['spatial'],\n                                     start= as.integer(0),\n                                     end= as.integer(500),\n                                     interval_n= as.integer(20)) %&gt;% py_to_r()\n  bandwidth &lt;- \n    bandwidth[[2]] %&gt;%\n    filter(neighbours == 6) %&gt;%\n    pull(bandwith) %&gt;%\n    min()\n  li$ut$spatial_neighbors(\n    adata,\n    bandwidth = as.integer(bandwidth),\n    cutoff = 0.1,\n    kernel = 'gaussian',\n    set_diag = TRUE\n  )\n  # li$pl$connectivity(adata, idx=as.integer(0), size=1.3)\n  lrdata = li$mt$bivariate(adata,\n                           resource_name='cellchatdb', \n                           local_name='norm_product', \n                           global_name=\"morans\", \n                           n_perms=as.integer(100), \n                           mask_negatives=TRUE, \n                           add_categories=TRUE, \n                           nz_prop=0.01,\n                           use_raw=FALSE,\n                           verbose=TRUE\n  )\n  \n  ranked_itx &lt;- lrdata$var$sort_values(\"morans\", ascending=FALSE) %&gt;%\n    py_to_r() %&gt;%\n    mutate(p_adj = p.adjust(morans_pvals, method = 'BH')) %&gt;%\n    rownames_to_column(var = 'pair') \n  ranked_itx$sample &lt;- unique(py_to_r(lrdata$obs['sample_id']))\n  \n  co_exp &lt;- t(py_to_r(lrdata$X))\n  colnames(co_exp) &lt;- py_to_r(lrdata$obs_names$to_list())\n  rownames(co_exp) &lt;- py_to_r(lrdata$var_names$to_list())\n  \n  cats &lt;- t(py_to_r(lrdata$layers['cats']))\n  colnames(cats) &lt;- py_to_r(lrdata$obs_names$to_list())\n  rownames(cats) &lt;- py_to_r(lrdata$var_names$to_list())\n  \n  return(list(ranked_itx = ranked_itx, co_exp = co_exp, cats = cats))\n})\nqsave(GoL_LR_itx, \"liana_res_gol_global_morans_local_norm_product.qs\")\n\ngol_LR_ranks &lt;- lapply(GoL_LR_itx, function(x){x[[1]]}) %&gt;%\n  bind_rows()\n\ngol &lt;- lapply(gol, function(x){\n  x[['LRMoran']] &lt;- CreateAssayObject(GoL_LR_itx[[unique(x$sample_id)]][[2]])\n  x[['cat']] &lt;- CreateAssayObject(GoL_LR_itx[[unique(x$sample_id)]][[3]])\n  return(x)\n})\n\ngol &lt;- reduce(gol, merge)\ngol &lt;- JoinLayers(gol, assay = 'Spatial')\nqsave(gol, \"liana_res_mapped_gol_global_morans_local_norm_product.qs\")\ngol &lt;-  qread(\"liana_res_mapped_gol_global_morans_local_norm_product.qs\")"
  },
  {
    "objectID": "st_epi_analysis.html",
    "href": "st_epi_analysis.html",
    "title": "Spatial Transcriptomics Epithelial Domains Analysis",
    "section": "",
    "text": "Here we perform analysis of the epithelial domains (Acinar, Ducts, PanINs, GLTumor, PDTumor) in our spatial transcriptomics data. We can download the spatial and scRNAseq seurat objects from Zenodo here."
  },
  {
    "objectID": "st_epi_analysis.html#setup",
    "href": "st_epi_analysis.html#setup",
    "title": "Spatial Transcriptomics Epithelial Domains Analysis",
    "section": "1 Setup",
    "text": "1 Setup\n\n\nCode\nsuppressPackageStartupMessages({\n  library(Seurat)\n  library(BayesPrism)\n  library(tidyverse)\n  library(CellChat)\n  library(monocle3)\n  library(tradeSeq)\n  library(SeuratWrappers)\n  library(qs)\n  library(clustree)\n  library(anndata)\n  library(reticulate)\n  library(PCAtools)\n  library(reshape2)\n  library(fgsea)\n  library(msigdbr)\n  library(tidytext)\n  library(clusterProfiler)\n  library(biomaRt)\n  library(enrichplot)\n  library(org.Hs.eg.db)\n  library(ReactomePA)\n  library(ggvenn)\n  library(SeuratExtend)\n})\n\nscRef &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef.qs\")\nspatial &lt;- qread(\"../outputs/Spatial_Clustering/spatial.qs\")\nsamples_info &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")"
  },
  {
    "objectID": "st_epi_analysis.html#subsetting-epithelial-domains",
    "href": "st_epi_analysis.html#subsetting-epithelial-domains",
    "title": "Spatial Transcriptomics Epithelial Domains Analysis",
    "section": "2 Subsetting Epithelial domains",
    "text": "2 Subsetting Epithelial domains\nWe will remove the PDTumor domains from Healthy and AdjNormal samples because they had very few spots within each sample and they donâ€™t correspond to the known histological phenotypes. We also remove PanIN/GLTumor domains from AJJB111_B1 sample for the same reason.\n\n\nCode\nall_epi &lt;- subset(\n  spatial,\n  subset = main_annotation %in%\n    c('Acinar1', 'Acinar2', 'Acinar3', 'Ducts', 'PanIN/GLTumor', 'PDTumor')\n)\nall_epi &lt;- all_epi[,\n  !(all_epi$main_annotation == \"PDTumor\" &\n    all_epi$tissue %in% c(\"Healthy\", \"AdjNormal\"))\n]\nall_epi &lt;- all_epi[,\n  !(all_epi$main_annotation == \"PanIN/GLTumor\" &\n    all_epi$sample_id == 'AJJB111_B1')\n]\n# samples_keep &lt;- table(all_epi$sample_id, all_epi$main_annotation) %&gt;%\n#   data.frame() %&gt;%\n#   filter(Freq &gt; 50)\n# all_epi$sample_main_annotation &lt;- paste0(all_epi$sample_id, \"_\", all_epi$main_annotation)\n# all_epi &lt;- subset(all_epi, subset = sample_main_annotation %in% paste0(samples_keep$Var1,\"_\", samples_keep$Var2))\nall_epi &lt;- RunUMAP(all_epi, reduction = 'integrated.rpca', dims = 1:50)\nqsave(all_epi, \"outputs/Epithelial_Analysis/all_epi_domains.qs\")\n\nepi &lt;- subset(\n  all_epi,\n  subset = main_annotation %in% c('PanIN/GLTumor', 'PDTumor')\n)\nepi$new_annotation &lt;- paste0(epi$tissue, \"_\", epi$main_annotation)\nepi$new_annotation &lt;- gsub(\"Tumor_PDTumor\", \"PDTumor\", epi$new_annotation)\nepi$new_annotation &lt;- gsub(\n  \"GoL_PanIN/GLTumor\",\n  \"Donor_PanIN\",\n  epi$new_annotation\n)\nepi$new_annotation &lt;- gsub(\n  \"TumorAdj_PanIN/GLTumor\",\n  \"TumorAdj_PanIN\",\n  epi$new_annotation\n)\nepi$new_annotation &lt;- gsub(\"Tumor_PanIN/GLTumor\", \"GLTumor\", epi$new_annotation)\nDefaultAssay(epi) &lt;- 'Spatial'\nepi &lt;- RunUMAP(epi, reduction = 'integrated.rpca', dims = 1:50)\nepi$new_annotation &lt;- factor(\n  epi$new_annotation,\n  levels = c(\"Donor_PanIN\", \"TumorAdj_PanIN\", \"GLTumor\", \"PDTumor\")\n)\nqsave(epi, \"outputs/Epithelial_Analysis/epi.qs\")"
  },
  {
    "objectID": "st_epi_analysis.html#pseudotime-analysis",
    "href": "st_epi_analysis.html#pseudotime-analysis",
    "title": "Spatial Transcriptomics Epithelial Domains Analysis",
    "section": "3 Pseudotime Analysis",
    "text": "3 Pseudotime Analysis\nHere we will run Pseudotime analysis using Palantir (Setty et al. 2019) on the neoplastic domains (PanINs, GLTumor, PDTumor).\n\n3.1 Environment Setup\nThe exact conda environment used in this run can be installed using this yml file using conda env create -f palantir.yml\n\n\nCode\nuse_condaenv(\"path/to/conda/envs/cellrank/\")\n\nad &lt;- import(\"anndata\", convert = T)\nscipy &lt;- import(\"scipy\", convert = T)\nsc &lt;- import('scanpy', convert = T)\npd &lt;- import('pandas', convert = T)\npl &lt;- import('palantir', convert = F)\n\n\n\n\n3.2 Convert Seurat to AnnData\nWe will convert the seurat object to anndata object to use with Palantir.\n\n\nCode\nadata &lt;- ad$AnnData(\n  X = scipy$sparse$csr_matrix(\n    Matrix::t(LayerData(epi, assay = 'Spatial', layer = 'data'))\n  ),\n  obs = epi@meta.data\n)\nadata$obs_names &lt;- colnames(epi)\nadata$var_names &lt;- rownames(epi)\nadata$obsm$X_integrated.rpca &lt;- epi@reductions$integrated.rpca@cell.embeddings\n\n\n\n\n3.3 Run Palantir\nWe will run palantir on the AnnData object, we will choose a cell from Donor PanINs as a root node. We use Monocle3 (Cao et al. 2019) to interactively choose a cell and determine the cell name for the start_cell argument in Palantir. We then add the pseudotime results to the original Seurat object.\n\n\nCode\n## Palantir Preprocessing\nsc$pp$neighbors(adata, use_rep = 'X_integrated.rpca')\npl$utils$run_diffusion_maps(\n  adata,\n  pca_key = 'X_integrated.rpca',\n  n_components = as.integer(5)\n)\npl$utils$determine_multiscale_space(adata)\npl$utils$run_magic_imputation(adata)\n\n## Choosing root node\ncds &lt;- as.cell_data_set(epi)\nchoose_cells(cds)\nstart_cell = 'AIH3216_C1_TAAGACTACCTGTCGG-1'\n\n## Running Palantir\npl$core$run_palantir(\n  adata,\n  early_cell = start_cell\n)\n\npl$presults$select_branch_cells(adata, q = .01, eps = .01)\npl$presults$compute_gene_trends(\n  adata,\n  expression_key = \"MAGIC_imputed_data\",\n)\n\nadata$write_h5ad(\"outputs/Epithelial_Analysis/palantir_processed_epi.h5ad\")\nepi &lt;- AddMetaData(\n  epi,\n  py_to_r(adata$obs) %&gt;% dplyr::select('palantir_pseudotime')\n)\nFeaturePlot(epi, features = 'palantir_pseudotime') +\n  scale_color_viridis_c() +\n  ggtitle(\"Estimated Pseudotime\")\nqsave(epi, \"outputs/Epithelial_Analysis/epi_w_palantir_pseudotime.qs\")\n\n\n\n\n3.4 Clustering gene trends\nThis part hasnâ€™t been included in the manuscript. Here we are clustering the genes based on their pseudotime expression trends.\n\n\nCode\n# Gene trends clustering\ngene_trends &lt;- adata$varm[['gene_trends_SU-21-2784_B15_GGTTACGTCAAGCAGG-1']]\npseudotime_vec &lt;- as.numeric(colnames(gene_trends))\nrownames(gene_trends) &lt;- rownames(epi)\ngeneVar &lt;- rowVars(as.matrix(gene_trends))\nhvg &lt;- geneVar[order(geneVar, decreasing = T)][1:2000] %&gt;% names()\nepi_markers &lt;- scRef_markers %&gt;%\n  filter(cluster == 'Tumor_Epithelial' & p_val_adj &lt; 0.05 & avg_log2FC &gt; 2) %&gt;%\n  pull(gene)\ngenes_of_interest &lt;- intersect(hvg, epi_markers)\n# genes_of_interest &lt;- unique(c(unlist(upreg_genes), unlist(dnreg_genes)))\nfiltered_gene_trends &lt;- gene_trends[genes_of_interest, ]\nscaled_gene_trends &lt;- scale(t(filtered_gene_trends))\nscaled_gene_trends_pca &lt;- pca(scaled_gene_trends)\nelbow &lt;- findElbowPoint(scaled_gene_trends_pca$variance)\n\ngenes_seurat &lt;- CreateSeuratObject(scaled_gene_trends)\ngenes_seurat[['pca']] &lt;- CreateDimReducObject(\n  embeddings = as.matrix(scaled_gene_trends_pca$rotated),\n  loadings = as.matrix(scaled_gene_trends_pca$loadings),\n  stdev = sqrt(scaled_gene_trends_pca$variance),\n  assay = 'RNA',\n  key = 'pca_'\n)\ngenes_seurat &lt;- FindNeighbors(genes_seurat, reduction = 'pca', dims = 1:elbow)\ngenes_seurat &lt;- RunUMAP(genes_seurat, reduction = 'pca', dims = 1:elbow)\ngenes_seurat &lt;- FindClusters(genes_seurat, algorithm = 4)\nnew_idents &lt;- paste0(\"GeneSet\", seq(1:9))\nnames(new_idents) &lt;- c(2, 4, 7, 6, 5, 3, 8, 1, 9)\ngenes_seurat &lt;- RenameIdents(genes_seurat, new_idents)\ngenes_seurat$geneset &lt;- Idents(genes_seurat)\nqsave(genes_seurat, \"outputs/Epithelial_Analysis/genes_seurat.qs\")\ngenes_seurat &lt;- qread(\"outputs/Epithelial_Analysis/genes_seurat.qs\")\n\n## Plotting\nclusters &lt;- genes_seurat@meta.data %&gt;%\n  dplyr::select(geneset) %&gt;%\n  rownames_to_column() %&gt;%\n  `colnames&lt;-`(c(\"gene\", \"cluster\"))\nclusters$cluster &lt;- as.character(clusters$cluster)\ntrends &lt;- t(scaled_gene_trends) %&gt;%\n  data.frame() %&gt;%\n  rownames_to_column('gene') %&gt;%\n  melt() %&gt;%\n  `colnames&lt;-`(c(\"gene\", \"pseudotime\", 'expression')) %&gt;%\n  mutate(pseudotime = gsub(\"^X\", \"\", pseudotime)) %&gt;%\n  mutate(\n    pseudotime = as.numeric(pseudotime),\n    expression = as.numeric(expression)\n  ) %&gt;%\n  merge(clusters, by = 'gene')\n\n\ngenes_seurat$geneset &lt;- factor(genes_seurat$geneset, levels = new_idents)\nann &lt;- data.frame(\n  pseudotime = as.numeric(rownames(scaled_gene_trends)),\n  row.names = rownames(scaled_gene_trends)\n)\nann_cols = list(\n  pseudotime = viridis(dim(scaled_gene_trends)[1]),\n  geneset = setNames(brewer.pal(9, \"Set1\"), levels(genes_seurat$geneset))\n)\nrow_ann &lt;- genes_seurat@meta.data %&gt;% dplyr::select(geneset)\npheatmap(\n  t(scaled_gene_trends)[order(genes_seurat$geneset), ],\n  annotation_names_row = T,\n  annotation_row = row_ann,\n  annotation_col = ann,\n  annotation_colors = ann_cols,\n  show_colnames = F,\n  show_rownames = F,\n  fontsize = 5,\n  cluster_cols = F,\n  cluster_rows = F\n)\n\nggplot(trends, aes(x = pseudotime, y = expression, group = gene)) +\n  geom_line() +\n  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +\n  facet_wrap(~cluster)\n\nlibrary(org.Hs.eg.db)\nlibrary(AnnotationDbi)\ngeneid &lt;- mapIds(\n  org.Hs.eg.db,\n  keys = colnames(genes_seurat),\n  column = \"ENTREZID\",\n  keytype = \"SYMBOL\",\n  multiVals = \"first\"\n) %&gt;%\n  data.frame() %&gt;%\n  `colnames&lt;-`('geneid')\ngenes_seurat &lt;- AddMetaData(genes_seurat, geneid)\nhallmarks_enrich &lt;- genes_seurat@meta.data %&gt;%\n  dplyr::select(geneset, geneid) %&gt;%\n  rownames_to_column(var = 'gene') %&gt;%\n  group_by(geneset) %&gt;%\n  # reframe(enrichment = enrichWP(geneid, organism = \"Homo sapiens\")@result)\n  reframe(enrichment = enricher(gene, TERM2GENE = term2gene)@result) %&gt;%\n  unnest(cols = c(enrichment)) %&gt;%\n  mutate(ID = gsub(\"HALLMARK_\", \"\", ID))\n\nplot_df &lt;- hallmarks_enrich %&gt;%\n  filter(p.adjust &lt; 0.05) %&gt;%\n  dplyr::select(geneset, p.adjust, ID, Count)\n\nggplot(\n  plot_df,\n  aes(\n    x = Count,\n    y = reorder_within(ID, within = geneset, by = Count),\n    fill = p.adjust\n  )\n) +\n  geom_bar(stat = 'identity') +\n  scale_y_reordered() +\n  scale_fill_gradient(low = \"red\", high = \"blue\") +\n  facet_wrap(~geneset, ncol = 1, scales = 'free') +\n  theme_bw() +\n  theme(\n    axis.text.y = element_text(size = 7, face = 'bold'),\n    legend.position = 'left'\n  ) +\n  ylab(NULL) +\n  xlab(\"Gene Count\")\n\n\ncellType_pseudotime &lt;- epi@meta.data %&gt;%\n  dplyr::select(clusters, palantir_pseudotime) %&gt;%\n  `colnames&lt;-`(c(\"cellType\", \"pseudotime\")) %&gt;%\n  mutate(y_coord = -4)\nexp &lt;- GetAssayData(epi, assay = 'Spatial', layer = 'scale.data')['GKN1', ]\nexp &lt;- merge(data.frame(exp), cellType_pseudotime, by = 0)\nexp_trend &lt;- trends %&gt;% filter(gene == 'GKN1')\nggplot() +\n  geom_line(data = exp_trend, mapping = aes(x = pseudotime, y = expression))\n# theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +\n# geom_jitter(data = exp, height = 0.5, size = 0.5, mapping = aes(x = pseudotime, y = exp, color = cellType))"
  },
  {
    "objectID": "st_epi_analysis.html#bayesprism-pseudobulk-deconvolution",
    "href": "st_epi_analysis.html#bayesprism-pseudobulk-deconvolution",
    "title": "Spatial Transcriptomics Epithelial Domains Analysis",
    "section": "4 BayesPrism Pseudobulk Deconvolution",
    "text": "4 BayesPrism Pseudobulk Deconvolution\nDue to convolved nature of Visium profiling, we will use BayesPrism (Chu et al. 2022) for deconvolution of the neoplastic domains to extract their epithelial-specific expression.\n\n4.1 Generate scRNAseq reference for BayesPrism\nWe will remove the Adjacent normal samples and T cells cluster that was found to have high ribosomal genes. BayesPrism takes celltypes and cellstates arguments which represents two heirarchecal levels of annotation. We will use the Cell Types as our celltypes, where as Cell Types & Tissue as our cellstates.\n\n\nCode\nscRef &lt;- subset(scRef, subset = tissue != 'AdjNormal')\nscRef &lt;- subset(scRef, subset = main_annotation_scvi != 'T_Cells(Hi_Rb)')\nscRef$main_annotation_scvi_tissue &lt;- paste0(\n  scRef$main_annotation_scvi,\n  \"_\",\n  scRef$tissue\n)\n\nmetadata &lt;- scRef@meta.data\nsc.dat &lt;- t(GetAssayData(scRef, assay = 'RNA', layer = 'counts'))\nrm(scRef)\ngc()\nsc.dat.filtered &lt;- cleanup.genes(\n  input = as.matrix(sc.dat),\n  input.type = \"count.matrix\",\n  species = \"hs\",\n  gene.group = c(\"Rb\", \"Mrp\", \"other_Rb\", \"chrM\", \"MALAT1\", \"chrX\", \"chrY\"),\n  exp.cells = 10\n)\nsc.dat.filtered.pc &lt;- select.gene.type(\n  sc.dat.filtered,\n  gene.type = \"protein_coding\"\n)\nrm(sc.dat.filtered)\ngc()\nscRef &lt;- list(sc.dat = sc.dat.filtered.pc, metadata = metadata)\n\n\n\n\n4.2 Pseudobulk Deconvolution\nHere we aggregate the counts of each spatial domain (PanINs, GLTumor, PDTumor) in each sample to generate a (gene x samples spatial domain) matrix that will be used as an input for BayesPrism\n\n\nCode\n## Generating Pseudobulk profile\nepi_aggregate &lt;- AggregateExpression(\n  epi,\n  group.by = c(\"sample_id\", \"tissue\", \"new_annotation\"),\n  assays = 'Spatial',\n  return.seurat = T\n)\n\n## Setup for BayesPrism\nct_mtx &lt;- as.matrix(t(\n  AggregateExpression(\n    epi,\n    group.by = c(\"sample_id\", \"tissue\", \"new_annotation\"),\n    assays = 'Spatial'\n  )$Spatial\n))\nintersect_genes &lt;- intersect(colnames(ct_mtx), colnames(bp_scRef$sc.dat))\nmyPrism &lt;- new.prism(\n  reference = bp_scRef$sc.dat[, intersect_genes],\n  mixture = ct_mtx[, intersect_genes],\n  input.type = \"count.matrix\",\n  cell.type.labels = bp_scRef$metadata$main_annotation_scvi,\n  cell.state.labels = bp_scRef$metadata$main_annotation_scvi_tissue,\n  key = 'Tumor_Epithelial'\n)\n\n## Running BayesPrism\nbp_res &lt;- run.prism(myPrism, n.cores = parallel::detectCores() - 1)\n\n## Saving results to the aggregated seurat object\nepi_aggregate[['epiexp']] &lt;- CreateAssayObject(round(t(get.exp(\n  bp_res,\n  state.or.type = 'type',\n  cell.name = 'Tumor_Epithelial'\n))))\nepi_aggregate[['fractions']] &lt;- CreateAssayObject(round(t(get.fraction(\n  bp_res,\n  which.theta = 'final',\n  state.or.type = 'type'\n))))\nepi_aggregate$new_annotation &lt;- gsub(\"-\", \"_\", epi_aggregate$new_annotation)\nepi_aggregate$new_annotation &lt;- factor(\n  epi_aggregate$new_annotation,\n  levels = c(\"Donor_PanIN\", \"TumorAdj_PanIN\", \"GLTumor\", \"PDTumor\")\n)\nepi_aggregate@assays$epiexp$data &lt;- vst(as.matrix(GetAssayData(\n  epi_aggregate,\n  assay = 'epiexp',\n  layer = 'counts'\n)))\nqsave(epi_aggregate, \"outputs/Epithelial_Analysis/epi_aggregate.qs\")\n\n\n\n\n4.3 Differential Gene Expression Analysis for the epithelial-specific expression\nWe will use DESeq2 (Love, Huber, and Anders 2014) for differential gene expression analysis using the extracted epithelial-specific expression matrix.\n\n\nCode\n## DESeq2 Setup\nct_data &lt;- GetAssayData(epi_aggregate, assay = 'epiexp', layer = 'counts')\ncolData &lt;- epi_aggregate@meta.data\nrun_id &lt;- samples_info %&gt;%\n  dplyr::select(patient_id, run_id) %&gt;%\n  dplyr::rename(sample_id = patient_id) %&gt;%\n  mutate(sample_id = gsub(\"\\\\_\", \"-\", sample_id)) %&gt;%\n  data.frame()\ncolData &lt;- merge(colData, run_id, by = 'sample_id') %&gt;%\n  column_to_rownames(var = 'orig.ident')\n\n# PCA\nvst &lt;- vst(as.matrix(ct_data))\ngene_variance &lt;- rowVars(vst)\ntop_genes &lt;- names(sort(gene_variance, decreasing = TRUE)[1:2000])\nvst &lt;- vst[top_genes, ]\npca &lt;- pca(vst, colData)\nqsave(pca, \"outputs/Epithelial_Analysis/epi_pca.qs\")\ncols = c(\n  \"Donor_PanIN\" = 'green3',\n  \"TumorAdj_PanIN\" = 'darkblue',\n  \"GLTumor\" = \"darkred\",\n  \"PDTumor\" = \"purple\"\n)\nbiplot(\n  pca,\n  colby = 'new_annotation',\n  colkey = cols,\n  lab = NULL,\n  encircle = T,\n  legendTitleSize = 0,\n  legendPosition = 'right'\n)\n\n# DE using GoL as reference\ndds &lt;- DESeqDataSetFromMatrix(\n  countData = ct_data,\n  colData = colData,\n  design = ~ run_id + new_annotation\n)\ndds &lt;- DESeq(dds)\nqsave(dds, \"outputs/Epithelial_Analysis/epi_deseq_object.qs\")\n\n\n\n\n4.4 DEGs\n\n4.4.1 GLTumor vs Donor_PanIN DE\n\n\nCode\nTumorPanIN_v_GoL_PanIN &lt;- lfcShrink(\n  dds,\n  coef = 'new_annotation_Tumor_PanIN.GLTumor_vs_Donor_PanIN',\n  type = 'ashr'\n) %&gt;%\n  data.frame()\nwrite.csv(\n  TumorPanIN_v_GoL_PanIN,\n  \"outputs/Epithelial_Analysis/TumorPanIN_v_GoLPanIN_DEGs.csv\"\n)\n\nEnhancedVolcano(\n  TumorPanIN_v_GoL_PanIN,\n  rownames(TumorPanIN_v_GoL_PanIN),\n  'log2FoldChange',\n  'padj',\n  pCutoff = 0.05,\n  title = 'Tumor_PanIN/GLTumor vs Donor_PanIN',\n  subtitle = NULL,\n  drawConnectors = T,\n  labSize = 2,\n  titleLabSize = 15,\n  legendPosition = 'none',\n  caption = NULL,\n  # border = 'full',\n  axisLabSize = 10\n)\n\n\n\n\n4.4.2 PDTumor vs GLTumor DE\n\n\nCode\ntumor_epi_aggregate &lt;- epi_aggregate[,\n  epi_aggregate$new_annotation %in% c('Tumor_PanIN/GLTumor', 'PDTumor')\n]\nct_data &lt;- GetAssayData(tumor_epi_aggregate, assay = 'epiexp', layer = 'counts')\ncolData &lt;- tumor_epi_aggregate@meta.data\ncolData$new_annotation &lt;- factor(\n  as.character(colData$new_annotation),\n  levels = c(\"Tumor_PanIN/GLTumor\", \"PDTumor\")\n)\ndds &lt;- DESeqDataSetFromMatrix(\n  countData = ct_data,\n  colData = colData,\n  design = ~ sample_id + new_annotation\n)\ndds &lt;- DESeq(dds)\n\nPDTumor_v_Tumor_PanIN &lt;- lfcShrink(\n  dds,\n  coef = 'new_annotation_PDTumor_vs_Tumor_PanIN.GLTumor',\n  type = 'ashr'\n) %&gt;%\n  data.frame()\nwrite.csv(\n  PDTumor_v_Tumor_PanIN,\n  \"outputs/Epithelial_Analysis/PDTumor_v_Tumor_PanIN_DEGs.csv\"\n)\nPDTumor_v_Tumor_PanIN_w_stat &lt;- results(\n  dds,\n  name = 'new_annotation_PDTumor_vs_Tumor_PanIN.GLTumor'\n) %&gt;%\n  data.frame()\nwrite.csv(\n  PDTumor_v_Tumor_PanIN_w_stat,\n  \"outputs/Epithelial_Analysis/PDTumor_v_Tumor_PanIN_DEGs_w_stat.csv\"\n)\n\nPDTumor_v_Tumor_PanIN &lt;- read.csv(\n  \"outputs/Epithelial_Analysis/PDTumor_v_Tumor_PanIN_DEGs.csv\",\n  row.names = 1\n)\np3 &lt;- EnhancedVolcano(\n  PDTumor_v_Tumor_PanIN,\n  rownames(PDTumor_v_Tumor_PanIN),\n  'log2FoldChange',\n  'padj',\n  pCutoff = 0.05,\n  title = 'PDTumor vs Tumor_PanIN/GLTumor',\n  subtitle = NULL,\n  drawConnectors = T,\n  labSize = 2,\n  titleLabSize = 15,\n  legendPosition = 'none',\n  caption = NULL,\n  border = 'full',\n  axisLabSize = 10\n)\n\n\n\n\n\n4.3 GSEA\nWe will use MSigDB Hallmark gene sets (Liberzon et al. 2011)downloaded using msigdbr R package (Dolgalev et al. 2022). We will use clusterProfiler (Wu et al. 2021) that implements fgsea (Korotkevich et al. 2016) for calculation of enrichment scores.\n\n\nCode\nhallmark_sets &lt;- msigdbr(species = 'Homo sapiens', category = \"H\") %&gt;%\n  dplyr::select(gs_name, gene_symbol) %&gt;%\n  mutate(gs_name = gsub(\"^HALLMARK_\", \"\", gs_name))\n\nTumorPanIN_v_GoL_PanIN &lt;- TumorPanIN_v_GoL_PanIN %&gt;% filter(!is.na(padj))\nTumorPanIN_vs_GoLPanIN_rank &lt;- setNames(\n  TumorPanIN_v_GoL_PanIN$log2FoldChange,\n  rownames(TumorPanIN_v_GoL_PanIN)\n)\nTumorPanIN_vs_GoLPanIN_rank &lt;- sort(TumorPanIN_vs_GoLPanIN_rank, decreasing = T)\nTumorPanIN_vs_GoLPanIN_gsea &lt;- GSEA(\n  TumorPanIN_vs_GoLPanIN_rank,\n  TERM2GENE = hallmark_sets,\n  pvalueCutoff = 1\n)\nridgeplot(TumorPanIN_vs_GoLPanIN_gsea, showCategory = 20)\nqsave(\n  TumorPanIN_vs_GoLPanIN_gsea,\n  \"outputs/Epithelial_Analysis/TumorPanIN_v_GoLPanIN_GSEA.qs\"\n)\n\nPDTumor_v_Tumor_PanIN &lt;- PDTumor_v_Tumor_PanIN %&gt;% filter(!is.na(padj))\nPDTumor_vs_TumorPanIN_rank &lt;- setNames(\n  PDTumor_v_Tumor_PanIN$log2FoldChange,\n  rownames(PDTumor_v_Tumor_PanIN)\n)\nPDTumor_vs_TumorPanIN_rank &lt;- sort(PDTumor_vs_TumorPanIN_rank, decreasing = T)\nPDTumor_vs_TumorPanIN_gsea &lt;- GSEA(\n  PDTumor_vs_TumorPanIN_rank,\n  TERM2GENE = hallmark_sets,\n  pvalueCutoff = 1\n)\nridgeplot(PDTumor_vs_TumorPanIN_gsea, showCategory = 20)\nqsave(\n  PDTumor_vs_TumorPanIN_gsea,\n  \"outputs/Epithelial_Analysis/PDTumor_v_TumorPanIN_GSEA.qs\"\n)"
  },
  {
    "objectID": "st_epi_analysis.html#session-info",
    "href": "st_epi_analysis.html#session-info",
    "title": "Spatial Transcriptomics Epithelial Domains Analysis",
    "section": "5 Session Info",
    "text": "5 Session Info\n\n\nCode\nsessionInfo()\n\n\nR version 4.4.0 (2024-04-24)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS 26.0\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: America/Detroit\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nloaded via a namespace (and not attached):\n [1] htmlwidgets_1.6.4 compiler_4.4.0    fastmap_1.2.0     cli_3.6.2        \n [5] tools_4.4.0       htmltools_0.5.8.1 yaml_2.3.8        rmarkdown_2.27   \n [9] knitr_1.47        jsonlite_1.8.8    xfun_0.52         digest_0.6.35    \n[13] rlang_1.1.3       evaluate_0.23"
  },
  {
    "objectID": "st_deconvolution.html",
    "href": "st_deconvolution.html",
    "title": "Spatial Transcriptomics Cell Type Deconvolution",
    "section": "",
    "text": "Here we load essential packages and visium_samples_manifest.xlsx from the data directory, that includes information about visium samples. We will use Robust Cell Type Deconvolution (RCTD) (Cable et al. 2022) for the deconvolution.\n\n\nCode\nsuppressPackageStartupMessages({\n  library(spacexr)\n  library(Seurat)\n  library(Matrix)\n  library(doParallel)\n  library(ggplot2)\n  library(tidyverse)\n  library(slurmR)\n  library(qs)\n})\n\noutputDir &lt;- \"../outputs/Deconvolution/RCTD\"\ndir.create(outputDir, recursive = T, showWarnings = F)\nsamples_info &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")"
  },
  {
    "objectID": "st_deconvolution.html#setup-data-loading",
    "href": "st_deconvolution.html#setup-data-loading",
    "title": "Spatial Transcriptomics Cell Type Deconvolution",
    "section": "",
    "text": "Here we load essential packages and visium_samples_manifest.xlsx from the data directory, that includes information about visium samples. We will use Robust Cell Type Deconvolution (RCTD) (Cable et al. 2022) for the deconvolution.\n\n\nCode\nsuppressPackageStartupMessages({\n  library(spacexr)\n  library(Seurat)\n  library(Matrix)\n  library(doParallel)\n  library(ggplot2)\n  library(tidyverse)\n  library(slurmR)\n  library(qs)\n})\n\noutputDir &lt;- \"../outputs/Deconvolution/RCTD\"\ndir.create(outputDir, recursive = T, showWarnings = F)\nsamples_info &lt;- readxl::read_xlsx(\"../data/visium_samples_manifest.xlsx\")"
  },
  {
    "objectID": "st_deconvolution.html#reference-creation",
    "href": "st_deconvolution.html#reference-creation",
    "title": "Spatial Transcriptomics Cell Type Deconvolution",
    "section": "2 Reference Creation",
    "text": "2 Reference Creation\n\nHere we create a reference object for the RCTD analysis using the filtered and annotated single-cell RNA-seq data created using the scRNAseq workflow described here. The scRNAseq reference object can be downloaded from Zenodo here.\nWe use slurmR to parallelize the RCTD analysis across multiple samples on U-M HPC, alternatively user can use lapply to run the analysis locally. The results are saved as .rds objects that will be loaded and added to the integrated seurat spatial object in Clustering Analysis\n\n\n\nCode\nscRef &lt;- qread(\"../outputs/scRNAseq_Analysis/scRef.qs\")\n\nscRef &lt;- Reference(\n  counts = GetAssayData(scRef, assay = 'RNA', layer = 'count'),\n  n_max_cells = max(table(scRef$cellType)),\n  cell_types = factor(scRef$cellType)\n)\n\nslurm_jobs &lt;- Slurm_lapply(\n  njobs = length(samples),\n  job_name = \"RCTD\",\n  tmp_path = getwd(),\n  plan = \"none\",\n  sbatch_opt = list(\n    partition = 'standard',\n    account = '',\n    mem = '180G',\n    \"cpus-per-task\" = \"8\",\n    time = \"24:00:00\"\n  ),\n  export = c(\"scRef\"),\n  overwrite = TRUE,\n  X = as.list(samples),\n  FUN = function(x) {\n    sample &lt;- readRDS(paste0(\n      \"../outputs/Preprocessing/spatial_seurat_objects/\",\n      x,\n      \".rds\"\n    ))\n    sample_coord &lt;- GetTissueCoordinates(sample)[, c(\"x\", \"y\")]\n    spatial_obj &lt;- SpatialRNA(\n      coords = sample_coord,\n      counts = round(GetAssayData(sample, assay = 'Spatial', layer = 'counts'))\n    )\n    rctd_res &lt;- create.RCTD(\n      spatial_obj,\n      scRef,\n      max_cores = parallel::detectCores()\n    ) %&gt;%\n      run.RCTD(doublet_mode = 'multi')\n\n    saveRDS(rctd_res, paste0('../outputs/Deconvolution/RCTD/', x, \".rds\"))\n    return(NULL)\n  }\n)\nsbatch(slurm_jobs)"
  },
  {
    "objectID": "st_deconvolution.html#session-info",
    "href": "st_deconvolution.html#session-info",
    "title": "Spatial Transcriptomics Cell Type Deconvolution",
    "section": "3 Session Info",
    "text": "3 Session Info\n\n\nCode\nsessionInfo()\n\n\nR version 4.4.0 (2024-04-24)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS 26.0\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: America/Detroit\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nloaded via a namespace (and not attached):\n [1] htmlwidgets_1.6.4 compiler_4.4.0    fastmap_1.2.0     cli_3.6.2        \n [5] tools_4.4.0       htmltools_0.5.8.1 yaml_2.3.8        rmarkdown_2.27   \n [9] knitr_1.47        jsonlite_1.8.8    xfun_0.52         digest_0.6.35    \n[13] rlang_1.1.3       evaluate_0.23"
  }
]